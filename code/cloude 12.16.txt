// @ts-nocheck
import React, { useState, useEffect, useRef, useCallback } from 'react';
import mqtt from 'mqtt'; // å¼•å…¥ MQTT åº“

// ==========================================
// å…¨å±€å¸¸é‡å®šä¹‰ (é¢˜ç›®ä¸æ˜ å°„)
// ==========================================

// --- é˜¶æ®µåç§°ä¸­æ–‡æ˜ å°„ ---
const phaseMap = {
  consent: 'çŸ¥æƒ…åŒæ„',
  demographics: 'åŸºæœ¬ä¿¡æ¯',
  pretest: 'å‰æµ‹é˜¶æ®µ',
  familiarization: 'å¹³å°ç†Ÿæ‚‰',
  learning: 'æ­£å¼å­¦ä¹ ',
  posttest: 'åæµ‹é˜¶æ®µ',
  nasa: 'NASA-TLXé‡è¡¨',
  complete: 'å®éªŒå®Œæˆ'
};

// --- æœ¬åœ°å­˜å‚¨é”®å ---
const STORAGE_KEY = 'thesis_experiment_data_backup_v1';

// --- é’ˆå¯¹6ä¸ªä¸åŒå†…å®¹å—çš„å·®å¼‚åŒ–åé¦ˆæ•°æ®åº“ (å·²ä¿®æ­£ï¼šä¸é¢˜ç›®å¼ºå…³è”) ---
const CONTENT_FEEDBACK_MAP = {
  'gibson': {
    label: '1. æ¦‚å¿µèµ·æº (Gibson)',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (Gibson)", content: "Gibsonå®šä¹‰çš„å…³é”®ç‚¹ï¼šå¯ä¾›æ€§æ˜¯ç¯å¢ƒä¸è¡ŒåŠ¨è€…(Actor)ä¹‹é—´çš„å…³ç³»ã€‚å®ƒä¸ä»…å–å†³äºç‰©ä½“å±æ€§ï¼Œè¿˜å–å†³äºè¡ŒåŠ¨è€…çš„èƒ½åŠ›ï¼ˆå¦‚èº«é«˜ã€åŠ›é‡ï¼‰ã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (Gibson)", content: "çœ‹å³ä¾§çš„é—¨æŠŠæ‰‹ï¼šå®ƒçš„ç‰©ç†ç»“æ„ï¼ˆå½¢çŠ¶ã€é«˜åº¦ï¼‰æ­£å¥½åŒ¹é…äº†äººæ‰‹ï¼ˆè¡ŒåŠ¨è€…ï¼‰çš„æŠ“æ¡èƒ½åŠ›ã€‚è¿™å°±æ˜¯å®¢è§‚çš„å¯ä¾›æ€§ã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (Gibson)", content: "è®¾è®¡è‡ªæ£€ï¼šä½ çš„äº§å“æ˜¯å¦è€ƒè™‘äº†ç”¨æˆ·çš„èƒ½åŠ›ï¼Ÿæ¯”å¦‚ï¼ŒæŒ‰é’®æ˜¯å¦åœ¨ç”¨æˆ·æ‰‹æŒ‡çš„å¯åŠèŒƒå›´å†…ï¼Ÿè¿™æ˜¯Gibsonç†è®ºçš„å»¶ä¼¸ã€‚" }
    }
  },
  'norman': {
    label: '2. Normançš„ä¿®æ­£ (æ„ŸçŸ¥)',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (Norman)", content: "Normanä¿®æ­£äº†Gibsonçš„è§‚ç‚¹ï¼šåœ¨å±å¹•é‡Œï¼Œç‰©ç†å±æ€§ä¸é‡è¦ï¼Œé‡è¦çš„æ˜¯ç”¨æˆ·'æ„ŸçŸ¥' (Perceived) åˆ°å®ƒèƒ½åšä»€ä¹ˆã€‚è¿™æ˜¯ä¸¤è€…çš„æœ€å¤§åŒºåˆ«ã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (Norman)", content: "çœ‹å³ä¾§ç³Ÿç³•çš„æŒ‰é’®ï¼šå®ƒå¯èƒ½æœ‰ç‚¹å‡»åŠŸèƒ½ï¼Œä½†æ²¡æœ‰è§†è§‰çº¿ç´¢ã€‚ç”¨æˆ·æ„ŸçŸ¥ä¸åˆ°å®ƒæ˜¯æŒ‰é’®ã€‚è¿™å°±æ˜¯'æ„ŸçŸ¥å¯ä¾›æ€§'çš„ç¼ºå¤±ã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (Norman)", content: "æ£€æŸ¥ä½ çš„ç•Œé¢ï¼šä¸ä»…è¦åŠŸèƒ½å¯ç”¨ï¼Œè¿˜è¦è®©åŠŸèƒ½å¯è§ã€‚ä½ æ˜¯å¦åŠ äº†é˜´å½±æˆ–è¾¹æ¡†æ¥å¢å¼ºè¿™ç§æ„ŸçŸ¥ï¼Ÿ" }
    }
  },
  'signifier': {
    label: '3. å¯ä¾›æ€§ vs æ„ç¬¦',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (æ„ç¬¦)", content: "å¯ä¾›æ€§æ˜¯'èƒ½åšä»€ä¹ˆ'ï¼Œæ„ç¬¦æ˜¯'æç¤º'ã€‚æ„ç¬¦çš„æ ¸å¿ƒä½œç”¨æ˜¯æ˜ç¡®å‘Šè¯‰ç”¨æˆ·ï¼š'åœ¨å“ªé‡Œ'æ“ä½œä»¥åŠ'å¦‚ä½•'æ“ä½œã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (æ„ç¬¦)", content: "å¹³æ¿é—¨ä¸Šçš„'æ¨'å­—å°±æ˜¯æ„ç¬¦ã€‚å®ƒå¼¥è¡¥äº†å½¢çŠ¶çš„ä¸è¶³ï¼ŒæŒ‡ç¤ºäº†å¦‚ä½•æ“ä½œã€‚å¥½çš„è®¾è®¡åº”å‡å°‘å¯¹æ–‡å­—æ„ç¬¦çš„ä¾èµ–ã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (æ„ç¬¦)", content: "æ··æ·†è‡ªæ£€ï¼šç”¨æˆ·ä¸çŸ¥é“ç‚¹å“ªé‡Œï¼Ÿä½ éœ€è¦çš„æ˜¯æ„ç¬¦ï¼ˆå¦‚ç®­å¤´ã€ä¸‹åˆ’çº¿ï¼‰ã€‚ç”¨æˆ·ä¸çŸ¥é“èƒ½ä¸èƒ½ç‚¹ï¼Ÿä½ éœ€è¦çš„æ˜¯å¢å¼ºæ„ŸçŸ¥å¯ä¾›æ€§ã€‚" }
    }
  },
  'gaver': {
    label: '4. GaverçŸ©é˜µåˆ†ç±»',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (Gaver)", content: "GaverçŸ©é˜µæ ¸å¿ƒï¼šæ˜¾æ€§=å¯è§ä¸”å¯ç”¨ï¼ˆå®Œç¾ï¼‰ï¼›è™šå‡=å¯è§ä½†ä¸å¯ç”¨ï¼ˆéª—äººï¼‰ï¼›éšè—=ä¸å¯è§ä½†å¯ç”¨ï¼ˆéœ€æ¢ç´¢ï¼‰ï¼›æ­£ç¡®æ‹’ç»=ä¸å¯è§ä¸å¯ç”¨ã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (Gaver)", content: "å³ä¾§çš„'å¹³æ¿é—¨'æ˜¯å…¸å‹çš„éšè—å¯ä¾›æ€§ï¼ˆåŠŸèƒ½æœ‰ï¼Œä½†çœ‹ä¸å‡ºï¼‰ã€‚åœ¨UIä¸­ï¼Œä¸‹æ‹‰åˆ·æ–°æˆ–é¼ æ ‡æ‚¬åœæ˜¾ç¤ºä¹Ÿå¸¸å±äºæ­¤ç±»ã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (Gaver)", content: "è­¦æƒ•è™šå‡å¯ä¾›æ€§ï¼šæœ‰æ²¡æœ‰å›¾ç‰‡åšå¾—å¤ªåƒæŒ‰é’®ï¼ˆæœ‰é˜´å½±ç«‹ä½“æ„Ÿï¼‰ï¼Œè®©ç”¨æˆ·è¯¯ä»¥ä¸ºèƒ½ç‚¹ï¼Ÿè¿™ä¼šå¸¦æ¥æŒ«è´¥æ„Ÿã€‚" }
    }
  },
  'cues': {
    label: '5. è§†è§‰çº¿ç´¢åº”ç”¨',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (çº¿ç´¢)", content: "æ•°å­—ç•Œé¢ä¾èµ–è§†è§‰çº¿ç´¢æ¥æ¨¡æ‹Ÿç‰©ç†ä¸–ç•Œã€‚è¿™é€šå¸¸è¢«ç§°ä¸ºç‰©ç†éšå–» (Metaphor)ï¼Œå¸®åŠ©ç”¨æˆ·å»ºç«‹å¿ƒç†æ¨¡å‹ã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (çº¿ç´¢)", content: "å³ä¾§çš„å¥½æŒ‰é’®åˆ©ç”¨äº†éšå–»ï¼šé˜´å½±æš—ç¤ºçªèµ·ï¼Œåœ†è§’æš—ç¤ºå®ä½“ã€‚é‡åˆ°æ–°æ§ä»¶æ—¶ï¼Œæ‹Ÿç‰©æ˜¯æœ€å¥½çš„è€å¸ˆã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (æ— éšœç¢)", content: "æ— éšœç¢è®¾è®¡åŸåˆ™ï¼šç‚¹å‡»åŒºåŸŸè¦å¤Ÿå¤§ï¼ˆè´¹èŒ¨å®šå¾‹ï¼‰ï¼›ä¸è¦ä»…ä¾èµ–é¢œè‰²åŒºåˆ†çŠ¶æ€ï¼ˆè‰²ç›²å‹å¥½ï¼Œåº”åŠ å½¢çŠ¶/æ–‡å­—ï¼‰ï¼›æä¾›æ¸…æ™°çš„èšç„¦(Focus)æ ·å¼ã€‚" }
    }
  },
  'flat': {
    label: '6. æ‰å¹³åŒ–è®¾è®¡åæ€',
    levels: {
      1: { title: "ğŸ’¡ æ¦‚å¿µæ¾„æ¸… (æ‰å¹³åŒ–)", content: "è¿‡åº¦æ‰å¹³åŒ–ç§»é™¤äº†é˜´å½±å’Œçº¹ç†ï¼Œå¯¼è‡´'æ„ç¬¦'ä¸¢å¤±ã€‚ç”¨æˆ·éš¾ä»¥åŒºåˆ†æ–‡æœ¬å’ŒæŒ‰é’®ï¼Œå¼•å‘è®¤çŸ¥è´Ÿè·ã€‚" },
      2: { title: "ğŸ”— æ¡ˆä¾‹è¿æ¥ (æ‰å¹³åŒ–)", content: "å¯¹æ¯”å³ä¾§ï¼šå¦‚æœå»æ‰æŒ‰é’®çš„èƒŒæ™¯å’Œè¾¹æ¡†ï¼Œåªç•™æ–‡å­—ï¼Œè¿™å°±æ˜¯ç³Ÿç³•çš„æç«¯æ‰å¹³åŒ–ã€‚ç”¨æˆ·éœ€è¦çŒœæµ‹å“ªé‡Œå¯ç‚¹ã€‚" },
      3: { title: "ğŸš€ å®è·µå¼•å¯¼ (æ”¹è‰¯)", content: "æ‰å¹³åŒ–2.0ç­–ç•¥ï¼šé‡æ–°å¼•å…¥å¾®å¼±é˜´å½±ï¼Œä½¿ç”¨é«˜é¥±å’Œåº¦é¢œè‰²åŒºåˆ†äº¤äº’å…ƒç´ ï¼Œæˆ–åˆ©ç”¨å…¬è®¤çš„å›¾æ ‡éšå–»ï¼ˆå¦‚æ”¾å¤§é•œï¼‰ä½œä¸ºæ„ç¬¦ã€‚" }
    }
  },
  'case_handle': { 
    label: 'æ¡ˆä¾‹è§‚å¯Ÿï¼šé—¨æŠŠæ‰‹', 
    levels: {
        1: { title: "ğŸ’¡ è§‚å¯Ÿå¼•å¯¼", content: "è¯·æ³¨æ„å·¦å›¾çš„æŠŠæ‰‹ï¼Œå®ƒçš„ç‰©ç†å½¢çŠ¶ï¼ˆæ¨ªå‘å‡¸èµ·ï¼‰æ˜¯å¦ç›´æ¥æš—ç¤ºäº†â€œæ‹‰â€è¿™ä¸ªåŠ¨ä½œï¼Ÿè¿™æ˜¯å¼ºæœ‰åŠ›çš„ç‰©ç†æ„ç¬¦ã€‚" },
        2: { title: "ğŸ”— ç†è®ºè”ç³»", content: "è¿™å¯¹åº”äº†Gibsonçš„â€œç‰©ç†å¯ä¾›æ€§â€ã€‚å¯¹æ¯”å³å›¾çš„å¹³æ¿é—¨ï¼Œç¼ºä¹å½¢çŠ¶çº¿ç´¢ï¼Œå¯¼è‡´äº†â€œéšè—å¯ä¾›æ€§â€ï¼Œç”¨æˆ·å®¹æ˜“æ¨æ‹‰æé”™ã€‚" },
        3: { title: "ğŸš€ å®è·µæ€è€ƒ", content: "å¦‚æœæ˜¯ä½ è®¾è®¡ï¼Œä½ ä¼šå¦‚ä½•åœ¨è¯¥å¹³æ¿é—¨ä¸Šæ·»åŠ â€œæ„ç¬¦â€ï¼ˆå¦‚æ–‡å­—æˆ–æŠŠæ‰‹å›¾ç‰‡ï¼‰æ¥è§£å†³â€œå¦‚ä½•æ“ä½œâ€çš„å›°æƒ‘ï¼Ÿ" }
    } 
  },
  'case_button': { 
    label: 'æ¡ˆä¾‹è§‚å¯Ÿï¼šæŒ‰é’®', 
    levels: {
        1: { title: "ğŸ’¡ è§‚å¯Ÿå¼•å¯¼", content: "è¯·å¯¹æ¯”å·¦å³ä¸¤ä¸ªæŒ‰é’®ã€‚å·¦ä¾§çš„é˜´å½±å’Œåœ†è§’æ˜¯å¦è®©ä½ æ›´æƒ³å»â€œç‚¹å‡»â€å®ƒï¼Ÿè¿™æ˜¯ç‰©ç†éšå–»çš„åº”ç”¨ã€‚" },
        2: { title: "ğŸ”— ç†è®ºè”ç³»", content: "è¿™å°±æ˜¯Normanå¼ºè°ƒçš„â€œæ„ŸçŸ¥å¯ä¾›æ€§â€ã€‚å³ä¾§è®¾è®¡è™½ç„¶ä¹Ÿèƒ½ç‚¹ï¼Œä½†ç¼ºä¹è§†è§‰çº¿ç´¢ï¼Œå¯¼è‡´ç”¨æˆ·æ„ŸçŸ¥å¤±è´¥ã€‚" },
        3: { title: "ğŸš€ å®è·µæ€è€ƒ", content: "åœ¨æ‰å¹³åŒ–è®¾è®¡ä¸­ï¼Œé™¤äº†åŠ é˜´å½±ï¼Œè¿˜å¯ä»¥ç”¨é¢œè‰²ï¼ˆé«˜äº®ï¼‰ã€ä½ç½®æˆ–å›¾æ ‡æ¥å¢å¼ºå¯ç‚¹å‡»æ„Ÿã€‚" }
    } 
  },
};

// é»˜è®¤åé¦ˆ
const DEFAULT_FEEDBACK = {
  1: { title: "ğŸ’¡ Level 1: æ¦‚å¿µæç¤º", content: "è¯·ä»”ç»†é˜…è¯»å·¦ä¾§çš„ç†è®ºå®šä¹‰ï¼Œå¹¶å°è¯•ç†è§£å…¶æ ¸å¿ƒæ¦‚å¿µã€‚" },
  2: { title: "ğŸ”— Level 2: æ¡ˆä¾‹è¿æ¥", content: "è¯·è§‚å¯Ÿå³ä¾§çš„æ¡ˆä¾‹å›¾ç‰‡ï¼Œæ€è€ƒç†è®ºæ˜¯å¦‚ä½•åœ¨è¿™äº›å…·ä½“è®¾è®¡ä¸­ä½“ç°çš„ã€‚" },
  3: { title: "ğŸš€ Level 3: å®è·µå¼•å¯¼", content: "è¯•ç€æ€è€ƒå¦‚æœä½ æ˜¯è®¾è®¡å¸ˆï¼Œä½ ä¼šå¦‚ä½•æ”¹è¿›è¿™äº›è®¾è®¡ä»¥ç¬¦åˆç†è®ºè¦æ±‚ï¼Ÿ" }
};

// --- å‰æµ‹é¢˜ç›®æ•°æ® ---
const PRETEST_QUESTIONS = [
    { id: 'p1', question: "åœ¨å‚ä¸æœ¬å®éªŒä¹‹å‰ï¼Œæ‚¨æ˜¯å¦å¬è¯´è¿‡â€œå¯ä¾›æ€§ (Affordance)â€è¿™ä¸€æ¦‚å¿µï¼Ÿ", options: ["ä»æœªå¬è¯´è¿‡", "å¬è¯´è¿‡ï¼Œä½†ä¸äº†è§£å…·ä½“å«ä¹‰", "äº†è§£åŸºæœ¬å®šä¹‰", "éå¸¸ç†Ÿæ‚‰å¹¶åº”ç”¨è¿‡"] },
    { id: 'p2', question: "ï¼ˆå•é€‰ï¼‰æ ¹æ®æ‚¨çš„ç›´è§‰ï¼Œä»¥ä¸‹å“ªä¸ªæè¿°æœ€ç¬¦åˆâ€œè‰¯å¥½çš„äº¤äº’è®¾è®¡â€ï¼Ÿ", options: [ "ç•Œé¢åŒ…å«å°½å¯èƒ½å¤šçš„åŠŸèƒ½æŒ‰é’®", "ç”¨æˆ·ä¸éœ€è¦çœ‹è¯´æ˜ä¹¦å°±èƒ½çŸ¥é“å¦‚ä½•æ“ä½œ", "ç•Œé¢ä½¿ç”¨äº†æœ€æµè¡Œçš„é…è‰²æ–¹æ¡ˆ", "æ¯ä¸€ä¸ªæ“ä½œæ­¥éª¤éƒ½æœ‰æ–‡å­—å¼¹çª—æç¤º" ] },
    { id: 'p3', question: "è¯·ç®€è¦æè¿°æ‚¨è®¤ä¸ºä»€ä¹ˆæ ·çš„é—¨æŠŠæ‰‹è®¾è®¡æ˜¯â€œåç›´è§‰â€çš„ï¼Ÿï¼ˆé€‰å¡«ï¼‰", type: 'text' }
];

// --- åæµ‹ MCQs æ•°æ® ---
const POSTTEST_MCQ_QUESTIONS = [
    {
      id: 1,
      type: 'single',
      question: "1. æ ¹æ® James Gibson çš„åŸå§‹å®šä¹‰ï¼Œå¯ä¾›æ€§ï¼ˆAffordanceï¼‰ä¸ä»…å–å†³äºç‰©ä½“çš„ç‰©ç†å±æ€§ï¼Œè¿˜å–å†³äºä»€ä¹ˆï¼Ÿ",
      options: [
        "è¡ŒåŠ¨è€…ï¼ˆActorï¼‰çš„èƒ½åŠ›", 
        "è®¾è®¡å¸ˆçš„æ„å›¾",
        "ç”¨æˆ·çš„æ–‡åŒ–èƒŒæ™¯",
        "å½“å‰çš„ç…§æ˜æ¡ä»¶"
      ],
      correct: [0] 
    },
    {
      id: 2,
      type: 'single',
      question: "2. Donald Norman æå‡ºçš„â€œæ„ŸçŸ¥å¯ä¾›æ€§â€ä¸ Gibson çš„åŸæ„æœ€å¤§çš„åŒºåˆ«åœ¨äºï¼š",
      options: [
        "Norman è®¤ä¸ºå¯ä¾›æ€§åªå­˜åœ¨äºæ•°å­—ç•Œé¢ä¸­",
        "Norman å¼ºè°ƒç”¨æˆ·å¿…é¡»èƒ½å¤Ÿâ€œæ„ŸçŸ¥â€åˆ°æ“ä½œçš„å¯èƒ½æ€§", 
        "Norman è®¤ä¸ºå¯ä¾›æ€§æ˜¯å®Œå…¨ä¸»è§‚çš„",
        "Norman å¦è®¤äº†ç‰©ç†å±æ€§çš„é‡è¦æ€§"
      ],
      correct: [1]
    },
    {
      id: 3,
      type: 'multi',
      question: "3. ã€å¤šé€‰ã€‘æ ¹æ® Gaver çš„å¯ä¾›æ€§çŸ©é˜µï¼Œä»¥ä¸‹å“ªäº›æè¿°æ˜¯æ­£ç¡®çš„ï¼Ÿ",
      options: [
        "æ˜¾æ€§å¯ä¾›æ€§ï¼šåŠŸèƒ½å­˜åœ¨ä¸”ä¿¡æ¯å¯è§ï¼ˆç†æƒ³çŠ¶æ€ï¼‰", 
        "è™šå‡å¯ä¾›æ€§ï¼šåŠŸèƒ½ä¸å­˜åœ¨ä½†ä¿¡æ¯å¯è§ï¼ˆè¯¯å¯¼ç”¨æˆ·ï¼‰", 
        "éšè—å¯ä¾›æ€§ï¼šåŠŸèƒ½å­˜åœ¨ä½†ä¿¡æ¯ä¸å¯è§ï¼ˆéœ€æ¢ç´¢ï¼‰", 
        "æ­£ç¡®æ‹’ç»ï¼šåŠŸèƒ½å­˜åœ¨ä¸”ä¿¡æ¯å¯è§ï¼ˆåŒæ˜¾æ€§ï¼‰"
      ],
      correct: [0, 1, 2] 
    },
    {
      id: 4,
      type: 'single',
      question: "4. åœ¨ç•Œé¢è®¾è®¡ä¸­ï¼Œå¦‚æœä¸€ä¸ªå›¾æ ‡çœ‹èµ·æ¥åƒæŒ‰é’®ï¼ˆæœ‰é˜´å½±ã€ç«‹ä½“æ„Ÿï¼‰ï¼Œä½†ç‚¹å‡»åæ²¡æœ‰ä»»ä½•ååº”ï¼Œè¿™å±äºï¼š",
      options: [
        "éšè—å¯ä¾›æ€§",
        "è™šå‡å¯ä¾›æ€§", 
        "æ˜¾æ€§å¯ä¾›æ€§",
        "æ­£ç¡®æ‹’ç»"
      ],
      correct: [1]
    },
    {
      id: 5,
      type: 'multi',
      question: "5. ã€å¤šé€‰ã€‘ä¸ºäº†åœ¨æ‰å¹³åŒ–è®¾è®¡ï¼ˆFlat Designï¼‰ä¸­å¢å¼ºâ€œæ„ç¬¦ï¼ˆSignifiersï¼‰â€ï¼Œè®¾è®¡å¸ˆé€šå¸¸é‡‡ç”¨å“ªäº›æ‰‹æ®µï¼Ÿ",
      options: [
        "æ·»åŠ å¾®å¼±çš„é˜´å½±æˆ–è¾¹æ¡†", 
        "ä½¿ç”¨é«˜é¥±å’Œåº¦çš„é¢œè‰²åŒºåˆ†äº¤äº’å…ƒç´ ", 
        "åˆ©ç”¨å…¬è®¤çš„å›¾æ ‡éšå–»ï¼ˆå¦‚æ”¾å¤§é•œä»£è¡¨æœç´¢ï¼‰", 
        "å»é™¤æ‰€æœ‰è§†è§‰è£…é¥°ï¼Œä»…ä¿ç•™æ–‡å­—"
      ],
      correct: [0, 1, 2]
    },
    {
      id: 6,
      type: 'single',
      question: "6. â€œæ„ç¬¦ï¼ˆSignifiersï¼‰â€çš„ä¸»è¦ä½œç”¨æ˜¯ï¼š",
      options: [
        "åˆ›é€ åŠŸèƒ½æœ¬èº«",
        "ç¾åŒ–ç•Œé¢è§†è§‰",
        "å‘ç”¨æˆ·ä¼ è¾¾â€œä½•å¤„æ“ä½œâ€ä»¥åŠâ€œå¦‚ä½•æ“ä½œâ€çš„ä¿¡å·", 
        "æ›¿ä»£å¯ä¾›æ€§"
      ],
      correct: [2]
    },
    {
      id: 7,
      type: 'multi',
      question: "7. ã€å¤šé€‰ã€‘ä»¥ä¸‹å“ªäº›è®¾è®¡æ¡ˆä¾‹å±äºâ€œéšè—å¯ä¾›æ€§â€çš„åº”ç”¨ï¼Ÿï¼ˆè™½ç„¶éš¾å‘ç°ï¼Œä½†æœ‰æ—¶ä¸ºäº†ç®€æ´è€Œä½¿ç”¨ï¼‰",
      options: [
        "iOS çš„ä¸‹æ‹‰æœç´¢åŠŸèƒ½ï¼ˆå±å¹•ä¸Šæ— ç®­å¤´æç¤ºï¼‰", 
        "å¸¦æœ‰ä¸‹åˆ’çº¿çš„è“è‰²è¶…é“¾æ¥æ–‡æœ¬",
        "ä¸»è¦åŠŸèƒ½æŒ‰é’®çš„æ‚¬åœï¼ˆHoverï¼‰æ˜¾ç¤ºæç¤º", 
        "é¼ æ ‡å³é”®èœå•", 
      ],
      correct: [0, 3] 
    },
    {
      id: 8,
      type: 'single',
      question: "8. é—¨æŠŠæ‰‹è®¾è®¡ä¸­ï¼Œâ€œå¹³æ¿æ¨æ¿â€ä¹‹æ‰€ä»¥å®¹æ˜“è®©äººå›°æƒ‘ï¼Œæ˜¯å› ä¸ºå®ƒç¼ºä¹æ”¯æŒ____åŠ¨ä½œçš„æ„ç¬¦ã€‚",
      options: [
        "æ¨",
        "æ‹‰", 
        "æ»‘åŠ¨",
        "æ—‹è½¬"
      ],
      correct: [1] 
    },
    {
      id: 9,
      type: 'multi',
      question: "9. ã€å¤šé€‰ã€‘åœ¨è¿›è¡Œæ— éšœç¢è®¾è®¡æ—¶ï¼Œä¸ºäº†ç¡®ä¿å¯ä¾›æ€§å¯¹æ‰€æœ‰ç”¨æˆ·å¯è§ï¼Œåº”éµå¾ªå“ªäº›åŸåˆ™ï¼Ÿ",
      options: [
        "ä¸å®Œå…¨ä¾èµ–é¢œè‰²æ¥ä¼ è¾¾çŠ¶æ€ï¼ˆå¦‚åŒæ—¶ä½¿ç”¨å½¢çŠ¶æˆ–æ–‡å­—ï¼‰", 
        "ç¡®ä¿ç‚¹å‡»åŒºåŸŸè¶³å¤Ÿå¤§ï¼ˆç¬¦åˆè´¹èŒ¨å®šå¾‹ï¼‰", 
        "æä¾›æ˜ç¡®çš„èšç„¦ï¼ˆFocusï¼‰çŠ¶æ€æ ·å¼", 
        "å°†æ‰€æœ‰åŠŸèƒ½éšè—åœ¨æ±‰å ¡èœå•ä¸­ä»¥ç®€åŒ–ç•Œé¢"
      ],
      correct: [0, 1, 2]
    },
    {
      id: 10,
      type: 'single',
      question: "10. é¢å¯¹ä¸€ä¸ªå…¨æ–°çš„ã€ç”¨æˆ·ä»æœªè§è¿‡çš„äº¤äº’æ§ä»¶ï¼Œæœ€æœ‰æ•ˆçš„è®¾è®¡ç­–ç•¥æ˜¯ï¼š",
      options: [
        "ä¾é ç”¨æˆ·çš„ç›´è§‰å»çŒœæµ‹",
        "ä½¿ç”¨ç‰©ç†ä¸–ç•Œçš„éšå–»ï¼ˆSkeuomorphismï¼‰å¸®åŠ©å»ºç«‹å¿ƒç†æ¨¡å‹", 
        "å½»åº•éšè—å®ƒç›´åˆ°ç”¨æˆ·è§¦å‘",
        "ä½¿ç”¨çº¯æ–‡æœ¬æè¿°å…¶ä»£ç é€»è¾‘"
      ],
      correct: [1]
    }
];

// --- NASA-TLX ç»´åº¦ ---
const NASA_DIMENSIONS = [
    { key: 'mental', label: 'ğŸ§  å¿ƒç†éœ€æ±‚ (Mental Demand)', description: 'éœ€è¦è¿›è¡Œå¤šå°‘æ€è€ƒã€è®°å¿†ã€è®¡ç®—æˆ–åˆ¤æ–­ï¼Ÿä»»åŠ¡æ˜¯ç®€å•ç›´è§‚çš„ï¼Œè¿˜æ˜¯å¤æ‚ç¹ççš„ï¼Ÿ' },
    { key: 'physical', label: 'ğŸ’ª èº«ä½“éœ€æ±‚ (Physical Demand)', description: 'éœ€è¦è¿›è¡Œå¤šå°‘èº«ä½“æ“ä½œï¼Ÿï¼ˆä¾‹å¦‚ï¼šé¼ æ ‡ç‚¹å‡»ã€æ‹–æ‹½ã€é”®ç›˜è¾“å…¥çš„å¼ºåº¦å’Œé¢‘ç‡ï¼‰' },
    { key: 'temporal', label: 'â³ æ—¶é—´éœ€æ±‚ (Temporal Demand)', description: 'æ‚¨æ˜¯å¦æ„Ÿåˆ°æ—¶é—´ç´§è¿«ï¼Ÿä»»åŠ¡èŠ‚å¥æ˜¯ç¼“æ…¢æ‚ é—²çš„ï¼Œè¿˜æ˜¯æ€¥ä¿ƒå¿™ä¹±çš„ï¼Ÿ' },
    { key: 'performance', label: 'ğŸ† è‡ªæˆ‘ç»©æ•ˆè¯„ä»· (Performance)', description: 'æ‚¨å¯¹è‡ªå·±ä»»åŠ¡å®Œæˆè´¨é‡çš„æ»¡æ„åº¦å¦‚ä½•ï¼Ÿï¼ˆ0=éå¸¸ä¸æ»¡æ„ï¼Œ100=éå¸¸æ»¡æ„ï¼‰' },
    { key: 'effort', label: 'ğŸ‹ï¸ åŠªåŠ›ç¨‹åº¦ (Effort)', description: 'ä¸ºäº†å®Œæˆä»»åŠ¡ï¼Œæ‚¨åœ¨ç²¾ç¥å’Œèº«ä½“ä¸Šä»˜å‡ºäº†å¤šå¤§ç¨‹åº¦çš„åŠªåŠ›ï¼Ÿ' },
    { key: 'frustration', label: 'ğŸ˜« å—æŒ«ç¨‹åº¦ (Frustration)', description: 'åœ¨ä»»åŠ¡è¿‡ç¨‹ä¸­ï¼Œæ‚¨æ„Ÿåˆ°ä¸å®‰å…¨ã€æ°”é¦ã€çƒ¦èºæˆ–ç„¦è™‘çš„ç¨‹åº¦å¦‚ä½•ï¼Ÿ' }
];

// --- è¾…åŠ©å‡½æ•°ï¼šæ—¶é—´æ ¼å¼åŒ– (HH:mm:ss) ---
const formatTime = (timestamp) => {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const hours = date.getHours().toString().padStart(2, '0');
  const minutes = date.getMinutes().toString().padStart(2, '0');
  const seconds = date.getSeconds().toString().padStart(2, '0');
  return `${hours}:${minutes}:${seconds}`;
};

// --- å®æ—¶ç½‘ç»œæ•°æ®åŒæ­¥ Hook (åŸºäº MQTT) ---
const MQTT_BROKER_URL = 'wss://broker.emqx.io:8084/mqtt';
const BASE_TOPIC = 'design-thesis-experiment-v1'; 

// === ã€ä¿®æ”¹éœ€æ±‚10ã€‘Pupil Core çœ¼åŠ¨ä»ª WebSocket é…ç½® ===
// Pupil Core ä½¿ç”¨ ZeroMQ è¿›è¡Œé€šä¿¡ï¼Œæµè§ˆå™¨ç¯å¢ƒéœ€è¦ WebSocket æ¡¥æ¥å™¨
// éœ€è¦åœ¨æœ¬åœ°è¿è¡Œ WebSocket æ¡¥æ¥æœåŠ¡å™¨ï¼ˆå°† ZMQ æ•°æ®è½¬å‘åˆ° WebSocketï¼‰
// æ¨èæ–¹æ¡ˆï¼šä½¿ç”¨ Node.js ä¸­é—´å±‚æˆ– pupil-labs å®˜æ–¹çš„ WebSocket æ’ä»¶
const PUPIL_WS_URL = 'ws://localhost:8080'; // Pupil Capture WebSocket æ¡¥æ¥å™¨åœ°å€ 

const useRealtimeSync = (role, participantId, onDataReceived, onCommandReceived) => {
  const [client, setClient] = useState(null);
  const [isConnected, setIsConnected] = useState(false);

  useEffect(() => {
    if (!role) return;
    if (role === 'learner' && !participantId) return;

    console.log(`[MQTT] Connecting as ${role}...`);
    
    const mqttClient = mqtt.connect(MQTT_BROKER_URL, {
      clean: true,
      connectTimeout: 4000,
      clientId: `client_${Math.random().toString(16).slice(2, 8)}`,
    });

    mqttClient.on('connect', () => {
      console.log('[MQTT] Connected!');
      setIsConnected(true);

      if (role === 'experimenter') {
        mqttClient.subscribe(`${BASE_TOPIC}/+/client`, (err) => {
          if (!err) console.log('[MQTT] Experimenter subscribed to all clients');
        });
      } else if (role === 'learner' && participantId) {
        mqttClient.subscribe(`${BASE_TOPIC}/${participantId}/server`, (err) => {
          if (!err) console.log(`[MQTT] Learner ${participantId} subscribed to commands`);
        });
      }
    });

    mqttClient.on('message', (topic, message) => {
      try {
        const payload = JSON.parse(message.toString());
        const topicParts = topic.split('/');
        const senderId = topicParts[1];

        if (role === 'experimenter') {
          onDataReceived({ ...payload, participantId: senderId });
        }
        
        if (role === 'learner') {
            onCommandReceived(payload);
        }
      } catch (err) {
        console.error('[MQTT] Parse error:', err);
      }
    });

    setClient(mqttClient);

    return () => {
      if (mqttClient) {
        mqttClient.end();
      }
    };
  }, [role, participantId]);

  const sendData = (targetId, type, payload) => {
    if (!client || !isConnected) return;

    let topic = '';
    
    if (role === 'learner') {
      topic = `${BASE_TOPIC}/${participantId}/client`;
      const message = { type, payload };
      client.publish(topic, JSON.stringify(message));
    } 
    else if (role === 'experimenter') {
      if (!targetId) {
          alert("å‘é€å¤±è´¥ï¼šæœªæŒ‡å®šæ¥æ”¶è€…ID");
          return;
      }
      topic = `${BASE_TOPIC}/${targetId}/server`;
      client.publish(topic, JSON.stringify({ type, payload }));
    }
  };

  return { sendData, isConnected };
};

// å†…è”æ ·å¼å¯¹è±¡ (ä¿æŒåŸæ ·)
const styles = {
  app: {
    minHeight: '100vh',
    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
    lineHeight: 1.6,
    color: '#1f2937',
    backgroundColor: '#f3f4f6'
  },
  roleSelection: {
    minHeight: '100vh',
    background: 'linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '2rem'
  },
  roleContainer: {
    maxWidth: '1000px',
    width: '100%'
  },
  roleHeader: {
    textAlign: 'center',
    marginBottom: '4rem'
  },
  taskBar: {
    background: '#ffffff',       
    borderBottom: '1px solid #f3f4f6',
    padding: '0.75rem 2rem',
    color: '#3b82f6',            
    fontSize: '0.95rem',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',    
    gap: '0.6rem',
    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.02)' 
  },  
  roleTitle: {
    fontSize: '2.5rem',
    fontWeight: '800',
    color: '#1e3a8a',
    marginBottom: '1rem',
    letterSpacing: '-0.025em'
  },
  roleSubtitle: {
    fontSize: '1.1rem',
    color: '#64748b'
  },
  roleGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))',
    gap: '2.5rem',
    marginBottom: '2rem'
  },
  roleButton: {
    background: 'white',
    padding: '3rem 2rem',
    borderRadius: '16px',
    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025)',
    border: '1px solid #f1f5f9',
    cursor: 'pointer',
    transition: 'all 0.3s ease',
    textAlign: 'center'
  },
  roleButtonHover: {
    transform: 'translateY(-5px)',
    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
    borderColor: '#3b82f6'
  },
  roleButtonTitle: {
    fontSize: '1.5rem',
    fontWeight: 'bold',
    color: '#334155',
    marginBottom: '0.5rem',
    marginTop: '1rem'
  },
  roleButtonDesc: {
    color: '#94a3b8',
    lineHeight: 1.6
  },
  loginContainer: {
    minHeight: '100vh',
    background: '#f3f4f6',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '2rem'
  },
  loginBox: {
    background: 'white',
    padding: '3rem',
    borderRadius: '16px',
    boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)',
    maxWidth: '440px',
    width: '100%'
  },
  loginTitle: {
    fontSize: '1.75rem',
    fontWeight: '800',
    color: '#1e293b',
    marginBottom: '2rem',
    textAlign: 'center'
  },
  formGroup: {
    marginBottom: '1.5rem'
  },
  label: {
    display: 'block',
    fontSize: '0.9rem',
    fontWeight: '600',
    color: '#475569',
    marginBottom: '0.5rem'
  },
  input: {
    width: '100%',
    padding: '0.85rem',
    border: '1px solid #e2e8f0',
    borderRadius: '8px',
    fontSize: '1rem',
    transition: 'all 0.2s ease',
    background: '#f8fafc'
  },
  inputFocus: {
    outline: 'none',
    borderColor: '#3b82f6',
    boxShadow: '0 0 0 3px rgba(59, 130, 246, 0.15)',
    background: 'white'
  },
  button: {
    background: '#3b82f6',
    color: 'white',
    border: 'none',
    padding: '0.85rem 1.5rem',
    borderRadius: '8px',
    fontSize: '1rem',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'all 0.2s ease',
    width: '100%',
    boxShadow: '0 4px 6px -1px rgba(59, 130, 246, 0.3)'
  },
  buttonHover: {
    background: '#2563eb',
    transform: 'translateY(-1px)'
  },
  backButton: {
    background: 'transparent', 
    border: 'none',
    color: '#94a3b8',          
    padding: '0.5rem 0',       
    cursor: 'pointer',
    display: 'inline-flex',
    alignItems: 'center',
    gap: '0.4rem',
    fontSize: '0.95rem',          
    fontWeight: '500',
    marginBottom: '1.5rem',
    transition: 'all 0.2s ease' 
  },
  consentContainer: {
    minHeight: '100vh',
    background: '#f3f4f6',
    padding: '2rem'
  },
  consentBox: {
    background: 'white',
    padding: '3rem',
    borderRadius: '16px',
    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
    maxWidth: '800px',
    margin: '0 auto'
  },
  consentTitle: {
    fontSize: '2rem',
    fontWeight: '800',
    color: '#1e293b',
    marginBottom: '2rem',
    display: 'flex',
    alignItems: 'center',
    gap: '0.5rem'
  },
  consentContent: {
    lineHeight: 1.8,
    color: '#475569',
    marginBottom: '2rem',
    fontSize: '1.05rem'
  },
  learningContainer: {
    minHeight: '100vh',
    background: '#f3f4f6'
  },
  header: {
    background: 'white',
    padding: '0.8rem 2rem',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
    borderBottom: '1px solid #e5e7eb',
    zIndex: 50,
    position: 'relative'
  },
  headerContent: {
    maxWidth: '1400px',
    margin: '0 auto',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center'
  },
  headerInfo: {
    display: 'flex',
    alignItems: 'center',
    gap: '2rem'
  },
  infoItem: {
    display: 'flex',
    alignItems: 'center',
    gap: '0.6rem',
    fontSize: '0.95rem',
    color: '#64748b',
    fontWeight: '500',
    background: '#f8fafc',
    padding: '0.4rem 0.8rem',
    borderRadius: '20px'
  },
  infoIcon: {
    fontSize: '1.1rem'
  },
  splitLayout: {
    display: 'flex',
    height: 'calc(100vh - 80px)'
  },
  panel: {
    flex: 1,
    overflowY: 'auto',
    padding: '2.5rem'
  },
  theoryPanel: {
    borderRight: '1px solid #e2e8f0',
    background: 'white'
  },
  casePanel: {
    background: '#f8fafc'
  },
  panelContent: {
    background: 'white',
    padding: '2.5rem',
    borderRadius: '12px',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)'
  },
  panelTitle: {
    fontSize: '1.6rem',
    fontWeight: '800',
    color: '#1e293b',
    marginBottom: '1.5rem',
    paddingBottom: '1rem',
    borderBottom: '2px solid #e2e8f0'
  },
  modalOverlay: {
    position: 'fixed',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    background: 'rgba(15, 23, 42, 0.4)',
    backdropFilter: 'blur(4px)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    padding: '1rem',
    zIndex: 1000
  },
  modal: {
    background: 'white',
    borderRadius: '20px',
    boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
    maxWidth: '500px',
    width: '100%',
    overflow: 'hidden'
  },
  modalHeader: {
    background: '#f8fafc',
    color: '#1e293b',
    padding: '1.25rem 1.5rem',
    borderBottom: '1px solid #e2e8f0',
    display: 'flex',
    justifyContent: 'space-between',
    alignItems: 'center'
  },
  modalTitle: {
    fontSize: '1.25rem',
    fontWeight: 'bold',
    display: 'flex',
    alignItems: 'center',
    gap: '0.5rem'
  },
  closeButton: {
    background: 'none',
    border: 'none',
    color: '#94a3b8',
    fontSize: '1.5rem',
    cursor: 'pointer',
    padding: 0,
    width: '30px',
    height: '30px',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    transition: 'color 0.2s'
  },
  modalContent: {
    padding: '2rem'
  },
  modalFooter: {
    padding: '1.25rem 1.5rem',
    borderTop: '1px solid #e2e8f0',
    textAlign: 'right',
    background: '#f8fafc'
  },
  experimenterContainer: {
    minHeight: '100vh',
    background: '#f1f5f9',
    padding: '1.5rem'
  },
  dashboard: {
    maxWidth: '1400px',
    margin: '0 auto'
  },
  dashboardHeader: {
    background: 'white',
    padding: '1.5rem',
    borderRadius: '12px',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
    marginBottom: '1.5rem'
  },
  dashboardTitle: {
    fontSize: '2rem',
    fontWeight: 'bold',
    color: '#1e293b',
    marginBottom: '0.5rem'
  },
  dashboardGrid: {
    display: 'grid',
    gridTemplateColumns: '300px 1fr 350px', 
    gap: '1.5rem',
    height: 'calc(100vh - 180px)', 
    minHeight: '600px'
  },
  dashboardPanel: {
    background: 'white',
    padding: '1.5rem',
    borderRadius: '12px',
    boxShadow: '0 1px 3px rgba(0, 0, 0, 0.05)',
    display: 'flex',
    flexDirection: 'column',
    height: '100%',
    overflow: 'hidden',
    position: 'relative'
  },
  disabledPanel: {
    pointerEvents: 'none',
    filter: 'grayscale(0.9) opacity(0.6)'
  },
  disabledOverlay: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 20,
    background: 'rgba(255,255,255,0.3)'
  },
  disabledText: {
    background: '#fef2f2',
    color: '#ef4444',
    border: '1px solid #fca5a5',
    padding: '0.5rem 1rem',
    borderRadius: '8px',
    fontWeight: 'bold',
    boxShadow: '0 4px 6px rgba(0,0,0,0.1)'
  },
  metricGrid: {
    display: 'grid',
    gridTemplateColumns: 'repeat(2, 1fr)',
    gap: '0.8rem',
    marginBottom: '1.5rem'
  },
  metricCard: {
    background: '#f8fafc',
    padding: '1rem',
    borderRadius: '10px',
    textAlign: 'center',
    border: '1px solid #e2e8f0'
  },
  metricValue: {
    fontSize: '1.5rem',
    fontWeight: 'bold',
    color: '#3b82f6',
    marginBottom: '0.25rem'
  },
  metricLabel: {
    fontSize: '0.8rem',
    color: '#64748b'
  },
  triggerButtons: {
    display: 'flex',
    flexDirection: 'column',
    gap: '0.75rem',
    marginBottom: '1.5rem'
  },
  triggerButton: {
    padding: '1rem',
    borderRadius: '10px',
    border: 'none',
    color: 'white',
    fontSize: '0.95rem',
    fontWeight: '600',
    cursor: 'pointer',
    transition: 'all 0.2s ease',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
  },
  triggerButton1: { background: 'linear-gradient(to right, #3b82f6, #2563eb)' },
  triggerButton2: { background: 'linear-gradient(to right, #8b5cf6, #7c3aed)' },
  triggerButton3: { background: 'linear-gradient(to right, #10b981, #059669)' },
  triggerButtonDisabled: {
    background: '#cbd5e1',
    cursor: 'not-allowed',
    transform: 'none',
    boxShadow: 'none',
    color: '#94a3b8'
  },
  logContainer: {
    flex: 1,
    overflowY: 'auto',
    border: '1px solid #e2e8f0',
    borderRadius: '8px',
    background: '#f8fafc',
    padding: '0.5rem'
  },
  logEntry: {
    padding: '0.6rem',
    borderBottom: '1px solid #e2e8f0',
    fontSize: '0.8rem',
    fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace',
    display: 'grid',
    gridTemplateColumns: '70px 145px 1fr', 
    gap: '0.5rem',
    alignItems: 'center',
    background: 'white',
    marginBottom: '4px',
    borderRadius: '4px'
  },
  logTime: {
    color: '#94a3b8',
  },
  logType: {
    fontWeight: '600',
    color: '#334155',
    background: '#e2e8f0',
    padding: '2px 6px',
    borderRadius: '4px',
    textAlign: 'center',
    fontSize: '0.7rem',
    whiteSpace: 'nowrap',
    overflow: 'hidden',
    textOverflow: 'ellipsis'
  },
  logData: {
    color: '#475569',
    whiteSpace: 'pre-wrap', 
    wordBreak: 'break-all'
  }
};

const Icon = ({ name, size = 20, color = 'currentColor', style = {} }) => {
  const icons = {
    clock: 'â±ï¸',
    eye: 'ğŸ‘ï¸',
    activity: 'ğŸ“Š',
    zap: 'ğŸ’¡',
    send: 'ğŸ“¤',
    close: 'âœ•',
    chart: 'ğŸ“ˆ',
    monitor: 'ğŸ’»',
    check: 'âœ…',
    user: 'ğŸ“',
    book: 'ğŸ“–',
    target: 'ğŸ¯',
    lock: 'ğŸ”',
    doc: 'ğŸ“',
    brain: 'ğŸ§ ',
    party: 'ğŸ‰',
    alert: 'âš ï¸',
    lab: 'ğŸ§ª',
    download: 'ğŸ“¥',
    upload: 'ğŸ“¤',
    wifi: 'ğŸ“¡',
    trash: 'ğŸ—‘ï¸',
    mouse: 'ğŸ–±ï¸',
    pupil: 'ğŸ§¿'
  };
  return (
    <span style={{ fontSize: size, lineHeight: 1, display: 'inline-block', ...style }}>
      {icons[name] || 'ğŸ“„'}
    </span>
  );
};

const CognitiveLoadPlatform = () => {
  useEffect(() => {
    document.title = "Cognitive-Load-Platform";
  }, []);

  const [role, setRole] = useState(null);
  const [selectedParticipantId, setSelectedParticipantId] = useState('');
  const [allParticipants, setAllParticipants] = useState([]);
  const [experimentPhase, setExperimentPhase] = useState('consent');
  const [participantId, setParticipantId] = useState('');
  const [demographics, setDemographics] = useState({ age: '', gender: '', major: '', experience: '' });
  const [preTestAnswers, setPreTestAnswers] = useState({});
  const [currentSection, setCurrentSection] = useState('theory');
  
  const [scrollCount, setScrollCount] = useState(0); 
  const [aoiTransitions, setAoiTransitions] = useState(0); 
  const [sessionTime, setSessionTime] = useState(0);
  const [currentGazeTarget, setCurrentGazeTarget] = useState('Waiting...');
  
  const [showFeedback, setShowFeedback] = useState(false);
  const [feedbackContent, setFeedbackContent] = useState('');
  const [feedbackLevel, setFeedbackLevel] = useState(0);
  const [cooldownRemaining, setCooldownRemaining] = useState(0);
  const [interventionHistory, setInterventionHistory] = useState([]); 
  const [behaviorLog, setBehaviorLog] = useState([]); 
  
  // ã€ä¿®å¤1ã€‘ä½¿ç”¨ ref æ¥è¿½è¸ªæ—¥å¿—ï¼Œé¿å… useEffect ä¾èµ–å˜åŒ–å¯¼è‡´å®šæ—¶å™¨é‡ç½®
  const behaviorLogRef = useRef([]);

  // åŒæ­¥æ—¥å¿—åˆ° ref
  useEffect(() => {
    behaviorLogRef.current = behaviorLog;
  }, [behaviorLog]);
  
  const [currentPerformance, setCurrentPerformance] = useState(null);

  const [currentContentBlock, setCurrentContentBlock] = useState('gibson');
  const [levelsByBlock, setLevelsByBlock] = useState({}); 

  // === æ–°å¢ï¼šPupil Core æ¨¡å¼çŠ¶æ€ ===
  const [inputMode, setInputMode] = useState('mouse'); // 'mouse' | 'pupil'
  const [pupilStatus, setPupilStatus] = useState('disconnected'); // 'disconnected', 'connecting', 'connected', 'failed'
  const [pupilRetryCount, setPupilRetryCount] = useState(0);
  
  // ã€ä¿®æ”¹éœ€æ±‚3ã€‘è¢«è¯•ç«¯æ¨¡å¼åˆ‡æ¢ç¡®è®¤å¼¹çª—
  const [showLearnerModeConfirm, setShowLearnerModeConfirm] = useState(false);
  const [learnerTargetMode, setLearnerTargetMode] = useState(null);
  
  // å®éªŒè€…ç«¯æ§åˆ¶ç¡®è®¤å¼¹çª—
  const [showModeConfirm, setShowModeConfirm] = useState(false);
  const [targetModeToSwitch, setTargetModeToSwitch] = useState(null);
  const [remoteInputMode, setRemoteInputMode] = useState('mouse'); // å®éªŒè€…çœ‹åˆ°çš„è¢«è¯•å½“å‰æ¨¡å¼
  // ã€ä¿®æ”¹éœ€æ±‚8ã€‘å®éªŒè€…ç«¯æ˜¾ç¤ºè¢«è¯•çš„ Pupil è¿æ¥çŠ¶æ€
  const [remotePupilStatus, setRemotePupilStatus] = useState('disconnected');

  // === ã€ä¿®æ”¹éœ€æ±‚1ã€‘è¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶çš„è¿æ¥å¼¹çª— ===
  const [showPupilConnectModal, setShowPupilConnectModal] = useState(false);
  const [pupilConnectAttempted, setPupilConnectAttempted] = useState(false);

  const [mcqAnswers, setMcqAnswers] = useState({});
  const [shortAnswer, setShortAnswer] = useState('');
  const [nasaTlx, setNasaTlx] = useState({ mental: 50, physical: 50, temporal: 50, performance: 50, effort: 50, frustration: 50 });
  const [isConsentChecked, setIsConsentChecked] = useState(false);
  const [famScrollDone, setFamScrollDone] = useState(false); 
  const [famClickDone, setFamClickDone] = useState(false);   
  const [famTimerDone, setFamTimerDone] = useState(false);   
  const [famCountdown, setFamCountdown] = useState(15);      
  const [showLearningGuide, setShowLearningGuide] = useState(false);
  
  const [postTestTimeLeft, setPostTestTimeLeft] = useState(180); 
  const [showFinishConfirm, setShowFinishConfirm] = useState(false);
  
  const [nasaSubmitCountdown, setNasaSubmitCountdown] = useState(10);
  // æ–°å¢ï¼šå®éªŒè€…æŸ¥çœ‹è¯¦æƒ…çš„ Modal çŠ¶æ€
  const [showReviewModal, setShowReviewModal] = useState(false);

  // === æ–°å¢ï¼šWOZ è¾…åŠ©åˆ¤æ–­æŒ‡æ ‡çŠ¶æ€ ===
  const [recentUTurnCount, setRecentUTurnCount] = useState(0); // è¿‡å»10ç§’ U-turn æ¬¡æ•°
  
  // ã€ä¿®æ”¹éœ€æ±‚3ã€‘æ£€æµ‹10så†…è·¨AOIæ‰«è§†çš„æ¬¡æ•°å¹¶æ˜¾ç¤º
  const [recentAoiTransitionCount, setRecentAoiTransitionCount] = useState(0);

  // ã€ä¿®æ”¹éœ€æ±‚9ã€‘æ£€æµ‹è¢«æµ‹åœ¨åŒä¸€å†…å®¹å—çš„åœç•™æ—¶é—´ - ä»…åœ¨å­¦ä¹ é˜¶æ®µè®¡æ—¶
  const [currentBlockDwell, setCurrentBlockDwell] = useState(0); 
  const blockStartTime = useRef(null); // ã€ä¿®æ”¹ã€‘æ”¹ä¸º nullï¼Œè¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶æ‰åˆå§‹åŒ–
  const lastBlockId = useRef('gibson'); // (ä¿ç•™å¤‡ç”¨)

  const fileInputRef = useRef(null); // æ–‡ä»¶ä¸Šä¼ å¼•ç”¨

  const scrollRef = useRef(null);
  const lastScrollDirection = useRef(null);
  const lastAOI = useRef('theory');
  const sessionStartTime = useRef(Date.now());
  const learningStartTime = useRef(null);

  // ã€ä¿®æ”¹éœ€æ±‚10ã€‘Pupil Core WebSocket å¼•ç”¨
  const pupilWsRef = useRef(null);
  const pupilReconnectTimeoutRef = useRef(null);

  const experimentData = useRef({
    participants: new Map() 
  });

  // === ã€ä¿®æ”¹éœ€æ±‚10ã€‘çœŸå® Pupil Core WebSocket è¿æ¥å‡½æ•° ===
  const initiatePupilConnection = useCallback(() => {
    // ã€ä¿®æ”¹éœ€æ±‚7ã€‘ä¿®å¤ï¼šå¦‚æœå·²ç»åœ¨è¿æ¥æˆ–å·²è¿æ¥ï¼Œåˆ™è·³è¿‡
    if (pupilStatus === 'connecting') return;
    
    setPupilStatus('connecting');
    console.log('[Pupil Core] Attempting WebSocket connection to:', PUPIL_WS_URL);

    // æ¸…ç†ä¹‹å‰çš„è¿æ¥
    if (pupilWsRef.current) {
      try {
        pupilWsRef.current.close();
      } catch (e) {
        console.log('[Pupil Core] Error closing previous connection:', e);
      }
      pupilWsRef.current = null;
    }

    try {
      const ws = new WebSocket(PUPIL_WS_URL);
      
      ws.onopen = () => {
        console.log('[Pupil Core] WebSocket connected successfully!');
        setPupilStatus('connected');
        setPupilRetryCount(0);
        
        // å‘é€è®¢é˜…æ¶ˆæ¯ï¼Œè¯·æ±‚æ³¨è§†ç‚¹æ•°æ®
        // å…·ä½“æ¶ˆæ¯æ ¼å¼å–å†³äºæ‚¨çš„ WebSocket æ¡¥æ¥å™¨å®ç°
        try {
          ws.send(JSON.stringify({
            action: 'subscribe',
            topic: 'gaze'
          }));
        } catch (e) {
          console.log('[Pupil Core] Error sending subscribe message:', e);
        }
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          
          // å¤„ç†æ³¨è§†ç‚¹æ•°æ® - Pupil Core è¿”å›çš„æ ¼å¼
          // é€šå¸¸åŒ…å« norm_pos (å½’ä¸€åŒ–åæ ‡ 0-1) æˆ– gaze_point_2d
          if (data.topic === 'gaze' || data.gaze_point_2d || data.norm_pos) {
            const gazeX = (data.norm_pos?.[0] || data.gaze_point_2d?.[0] || 0.5) * window.innerWidth;
            const gazeY = (1 - (data.norm_pos?.[1] || data.gaze_point_2d?.[1] || 0.5)) * window.innerHeight;
            
            // ã€ä¿®æ”¹éœ€æ±‚5ã€‘ä»…åœ¨ Pupil æ¨¡å¼ä¸‹ä¸”åœ¨å­¦ä¹ é˜¶æ®µå¤„ç†æ³¨è§†ç‚¹
            if (inputMode === 'pupil' && experimentPhase === 'learning') {
              handlePupilGazeData(gazeX, gazeY);
            }
          }
        } catch (e) {
          console.error('[Pupil Core] Parse error:', e);
        }
      };

      ws.onerror = (error) => {
        console.error('[Pupil Core] WebSocket error:', error);
      };

      ws.onclose = (event) => {
        console.log('[Pupil Core] WebSocket closed:', event.code, event.reason);
        pupilWsRef.current = null;
        
        // ã€ä¿®æ”¹éœ€æ±‚4ã€‘æ–­çº¿è‡ªåŠ¨é‡è¿é€»è¾‘ - ä»…åœ¨ Pupil æ¨¡å¼ä¸‹ä¸”åœ¨å­¦ä¹ é˜¶æ®µ
        if (inputMode === 'pupil' && experimentPhase === 'learning' && pupilStatus === 'connected') {
          handlePupilDisconnect();
        } else if (pupilStatus === 'connecting') {
          // è¿æ¥å¤±è´¥
          handlePupilDisconnect();
        }
      };

      pupilWsRef.current = ws;
      
      // è®¾ç½®è¿æ¥è¶…æ—¶
      setTimeout(() => {
        if (pupilStatus === 'connecting' && (!pupilWsRef.current || pupilWsRef.current.readyState !== WebSocket.OPEN)) {
          console.log('[Pupil Core] Connection timeout');
          handlePupilDisconnect();
        }
      }, 5000);
      
    } catch (error) {
      console.error('[Pupil Core] Failed to create WebSocket:', error);
      handlePupilDisconnect();
    }
  }, [inputMode, experimentPhase, pupilStatus]);

  // ã€ä¿®æ”¹éœ€æ±‚4ã€‘Pupil æ–­çº¿å¤„ç† - è‡ªåŠ¨é‡è¿æœ€å¤š3æ¬¡
  const handlePupilDisconnect = useCallback(() => {
    if (pupilReconnectTimeoutRef.current) {
      clearTimeout(pupilReconnectTimeoutRef.current);
    }
    
    if (pupilRetryCount < 3) {
      const nextRetry = pupilRetryCount + 1;
      setPupilRetryCount(nextRetry);
      setPupilStatus('disconnected');
      console.log(`[Pupil Core] Disconnected. Auto-retry ${nextRetry}/3 in 2s...`);
      
      pupilReconnectTimeoutRef.current = setTimeout(() => {
        initiatePupilConnection();
      }, 2000);
    } else {
      console.log('[Pupil Core] Max retries (3) reached. Stopped auto-reconnect.');
      setPupilStatus('failed');
    }
  }, [pupilRetryCount]);

  // ã€ä¿®æ”¹éœ€æ±‚4ã€‘æ‰‹åŠ¨é‡è¿
  const manualReconnect = useCallback(() => {
    if (pupilReconnectTimeoutRef.current) {
      clearTimeout(pupilReconnectTimeoutRef.current);
      pupilReconnectTimeoutRef.current = null;
    }
    setPupilRetryCount(0);
    setPupilStatus('disconnected');
    setTimeout(() => initiatePupilConnection(), 100);
  }, [initiatePupilConnection]);

  // æ–­å¼€ Pupil è¿æ¥
  const disconnectPupil = useCallback(() => {
    if (pupilReconnectTimeoutRef.current) {
      clearTimeout(pupilReconnectTimeoutRef.current);
      pupilReconnectTimeoutRef.current = null;
    }
    if (pupilWsRef.current) {
      try {
        pupilWsRef.current.close();
      } catch (e) {
        console.log('[Pupil Core] Error during disconnect:', e);
      }
      pupilWsRef.current = null;
    }
    setPupilStatus('disconnected');
    setPupilRetryCount(0);
  }, []);

  // ã€ä¿®æ”¹éœ€æ±‚5ã€‘å¤„ç† Pupil æ³¨è§†ç‚¹æ•°æ® - æ£€æµ‹æ³¨è§†çš„ AOI
  const handlePupilGazeData = useCallback((gazeX, gazeY) => {
    // æ£€æµ‹æ³¨è§†ç‚¹è½åœ¨å“ªä¸ª AOI åŒºåŸŸ
    const elements = document.elementsFromPoint(gazeX, gazeY);
    
    for (const el of elements) {
      const blockId = el.getAttribute('data-block-id');
      const aoiName = el.getAttribute('data-aoi-name');
      
      if (blockId && CONTENT_FEEDBACK_MAP[blockId]) {
        // å‘é€æ³¨è§†æ•°æ®
        if (role === 'learner') {
          sendData(null, 'gaze', { target: aoiName || blockId, blockId: blockId });
        }
        
        // æ›´æ–°å†…å®¹å—åœç•™æ—¶é—´
        if (blockId !== lastBlockId.current && blockStartTime.current) {
          lastBlockId.current = blockId;
          blockStartTime.current = Date.now();
        }
        return;
      }
      
      // æ£€æµ‹å·¦å³é¢æ¿ AOI
      const panel = el.getAttribute('data-panel');
      if (panel) {
        if (panel !== lastAOI.current) {
          const aoiData = { from: lastAOI.current, to: panel };
          setAoiTransitions(prev => prev + 1);
          logBehavior('aoi-transition', aoiData);
          lastAOI.current = panel;
        }
        return;
      }
    }
  }, [role]);

  // æ‰§è¡Œæ¨¡å¼åˆ‡æ¢
  const performModeSwitch = useCallback((newMode) => {
    setInputMode(newMode);
    if (newMode === 'pupil') {
      initiatePupilConnection();
    } else {
      disconnectPupil();
    }
  }, [initiatePupilConnection, disconnectPupil]);

  // === ã€ä¿®æ”¹éœ€æ±‚1ã€‘è¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶è‡ªåŠ¨å¼¹å‡ºè¿æ¥å¼¹çª— ===
  useEffect(() => {
    if (role === 'learner' && experimentPhase === 'learning' && !pupilConnectAttempted) {
      // æ˜¾ç¤ºè¿æ¥å¼¹çª—
      setShowPupilConnectModal(true);
      setPupilConnectAttempted(true);
      
      // è‡ªåŠ¨å°è¯•è¿æ¥ä¸€æ¬¡
      setInputMode('pupil');
      setTimeout(() => initiatePupilConnection(), 500);
    }
  }, [role, experimentPhase, pupilConnectAttempted, initiatePupilConnection]);

  // ã€ä¿®æ”¹éœ€æ±‚6ã€‘å­¦ä¹ é˜¶æ®µä»¥å¤–é»˜è®¤é¼ æ ‡æ¨¡å¼
  useEffect(() => {
    if (experimentPhase !== 'learning') {
      setInputMode('mouse');
      disconnectPupil();
    }
  }, [experimentPhase, disconnectPupil]);

  // ã€ä¿®æ”¹éœ€æ±‚9ã€‘è¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶åˆå§‹åŒ–å†…å®¹å—åœç•™è®¡æ—¶
  useEffect(() => {
    if (experimentPhase === 'learning' && !blockStartTime.current) {
      blockStartTime.current = Date.now();
    }
    if (experimentPhase !== 'learning') {
      blockStartTime.current = null;
      setCurrentBlockDwell(0);
    }
  }, [experimentPhase]);

  const saveExperimentData = () => {
    if (role !== 'experimenter') return;
    try {
      const dataToSave = {
        participants: Array.from(experimentData.current.participants.entries())
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
    } catch (e) {
      console.error("Save failed", e);
    }
  };

  const loadExperimentData = () => {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const parsed = JSON.parse(saved);
        if (parsed.participants) {
           experimentData.current.participants = new Map(parsed.participants);
           const pIds = Array.from(experimentData.current.participants.keys());
           setAllParticipants(pIds);
        }
      }
    } catch (e) {
      console.error("Load failed", e);
    }
  };

  const clearExperimentData = () => {
    if(confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å®éªŒæ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œå»ºè®®å…ˆå¯¼å‡ºæ•°æ®ã€‚")) {
      experimentData.current.participants = new Map();
      setAllParticipants([]);
      setSelectedParticipantId('');
      localStorage.removeItem(STORAGE_KEY);
      switchParticipant(''); 
    }
  };
  
  const deleteParticipantData = (targetId) => {
    if (!targetId) return;
    
    if (confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤è¢«è¯• [${targetId}] çš„æ‰€æœ‰æ•°æ®å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
      experimentData.current.participants.delete(targetId);
      setAllParticipants(prev => prev.filter(id => id !== targetId));
      if (selectedParticipantId === targetId) {
        switchParticipant('');
      }
      saveExperimentData();
    }
  };

  // å¯¼å…¥æ•°æ®åŠŸèƒ½
  const handleImportData = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (event) => {
      try {
        const importedData = JSON.parse(event.target.result);
        
        let newParticipantsCount = 0;
        
        // å¤„ç†å¤šç§æ ¼å¼
        if (importedData.participants && Array.isArray(importedData.participants)) {
           // æ ¼å¼1: Map entries æ•°ç»„
           importedData.participants.forEach(([key, value]) => {
             experimentData.current.participants.set(key, value);
             newParticipantsCount++;
           });
        } else if (importedData.id && typeof importedData.id === 'string' && importedData.id.startsWith('P')) {
           // æ ¼å¼2: å•ä¸ªè¢«è¯•å¯¹è±¡
           experimentData.current.participants.set(importedData.id, importedData);
           newParticipantsCount = 1;
        } else if (typeof importedData === 'object') {
           // æ ¼å¼3: å¯¹è±¡é›†åˆ
           Object.values(importedData).forEach(p => {
             if (p && p.id) {
               experimentData.current.participants.set(p.id, p);
               newParticipantsCount++;
             }
           });
        }

        if (newParticipantsCount > 0) {
          saveExperimentData();
          const pIds = Array.from(experimentData.current.participants.keys());
          setAllParticipants(pIds);
          
          if (selectedParticipantId && experimentData.current.participants.has(selectedParticipantId)) {
              switchParticipant(selectedParticipantId);
          } else if (pIds.length > 0) {
              switchParticipant(pIds[0]);
          }

          alert(`æˆåŠŸå¯¼å…¥ ${newParticipantsCount} æ¡è¢«è¯•æ•°æ®ï¼`);
        } else {
          alert("æœªåœ¨æ–‡ä»¶ä¸­å‘ç°æœ‰æ•ˆçš„è¢«è¯•æ•°æ®æ ¼å¼ã€‚");
        }
      } catch (err) {
        console.error(err);
        alert("å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼é”™è¯¯æˆ–å·²æŸåã€‚");
      }
      e.target.value = '';
    };
    reader.readAsText(file);
  };

  useEffect(() => {
    if (role === 'experimenter') {
      loadExperimentData();
    }
  }, [role]);

  // === æ–°å¢ï¼šå®æ—¶è®¡ç®—å®¢è§‚æŒ‡æ ‡ (WOZ è¾…åŠ©) ===
  useEffect(() => {
    // ä»…åœ¨å®éªŒè€…æ¨¡å¼ä¸”é€‰ä¸­äº†è¢«è¯•æ—¶è¿è¡Œ
    if (role === 'experimenter' && selectedParticipantId) {
      const timer = setInterval(() => {
        const now = Date.now();
        const tenSecondsAgo = now - 10000;
        
        // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šä½¿ç”¨ behaviorLogRef.current ä»£æ›¿ stateï¼Œé˜²æ­¢ timer è¢«é¢‘ç¹é‡ç½®
        const currentLogs = behaviorLogRef.current;

        // 1. è®¡ç®—è¿‡å»10ç§’çš„ U-turn æ¬¡æ•°
        const recentUTurns = currentLogs.filter(log => 
          log.type === 'u-turn' && log.timestamp >= tenSecondsAgo
        );
        setRecentUTurnCount(recentUTurns.length);

        // 2. ã€ä¿®æ”¹éœ€æ±‚3ã€‘è®¡ç®—è¿‡å»10ç§’çš„ AOI è·¨åŒºæ‰«è§†æ¬¡æ•°
        const recentTransitions = currentLogs.filter(log =>
          log.type === 'aoi-transition' && log.timestamp >= tenSecondsAgo
        );
        setRecentAoiTransitionCount(recentTransitions.length);

        // 3. ã€æ ¸å¿ƒä¿®å¤ - ä¿®æ”¹éœ€æ±‚1ã€‘
        // ä» experimentData ä¸­è·å–å½“å‰é€‰ä¸­è¢«è¯•çš„æ•°æ®ï¼ŒåŸºäºå…¶ç‹¬ç«‹çš„ blockEntryTime è®¡ç®—
        const pData = experimentData.current.participants.get(selectedParticipantId);
        if (pData && pData.blockEntryTime) {
           const dwellTimeSeconds = Math.floor((now - pData.blockEntryTime) / 1000);
           setCurrentBlockDwell(dwellTimeSeconds);
        } else {
           setCurrentBlockDwell(0);
        }

      }, 1000); // æ¯ç§’åˆ·æ–°ä¸€æ¬¡

      return () => clearInterval(timer);
    }
  // ã€æ ¸å¿ƒä¿®å¤ã€‘ï¼šç§»é™¤ behaviorLog ä¾èµ–ï¼Œé˜²æ­¢æ— é™é‡ç½® timer
  }, [role, selectedParticipantId]);

  // è‡ªåŠ¨æ»šåŠ¨åˆ°é¡¶éƒ¨
  useEffect(() => {
    if (experimentPhase === 'nasa') {
      window.scrollTo(0, 0);
    }
  }, [experimentPhase]);

  const getOrCreateParticipantData = (id) => {
    if (!experimentData.current.participants.has(id)) {
      experimentData.current.participants.set(id, {
        id,
        startTime: Date.now(),
        demographics: null,
        logs: [],            
        uTurns: [],          
        aoiTransitions: [],  
        interventions: [],   
        performance: null,   
        nasaTlx: null,
        preTest: null,
        posttest: null,
        currentPhase: 'consent',
        sessionTime: 0,
        gazeTarget: 'Waiting...',
        currentBlock: 'gibson',
        blockEntryTime: Date.now(), // åˆå§‹åŒ–å—è¿›å…¥æ—¶é—´
        levels: {}
      });
      setAllParticipants(prev => {
        if(prev.includes(id)) return prev;
        return [...prev, id];
      });
    }
    return experimentData.current.participants.get(id);
  };

  const switchParticipant = (pId) => {
    setSelectedParticipantId(pId);
    
    // åˆ‡æ¢è¢«è¯•æ—¶ï¼Œé‡ç½®è®¡æ—¶å™¨å¼•ç”¨
    blockStartTime.current = Date.now();
    lastBlockId.current = 'gibson';

    const pData = experimentData.current.participants.get(pId);
    
    if (pData) {
        setBehaviorLog(pData.logs || []);
        setScrollCount(pData.uTurns.length || 0);
        setAoiTransitions(pData.aoiTransitions.length || 0);
        setInterventionHistory(pData.interventions || []);
        setCurrentPerformance(pData.performance);
        setSessionTime(pData.sessionTime || 0);
        setExperimentPhase(pData.currentPhase || 'consent');
        setCurrentGazeTarget(pData.gazeTarget || 'Offline');
        setCurrentContentBlock(pData.currentBlock || 'gibson');
        setLevelsByBlock(pData.levels || {});
    } else {
        setBehaviorLog([]);
        setScrollCount(0);
        setAoiTransitions(0);
        setInterventionHistory([]);
        setCurrentPerformance(null);
    }
  };

  const handleDataFromLearner = (data) => {
    const pId = data.participantId;
    if(!pId) return;

    const pData = getOrCreateParticipantData(pId);
    const payload = data.payload || {};

    // åŸºç¡€æ—¥å¿—ä¸çœ¼åŠ¨æ•°æ®
    if (data.type === 'log') {
       pData.logs.push(payload);
       
       if (payload.type === 'u-turn') {
         pData.uTurns.push(payload);
       }
       if (payload.type === 'aoi-transition') {
         pData.aoiTransitions.push(payload);
       }
       if (payload.type === 'heartbeat') {
         pData.sessionTime = payload.sessionTime;
         pData.currentPhase = payload.phase;
         // ã€ä¿®æ”¹éœ€æ±‚7/8ã€‘å®éªŒè€…ç«¯æ¥æ”¶è¢«è¯•å½“å‰çš„è¾“å…¥æ¨¡å¼å’Œ Pupil çŠ¶æ€
         pData.inputMode = payload.inputMode || 'mouse';
         pData.pupilStatus = payload.pupilStatus || 'disconnected';
         if (pId === selectedParticipantId) {
             setRemoteInputMode(payload.inputMode || 'mouse');
             setRemotePupilStatus(payload.pupilStatus || 'disconnected');
         }
       }
    }
    if (data.type === 'gaze') {
        pData.gazeTarget = payload.target;
        if (payload.blockId && CONTENT_FEEDBACK_MAP[payload.blockId]) {
           // ã€ä¿®æ”¹éœ€æ±‚9ã€‘å°†åœç•™æ—¶é—´çš„è®¡ç®—é€»è¾‘ç§»å…¥ pData
           const newBlockId = payload.blockId;
           if (newBlockId !== pData.currentBlock) {
               pData.currentBlock = newBlockId;
               // ã€ä¿®æ”¹éœ€æ±‚9ã€‘ä»…åœ¨å­¦ä¹ é˜¶æ®µæ‰æ›´æ–° blockEntryTime
               if (pData.currentPhase === 'learning') {
                 pData.blockEntryTime = Date.now();
               }
           }
        }
    }
    
    // æ¥æ”¶å„ç§é—®å·æ•°æ®å¹¶åŒæ­¥åˆ° ExperimentData
    if (data.type === 'demographics') {
        pData.demographics = payload;
    }
    if (data.type === 'pretest') {
        pData.preTest = payload; 
    }
    if (data.type === 'nasa') {
        pData.nasaTlx = payload;
    }

    if (data.type === 'performance') {
      pData.performance = { ...payload, timestamp: Date.now() };
      // æ¥æ”¶è¢«è¯•çš„è¯¦ç»†ç­”é¢˜æ•°æ®
      pData.posttest = {
          ...pData.posttest, 
          mcq: payload.detailedAnswers, 
          shortAnswer: payload.shortAnswer,
          score: payload.mcqScore,
          accuracy: payload.accuracy,
          completionTimestamp: payload.completionTimestamp
      };
    }
    
    if (role === 'experimenter') {
        saveExperimentData();
    }

    if (!selectedParticipantId) {
        switchParticipant(pId);
        return;
    }

    // åªæœ‰å½“æ•°æ®æ¥è‡ªå½“å‰é€‰ä¸­çš„è¢«è¯•æ—¶ï¼Œæ‰æ›´æ–°UIçŠ¶æ€
    if (pId === selectedParticipantId) {
        if (data.type === 'log') {
            setBehaviorLog(prev => [...prev, payload]);
            if (payload.type === 'u-turn') setScrollCount(prev => prev + 1);
            if (payload.type === 'aoi-transition') setAoiTransitions(prev => prev + 1);
            if (payload.type === 'heartbeat') {
                setSessionTime(payload.sessionTime);
                setExperimentPhase(payload.phase);
            }
        }
        if (data.type === 'gaze') {
            setCurrentGazeTarget(payload.target);
            if (payload.blockId && CONTENT_FEEDBACK_MAP[payload.blockId]) {
               // è¿™é‡Œä¹Ÿéœ€è¦åŒæ­¥æ›´æ–° Dashboard çš„å½“å‰ Block çŠ¶æ€
               if (payload.blockId !== currentContentBlock) {
                 setCurrentContentBlock(payload.blockId);
               }
            }
        }
        if (data.type === 'performance') {
            setCurrentPerformance(payload);
        }
    }
  };

  const handleCommandFromExperimenter = (data) => {
      if (data.type === 'command') {
          if (data.payload.command === 'show_feedback') {
            setFeedbackContent(data.payload.content);
            setFeedbackLevel(data.payload.level);
            setShowFeedback(true);
            logBehavior('intervention_received', { level: data.payload.level });
          }
          if (data.payload.command === 'switch_mode') {
              const newMode = data.payload.mode;
              // ç›´æ¥åˆ‡æ¢æ¨¡å¼ï¼ˆç”±å®éªŒè€…æ§åˆ¶ï¼Œå·²ç»ç¡®è®¤è¿‡äº†ï¼‰
              performModeSwitch(newMode);
              alert(`ç®¡ç†å‘˜å·²å°†è¾“å…¥æ¨¡å¼åˆ‡æ¢ä¸º: ${newMode === 'pupil' ? 'Pupil Core çœ¼åŠ¨ä»ª' : 'é¼ æ ‡'}`);
          }
      }
  };

  const { sendData, isConnected } = useRealtimeSync(
    role, 
    participantId, 
    handleDataFromLearner, 
    handleCommandFromExperimenter
  );

  useEffect(() => {
    if (experimentPhase === 'posttest' && postTestTimeLeft > 0) {
      const timer = setTimeout(() => {
        setPostTestTimeLeft((prev) => prev - 1);
      }, 1000);
      return () => clearTimeout(timer);
    }
  }, [experimentPhase, postTestTimeLeft]);

  useEffect(() => {
    if (experimentPhase === 'nasa') {
      setNasaSubmitCountdown(10);
      const timer = setInterval(() => {
        setNasaSubmitCountdown((prev) => {
          if (prev <= 1) {
            clearInterval(timer);
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
      return () => clearInterval(timer);
    }
  }, [experimentPhase]);

  useEffect(() => {
    if (experimentPhase === 'familiarization') {
      setFamScrollDone(false);
      setFamClickDone(false);
      setFamTimerDone(false);
      setFamCountdown(15);
    }
  }, [experimentPhase]);

  useEffect(() => {
    if (experimentPhase === 'familiarization' && famCountdown > 0) {
      const timer = setTimeout(() => {
        setFamCountdown((current) => current - 1);
      }, 1000);
      return () => clearTimeout(timer);
    } else if (experimentPhase === 'familiarization' && famCountdown === 0) {
      setFamTimerDone(true);
    }
  }, [experimentPhase, famCountdown]);

  useEffect(() => {
    let timer;
    if (role === 'learner' && participantId && experimentPhase !== 'complete') {
      if (!sessionStartTime.current) {
        sessionStartTime.current = Date.now();
      }
      if (experimentPhase === 'learning' && !learningStartTime.current) {
        learningStartTime.current = Date.now();
      }
      
      timer = setInterval(() => {
        const startTime = learningStartTime.current || sessionStartTime.current;
        const duration = Math.floor((Date.now() - startTime) / 1000);
        setSessionTime(duration);
        sendData(null, 'log', { 
          type: 'heartbeat', 
          sessionTime: duration, 
          phase: experimentPhase,
          inputMode: inputMode, // å‘é€å½“å‰è¾“å…¥æ¨¡å¼çŠ¶æ€
          pupilStatus: pupilStatus
        });
      }, 1000);
    }
    return () => {
      if (timer) clearInterval(timer);
    };
  }, [role, participantId, experimentPhase, sendData, inputMode, pupilStatus]);

  useEffect(() => {
    if (cooldownRemaining > 0) {
      const timer = setTimeout(() => {
        setCooldownRemaining(cooldownRemaining - 1);
      }, 1000);
      return () => clearTimeout(timer);
    }
  }, [cooldownRemaining]);

  const logBehavior = (type, data) => {
    const logEntry = {
      timestamp: Date.now(),
      participantId,
      type,
      ...data
    };
    setBehaviorLog(prev => [...prev, logEntry]);
    if (role === 'learner') {
      sendData(null, 'log', logEntry);
    }
  };

  const handleGazeSim = (blockName, blockId) => {
    // ã€ä¿®æ”¹éœ€æ±‚5ã€‘ä»…åœ¨é¼ æ ‡æ¨¡å¼ä¸‹è§¦å‘ï¼ˆPupilæ¨¡å¼ç”±WebSocketå¤„ç†ï¼‰
    if (inputMode !== 'mouse') return; 

    if (role === 'learner' && experimentPhase === 'learning') {
        sendData(null, 'gaze', { target: blockName, blockId: blockId });
        
        // ã€ä¿®æ”¹éœ€æ±‚9ã€‘æ›´æ–°å†…å®¹å—åœç•™æ—¶é—´
        if (blockId !== lastBlockId.current && blockStartTime.current) {
          lastBlockId.current = blockId;
          blockStartTime.current = Date.now();
        }
    }
  };

  // åŒ…è£…å™¨ï¼Œç”¨äºç»‘å®šåˆ° onMouseEnter
  const handleInteraction = (blockName, blockId) => {
      handleGazeSim(blockName, blockId);
  };

  const startExperiment = (id) => {
    setParticipantId(id);
    setExperimentPhase('consent');
    sessionStartTime.current = Date.now();
    setPupilConnectAttempted(false); // ã€ä¿®æ”¹ã€‘é‡ç½®è¿æ¥å°è¯•æ ‡è®°
    experimentData.current.participants.set(id, {
      id,
      startTime: Date.now(),
      demographics: null,
      logs: [],
      uTurns: [],
      aoiTransitions: [],
      interventions: [],
      performance: null,
      nasaTlx: null,
      currentBlock: 'gibson',
      blockEntryTime: null, // ã€ä¿®æ”¹éœ€æ±‚9ã€‘è¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶æ‰åˆå§‹åŒ–
      inputMode: 'mouse',
      pupilStatus: 'disconnected'
    });
    logBehavior('session_start', { id });
  };

  const proceedToNextPhase = () => {
    const phases = ['consent', 'demographics', 'pretest', 'familiarization', 'learning', 'posttest', 'nasa', 'complete'];
    const currentIndex = phases.indexOf(experimentPhase);
    if (currentIndex < phases.length - 1) {
      const nextPhase = phases[currentIndex + 1];
      setExperimentPhase(nextPhase);
      logBehavior('phase_change', { from: experimentPhase, to: nextPhase });
      
      if (nextPhase === 'complete') {
         const totalSeconds = Math.floor((Date.now() - (sessionStartTime.current || Date.now())) / 1000);
         sendData(null, 'log', { 
          type: 'heartbeat', 
          sessionTime: totalSeconds, 
          phase: nextPhase 
        });
      }

      if (nextPhase === 'learning') {
        learningStartTime.current = Date.now();
        blockStartTime.current = Date.now(); // ã€ä¿®æ”¹éœ€æ±‚9ã€‘è¿›å…¥å­¦ä¹ é˜¶æ®µæ—¶åˆå§‹åŒ–å†…å®¹å—è®¡æ—¶
        setShowLearningGuide(true);
      }
    }
  };

  const handleScroll = (e) => {
    const scrollTop = e.target.scrollTop;
    const direction = scrollTop > (scrollRef.current || 0) ? 'down' : 'up';
    
    if (direction !== lastScrollDirection.current && lastScrollDirection.current !== null) {
      const uTurnData = { 
        direction, 
        scrollPosition: scrollTop,
        section: currentSection 
      };
      setScrollCount(prev => prev + 1);
      logBehavior('u-turn', uTurnData);
    }
    
    lastScrollDirection.current = direction;
    scrollRef.current = scrollTop;
  };

  const handleMouseMove = (e, panel) => {
    // ã€ä¿®æ”¹éœ€æ±‚5ã€‘ä»…åœ¨é¼ æ ‡æ¨¡å¼ä¸‹è§¦å‘AOIåˆ‡æ¢æ£€æµ‹
    if (inputMode !== 'mouse') return;
    
    const currentAOI = panel;
    if (currentAOI !== lastAOI.current) {
      const aoiData = { 
        from: lastAOI.current, 
        to: currentAOI 
      };
      setAoiTransitions(prev => prev + 1);
      logBehavior('aoi-transition', aoiData);
      lastAOI.current = currentAOI;
    }
  };

  const triggerIntervention = (level) => {
    if (cooldownRemaining > 0) return;
    if (!selectedParticipantId) {
        alert("è¯·å…ˆç­‰å¾…è¢«è¯•è¿æ¥æˆ–é€‰æ‹©ä¸€ä¸ªè¢«è¯•");
        return;
    }

    const currentBlockData = CONTENT_FEEDBACK_MAP[currentContentBlock] || CONTENT_FEEDBACK_MAP['gibson'];
    const feedbackContent = currentBlockData.levels?.[level] || DEFAULT_FEEDBACK[level];

    const interventionLog = {
      timestamp: Date.now(),
      level: level,
      contentBlock: currentContentBlock,
      triggerBy: 'experimenter'
    };

    setInterventionHistory(prev => [interventionLog, ...prev]);
    
    const pData = getOrCreateParticipantData(selectedParticipantId);
    pData.interventions.push(interventionLog);
    pData.levels = { ...pData.levels, [currentContentBlock]: level };

    setLevelsByBlock(prev => ({
      ...prev,
      [currentContentBlock]: level
    }));
    
    if(role === 'experimenter') saveExperimentData();

    setCooldownRemaining(30);
    
    sendData(selectedParticipantId, 'command', { 
        command: 'show_feedback', 
        level: level, 
        content: feedbackContent.content, 
        title: feedbackContent.title 
    });
  };

  // --- å¤„ç†æ•°æ®å¯¼å‡ºçš„å‡½æ•° ---
  const processDataForExport = (pData) => {
    if (!pData) return null;
    
    const cleanLogs = (pData.logs || [])
        .filter(l => l.type !== 'heartbeat')
        .map(l => ({
            ...l,
            formattedTime: formatTime(l.timestamp)
        }));
    
    const statistics = {
        interventionCount: (pData.interventions || []).length,
        uTurnCount: (pData.uTurns || []).length,
        aoiTransitionCount: (pData.aoiTransitions || []).length,
        totalDurationFormatted: `${Math.floor((pData.sessionTime || 0) / 60)}åˆ†${(pData.sessionTime || 0) % 60}ç§’`
    };

    const readableReport = {
        basicInfo: pData.demographics || "æœªå¡«å†™",
        preTest: {},
        postTest: {},
        nasaTLX: pData.nasaTlx || "æœªå¡«å†™"
    };

    if (pData.preTest) {
        PRETEST_QUESTIONS.forEach(q => {
            const val = pData.preTest[q.id];
            if (val === undefined) return;
            if (q.type === 'text') {
                 readableReport.preTest[q.question] = val;
            } else {
                 readableReport.preTest[q.question] = `${q.options[val]} [Index:${val}]`;
            }
        });
    }

    if (pData.posttest) {
        readableReport.postTest['ShortAnswer'] = pData.posttest.shortAnswer;
        readableReport.postTest['Score'] = pData.posttest.score;
        readableReport.postTest['Accuracy'] = pData.posttest.accuracy;
        
        if (pData.posttest.mcq) {
             POSTTEST_MCQ_QUESTIONS.forEach(q => {
                const val = pData.posttest.mcq[q.id];
                if (val === undefined) return;
                
                let answerText = '';
                if (q.type === 'single') {
                    answerText = `${q.options[val]} [Index:${val}]`;
                } else if (q.type === 'multi' && Array.isArray(val)) {
                    answerText = val.map(v => q.options[v]).join('; ') + ` [Indices:${val.join(',')}]`;
                }
                readableReport.postTest[`Q${q.id}: ${q.question}`] = answerText;
             });
        }
    }

    return {
        ...pData,
        logs: cleanLogs, 
        statistics: statistics, 
        humanReadableReport: readableReport,
        exportTimestamp: formatTime(Date.now())
    };
  };

  const exportAllData = () => {
    const allData = {};
    experimentData.current.participants.forEach((value, key) => {
        allData[key] = processDataForExport(value);
    });

    const dataStr = JSON.stringify(allData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `experiment_ALL_data_PROCESSED_${new Date().toISOString().slice(0,10)}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  const exportParticipantData = () => {
    if (!selectedParticipantId) {
        alert("å½“å‰æ²¡æœ‰é€‰å®šçš„è¢«è¯•");
        return;
    }
    const pData = experimentData.current.participants.get(selectedParticipantId);
    const processedData = processDataForExport(pData);
    
    const dataStr = JSON.stringify(processedData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    const exportFileDefaultName = `experiment_data_${selectedParticipantId}_PROCESSED_${new Date().toISOString().slice(0,10)}.json`;
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
  };

  const formatLogMessage = (log) => {
    if (log.type === 'u-turn') return `é¡µé¢å›æº¯: ${log.direction === 'up' ? 'å‘ä¸Š' : 'å‘ä¸‹'} (ä½ç½®: ${log.scrollPosition})`;
    if (log.type === 'aoi-transition') return `è§†çº¿åˆ‡æ¢: ${log.from} -> ${log.to}`;
    if (log.type === 'intervention_received') return `æ”¶åˆ°å¹²é¢„: Level ${log.level}`;
    if (log.type === 'phase_change') return `é˜¶æ®µå˜æ›´: ${phaseMap[log.from]} -> ${phaseMap[log.to]}`;
    if (log.type === 'session_start') return `ä¼šè¯å¼€å§‹: ID ${log.id}`;
    if (log.type === 'performance') return `ç»©æ•ˆè®¡ç®—å®Œæˆ: å¾—åˆ† ${log.score} (æ­£ç¡®ç‡ ${log.accuracy})`;
    const { timestamp, participantId, type, formattedTime, ...rest } = log;
    return JSON.stringify(rest).replace(/{|}|"/g, ' ').trim();
  };

  // ã€ä¿®æ”¹éœ€æ±‚3ã€‘è¢«è¯•ç«¯è§¦å‘æ¨¡å¼åˆ‡æ¢è¯·æ±‚ï¼ˆå¸¦ç¡®è®¤å¼¹çª—ï¼‰
  const requestLearnerModeSwitch = (mode) => {
      setLearnerTargetMode(mode);
      setShowLearnerModeConfirm(true);
  };

  // è¢«è¯•ç«¯ç¡®è®¤æ¨¡å¼åˆ‡æ¢
  const confirmLearnerModeSwitch = () => {
      performModeSwitch(learnerTargetMode);
      setShowLearnerModeConfirm(false);
  };

  // è§¦å‘æ¨¡å¼åˆ‡æ¢è¯·æ±‚
  const requestModeSwitch = (mode) => {
      setTargetModeToSwitch(mode);
      setShowModeConfirm(true);
  };

  // ç¡®è®¤æ¨¡å¼åˆ‡æ¢
  const confirmModeSwitch = () => {
      if (!selectedParticipantId) return;
      sendData(selectedParticipantId, 'command', {
          command: 'switch_mode',
          mode: targetModeToSwitch
      });
      setShowModeConfirm(false);
  };

  // ã€ä¿®æ”¹éœ€æ±‚2ã€‘æé†’é«˜è´Ÿè·çš„è§¦å‘è§„åˆ™
  const isHighLoad = (recentAoiTransitionCount > 4) || (recentUTurnCount > 2) || (currentBlockDwell > 30);

  if (!role) {
    return (
      <div style={styles.roleSelection}>
        <div style={styles.roleContainer}>
          <div style={styles.roleHeader}>
            <h1 style={styles.roleTitle}>ğŸ§  è®¤çŸ¥è´Ÿè·è‡ªé€‚åº”å­¦ä¹ å¹³å°</h1>
            <p style={styles.roleSubtitle}>åŸºäºçœ¼åŠ¨è¿½è¸ªä¸ç”Ÿæˆå¼AIçš„é—­ç¯å¹²é¢„ç³»ç»Ÿæ¼”ç¤º</p>
          </div>
          <div style={styles.roleGrid}>
            <button onClick={() => setRole('learner')} style={styles.roleButton} onMouseOver={(e) => { e.currentTarget.style.transform = styles.roleButtonHover.transform; e.currentTarget.style.boxShadow = styles.roleButtonHover.boxShadow; }} onMouseOut={(e) => { e.currentTarget.style.transform = 'none'; e.currentTarget.style.boxShadow = styles.roleButton.boxShadow; }}>
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                <span style={{ fontSize: '4rem' }}>ğŸ“</span>
                <h2 style={styles.roleButtonTitle}>å­¦ä¹ è€…ç«¯</h2>
                <p style={styles.roleButtonDesc}>ä½“éªŒè‡ªé€‚åº”å­¦ä¹ æ¨¡å—ï¼Œå­¦ä¹ è®¾è®¡ç†è®ºå¹¶æ¥æ”¶æ™ºèƒ½åé¦ˆ</p>
              </div>
            </button>
            <button onClick={() => setRole('experimenter')} style={styles.roleButton} onMouseOver={(e) => { e.currentTarget.style.transform = styles.roleButtonHover.transform; e.currentTarget.style.boxShadow = styles.roleButtonHover.boxShadow; }} onMouseOut={(e) => { e.currentTarget.style.transform = 'none'; e.currentTarget.style.boxShadow = styles.roleButton.boxShadow; }}>
              <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center' }}>
                <span style={{ fontSize: '4rem' }}>ğŸ§ª</span>
                <h2 style={styles.roleButtonTitle}>å®éªŒè€…æ§åˆ¶å°</h2>
                <p style={styles.roleButtonDesc}>ç›‘æ§å­¦ä¹ è€…è¡Œä¸ºï¼Œæ‰‹åŠ¨è§¦å‘ä¸‰å±‚è‡ªé€‚åº”åé¦ˆï¼ˆWOZæ–¹æ³•ï¼‰</p>
              </div>
            </button>
          </div>
        </div>
      </div>
    );
  }

  if (role === 'experimenter') {
    const currentLevel = levelsByBlock[currentContentBlock] || 0;
    const nextSuggestedLevel = Math.min(currentLevel + 1, 3);
    const currentBlockInfo = CONTENT_FEEDBACK_MAP[currentContentBlock] || CONTENT_FEEDBACK_MAP['gibson'];
    const isInterventionDisabled = experimentPhase !== 'learning' || !selectedParticipantId;

    return (
      <div style={styles.experimenterContainer}>
        <div style={styles.dashboard}>
          <div style={styles.dashboardHeader}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <h1 style={styles.dashboardTitle}>ğŸ§ª å®éªŒè€…æ§åˆ¶å° (WOZ)</h1>
                <p style={{ color: '#64748b', fontSize: '0.9rem', display:'flex', alignItems:'center', gap:'1rem' }}>
                   <span style={{color: isConnected ? '#10b981' : '#ef4444', display:'flex', alignItems:'center', gap:'0.3rem'}}>
                     <Icon name="wifi" size={14}/> {isConnected ? "å·²è¿æ¥æœåŠ¡å™¨" : "æ­£åœ¨è¿æ¥..."}
                   </span>
                   <span style={{background: '#f1f5f9', padding: '4px 12px', borderRadius: '20px', display:'flex', alignItems:'center', gap:'0.5rem'}}>
                      <Icon name="user" size={14}/>
                      <span style={{fontWeight:'bold', color:'#475569'}}>æŸ¥çœ‹è¢«è¯•:</span>
                      <select 
                        value={selectedParticipantId} 
                        onChange={(e) => switchParticipant(e.target.value)}
                        style={{
                            border: 'none', 
                            background: 'transparent', 
                            fontSize: '1rem', 
                            fontWeight: 'bold', 
                            color: '#2563eb',
                            cursor: 'pointer',
                            outline: 'none',
                            minWidth: '80px'
                        }}
                      >
                          {allParticipants.length === 0 && <option value="">(ç­‰å¾…è¿æ¥...)</option>}
                          {allParticipants.map(pid => (
                              <option key={pid} value={pid}>{pid}</option>
                          ))}
                      </select>
                   </span>
                </p>
              </div>
              <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center' }}>
                 <input 
                    type="file" 
                    accept=".json" 
                    style={{ display: 'none' }} 
                    ref={fileInputRef}
                    onChange={handleImportData}
                 />
                 <button 
                  onClick={() => fileInputRef.current.click()}
                  style={{ 
                      ...styles.button, 
                      background: 'white', 
                      color: '#334155', 
                      border: '1px solid #cbd5e1',
                      width: 'auto', 
                      display: 'flex', 
                      gap: '0.5rem', 
                      alignItems: 'center',
                      whiteSpace: 'nowrap',
                      padding: '0.6rem 1rem'
                  }}
                  title="å¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„å®éªŒæ•°æ®"
                >
                  <Icon name="upload" size={16} /> å¯¼å…¥æ•°æ®
                </button>

                <button
                  onClick={() => setShowReviewModal(true)}
                  disabled={!selectedParticipantId}
                  style={{
                    ...styles.button,
                    background: selectedParticipantId ? 'white' : '#f1f5f9',
                    color: selectedParticipantId ? '#2563eb' : '#94a3b8',
                    border: '1px solid #cbd5e1',
                    width: 'auto',
                    display: 'flex',
                    gap: '0.5rem',
                    alignItems: 'center',
                    cursor: selectedParticipantId ? 'pointer' : 'not-allowed',
                    whiteSpace: 'nowrap',
                    padding: '0.6rem 1rem'
                  }}
                  title="æŸ¥çœ‹è¯¥è¢«è¯•çš„ç­”é¢˜åŸå·å’Œè¯¦ç»†è®°å½•"
                >
                  <Icon name="doc" size={16} /> æŸ¥çœ‹è¯¦æƒ…/é˜…å·
                </button>

                 <button 
                  onClick={() => deleteParticipantData(selectedParticipantId)}
                  disabled={!selectedParticipantId}
                  style={{ 
                      ...styles.button, 
                      background: selectedParticipantId ? '#fee2e2' : '#f1f5f9', 
                      color: selectedParticipantId ? '#ef4444' : '#94a3b8', 
                      border: selectedParticipantId ? '1px solid #fca5a5' : '1px solid #cbd5e1',
                      width: 'auto', 
                      display: 'flex', 
                      gap: '0.5rem', 
                      alignItems: 'center',
                      padding: '0.6rem 1rem',
                      cursor: selectedParticipantId ? 'pointer' : 'not-allowed',
                      whiteSpace: 'nowrap'
                  }}
                  title="åˆ é™¤å½“å‰é€‰ä¸­çš„è¢«è¯•æ•°æ®"
                >
                  <Icon name="trash" size={16} /> åˆ é™¤å½“å‰
                </button>

                 <button 
                  onClick={clearExperimentData}
                  style={{ 
                      ...styles.button, 
                      background: 'white', 
                      color: '#ef4444', 
                      border: '1px solid #fca5a5',
                      width: 'auto', 
                      display: 'flex', 
                      gap: '0.5rem', 
                      alignItems: 'center',
                      padding: '0.6rem 1rem',
                      whiteSpace: 'nowrap'
                  }}
                  title="æ¸…ç©ºæœ¬åœ°ç¼“å­˜çš„æ‰€æœ‰æ•°æ®"
                >
                  <Icon name="trash" size={16} /> æ¸…é™¤æ‰€æœ‰
                </button>

                 <button 
                  onClick={exportParticipantData}
                  disabled={!selectedParticipantId}
                  style={{ 
                      ...styles.button, 
                      background: selectedParticipantId ? 'white' : '#f1f5f9', 
                      color: selectedParticipantId ? '#3b82f6' : '#94a3b8', 
                      border: '1px solid #cbd5e1',
                      width: 'auto', 
                      display: 'flex', 
                      gap: '0.5rem', 
                      alignItems: 'center',
                      cursor: selectedParticipantId ? 'pointer' : 'not-allowed',
                      whiteSpace: 'nowrap',
                      padding: '0.6rem 1rem'
                  }}
                >
                  <Icon name="download" size={16} /> å¯¼å‡ºå½“å‰
                </button>

                 <button 
                  onClick={exportAllData}
                  style={{ 
                      ...styles.button, 
                      background: 'white', 
                      color: '#334155', 
                      border: '1px solid #cbd5e1',
                      width: 'auto', 
                      display: 'flex', 
                      gap: '0.5rem', 
                      alignItems: 'center',
                      whiteSpace: 'nowrap',
                      padding: '0.6rem 1rem'
                  }}
                >
                  <Icon name="download" size={16} /> å¯¼å‡ºæ‰€æœ‰
                </button>
                <button 
                  onClick={() => setRole(null)} 
                  style={{ 
                    ...styles.button, 
                    background: 'white', 
                    color: '#ef4444', 
                    border: '1px solid #ef4444', 
                    width: 'auto',
                    whiteSpace: 'nowrap',
                    padding: '0.6rem 1rem'
                  }}
                >
                  é€€å‡º
                </button>
              </div>
            </div>
          </div>

          <div style={styles.dashboardGrid}>
            <div style={styles.dashboardPanel}>
              <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#334155' }}>
                <Icon name="user" /> è¢«è¯•çŠ¶æ€ ({selectedParticipantId || 'æœªé€‰æ‹©'})
              </h3>
              {selectedParticipantId ? (
                <div style={{ background: '#f0f9ff', padding: '1rem', borderRadius: '8px', border: '1px solid #bae6fd', marginBottom: '1rem' }}>
                  <div style={{ fontSize: '1.8rem', fontWeight: 'bold', color: '#0284c7', marginBottom: '0.2rem' }}>
                    {selectedParticipantId}
                  </div>
                  <div style={{ fontSize: '0.85rem', color: '#0369a1', display: 'flex', flexDirection: 'column', gap: '0.3rem' }}>
                    <span>â±ï¸ æ—¶é•¿: {Math.floor(sessionTime / 60)}åˆ† {sessionTime % 60}ç§’</span>
                    <span>ğŸ“ é˜¶æ®µ: <span style={{fontWeight:'bold'}}>{phaseMap[experimentPhase] || experimentPhase}</span></span>
                    
                    <span style={{ 
                      marginTop: '0.5rem', 
                      borderTop: '1px dashed #bae6fd', 
                      paddingTop: '0.5rem', 
                      display: 'flex', 
                      alignItems: 'center', 
                      gap: '0.4rem',
                      whiteSpace: 'nowrap',
                      overflow: 'hidden'
                    }}>
                        <Icon name="eye" size={14}/> 
                        <span style={{ whiteSpace:'nowrap' }}>æ³¨è§†ç‚¹: </span>
                        <span style={{ background: '#fff', padding: '0 4px', borderRadius: '2px', fontWeight: 'bold', whiteSpace:'nowrap', overflow:'hidden', textOverflow:'ellipsis' }}>
                          {currentGazeTarget}
                        </span>
                    </span>
                  </div>
                </div>
              ) : (
                <div style={{ padding: '1.5rem', textAlign: 'center', color: '#94a3b8', border: '2px dashed #e2e8f0', borderRadius: '8px', marginBottom: '1.5rem', fontSize: '0.9rem' }}>
                  è¯·åœ¨é¡¶éƒ¨é€‰æ‹©è¦æŸ¥çœ‹çš„è¢«è¯•<br/>(è¢«è¯•ä¸Šçº¿åä¼šè‡ªåŠ¨å‡ºç°)
                </div>
              )}
              
              <div style={{ marginBottom: '1rem' }}>
                {currentPerformance ? (
                  <div style={{ background: '#f0fdf4', padding: '1rem', borderRadius: '8px', border: '1px solid #bbf7d0' }}>
                    <h4 style={{fontSize:'0.9rem', fontWeight:'bold', color:'#15803d', display:'flex', alignItems:'center', gap:'0.3rem', margin: '0 0 0.5rem 0'}}>
                        <Icon name="chart" size={14}/> ä»»åŠ¡ç»©æ•ˆæ•°æ®
                    </h4>
                    <div style={{fontSize:'0.8rem', color:'#166534'}}>
                         <div style={{marginBottom:'0.2rem'}}>â³ æ€»å­¦ä¹ æ—¶é•¿: <span style={{fontWeight:'bold'}}>{Math.floor(currentPerformance.totalDuration / 60)}åˆ†{currentPerformance.totalDuration % 60}ç§’</span></div>
                         <div style={{marginBottom:'0.2rem'}}>ğŸ“ é€‰æ‹©é¢˜å¾—åˆ†: <span style={{fontWeight:'bold', fontSize:'1rem'}}>{currentPerformance.mcqScore}</span> / 10</div>
                         <div style={{marginBottom:'0.2rem'}}>ğŸ¯ æ­£ç¡®ç‡: <span style={{fontWeight:'bold', color: '#15803d'}}>{currentPerformance.accuracy}</span></div>
                         <div style={{marginTop:'0.5rem', borderTop:'1px dashed #bbf7d0', paddingTop:'0.4rem'}}>
                           <span style={{fontWeight:'bold'}}>ç®€ç­”é¢˜:</span><br/>
                           <span style={{color:'#334155', fontStyle:'italic'}}>"{currentPerformance.shortAnswer ? currentPerformance.shortAnswer.substring(0,30) : ''}..."</span>
                         </div>
                    </div>
                  </div>
                ) : (
                  selectedParticipantId && <div style={{ fontSize: '0.8rem', color: '#9ca3af', textAlign: 'center', fontStyle: 'italic' }}>æš‚æ— ç»©æ•ˆæ•°æ® (å®éªŒæœªå®Œæˆ)</div>
                )}
              </div>

              {/* === è¾“å…¥æºæ§åˆ¶é¢æ¿ === */}
              {selectedParticipantId && (
                  <div style={{ marginTop: '1rem', background: '#f8fafc', padding: '1rem', borderRadius: '8px', border: '1px solid #e2e8f0' }}>
                      <h4 style={{ fontSize: '0.9rem', fontWeight: 'bold', color: '#475569', marginBottom: '0.8rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                          ğŸ® è¾“å…¥æºæ§åˆ¶ (Input Source)
                      </h4>
                      <div style={{ display: 'flex', gap: '0.5rem' }}>
                          <button
                              onClick={() => requestModeSwitch('mouse')}
                              disabled={remoteInputMode === 'mouse'}
                              style={{
                                  flex: 1,
                                  padding: '0.5rem',
                                  fontSize: '0.8rem',
                                  borderRadius: '6px',
                                  border: '1px solid #cbd5e1',
                                  background: remoteInputMode === 'mouse' ? '#e2e8f0' : 'white',
                                  color: remoteInputMode === 'mouse' ? '#64748b' : '#1e293b',
                                  cursor: remoteInputMode === 'mouse' ? 'default' : 'pointer',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  gap: '4px'
                              }}
                          >
                             <Icon name="mouse" size={14}/> é¼ æ ‡
                          </button>
                          <button
                              onClick={() => requestModeSwitch('pupil')}
                              disabled={remoteInputMode === 'pupil'}
                              style={{
                                  flex: 1,
                                  padding: '0.5rem',
                                  fontSize: '0.8rem',
                                  borderRadius: '6px',
                                  border: '1px solid #cbd5e1',
                                  background: remoteInputMode === 'pupil' ? '#e0f2fe' : 'white',
                                  color: remoteInputMode === 'pupil' ? '#0369a1' : '#1e293b',
                                  cursor: remoteInputMode === 'pupil' ? 'default' : 'pointer',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  gap: '4px'
                              }}
                          >
                             <Icon name="pupil" size={14}/> Pupil Core
                          </button>
                      </div>
                  </div>
              )}

              <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '0.8rem', display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#334155', borderTop: '1px solid #e2e8f0', paddingTop: '1rem' }}>
                <Icon name="check" /> å¹²é¢„å†å² ({selectedParticipantId})
              </h3>
              <div style={{ flex: 1, overflowY: 'auto', fontSize: '0.85rem' }}>
                {interventionHistory.length === 0 ? (
                  <p style={{ color: '#94a3b8', fontStyle: 'italic' }}>å°šæ— å¹²é¢„è®°å½•</p>
                ) : (
                  interventionHistory.map((item, idx) => (
                    <div key={idx} style={{ marginBottom: '0.5rem', padding: '0.5rem', background: '#f8fafc', borderLeft: `3px solid ${item.level === 1 ? '#3b82f6' : item.level === 2 ? '#8b5cf6' : '#10b981'}`, borderRadius: '0 4px 4px 0' }}>
                      <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span style={{ fontWeight: 'bold' }}>Level {item.level}</span>
                        <span style={{ color: '#94a3b8', fontSize: '0.75rem' }}>{formatTime(item.timestamp)}</span>
                      </div>
                      <div style={{ fontSize: '0.75rem', color: '#64748b' }}>Block: {CONTENT_FEEDBACK_MAP[item.contentBlock]?.label || item.contentBlock}</div>
                    </div>
                  ))
                )}
              </div>
            </div>

            <div style={styles.dashboardPanel}>
               <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>
                <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#334155' }}>
                  <Icon name="activity" /> è¡Œä¸ºæ—¥å¿— ({selectedParticipantId})
                </h3>
                <span style={{ fontSize: '0.75rem', background: '#dcfce7', color: '#166534', padding: '2px 8px', borderRadius: '10px' }}>â— Filtered</span>
               </div>
              <div style={styles.logContainer}>
                  {behaviorLog.length === 0 ? (
                    <p style={{ textAlign: 'center', color: '#94a3b8', marginTop: '2rem', fontSize: '0.9rem' }}>æš‚æ— æ•°æ®è®°å½•...</p>
                  ) : (
                    behaviorLog.slice().reverse().filter(log => log.type !== 'heartbeat').map((log, index) => (
                      <div key={index} style={styles.logEntry}>
                        <span style={styles.logTime}>{formatTime(log.timestamp)}</span>
                        <span style={{...styles.logType, 
                          background: log.type === 'u-turn' ? '#fee2e2' : log.type === 'aoi-transition' ? '#e0f2fe' : '#e2e8f0',
                          color: log.type === 'u-turn' ? '#991b1b' : log.type === 'aoi-transition' ? '#075985' : '#334155'
                        }} title={log.type}>
                          {log.type}
                        </span>
                        <span style={styles.logData}>
                           {formatLogMessage(log)}
                        </span>
                      </div>
                    ))
                  )}
              </div>
            </div>

            <div style={{
                ...styles.dashboardPanel,
                ...(isInterventionDisabled ? styles.disabledPanel : {}) 
              }}>
              {isInterventionDisabled && (
                <div style={styles.disabledOverlay}>
                  <div style={styles.disabledText}>
                    {!selectedParticipantId ? 'è¯·å…ˆç­‰å¾…è¢«è¯•ä¸Šçº¿' : 'ğŸš« ä»…åœ¨æ­£å¼å­¦ä¹ é˜¶æ®µå¯ç”¨'}
                  </div>
                </div>
              )}

              {/* === æ–°å¢ï¼šWOZ é¢æ¿ === */}
              <div style={{ background: '#fff', padding: '1rem', borderRadius: '8px', border: '1px solid #6366f1', marginBottom: '1.5rem', boxShadow: '0 4px 6px -1px rgba(99, 102, 241, 0.1)' }}>
                  <h4 style={{ fontSize: '0.9rem', fontWeight: 'bold', color: '#4f46e5', marginBottom: '0.8rem', display:'flex', alignItems:'center', gap:'0.5rem' }}>
                      <Icon name="brain" size={16}/> å®æ—¶è®¤çŸ¥è´Ÿè·æŒ‡æ ‡ (è¿‡å»10s)
                  </h4>
                  <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>
                      <div style={{ textAlign: 'center' }}>
                          <div style={{ fontSize: '1.8rem', fontWeight: '800', color: recentUTurnCount > 2 ? '#ef4444' : '#334155' }}>
                              {recentUTurnCount}
                          </div>
                          <div style={{ fontSize: '0.75rem', color: '#64748b' }}>U-turns (10s)</div>
                      </div>
                      <div style={{ textAlign: 'center' }}>
                          <div style={{ fontSize: '1.8rem', fontWeight: '800', color: recentAoiTransitionCount > 4 ? '#ef4444' : '#334155' }}>
                              {recentAoiTransitionCount}
                          </div>
                          <div style={{ fontSize: '0.75rem', color: '#64748b' }}>AOIæ‰«è§† (10s)</div>
                      </div>
                  </div>
                  {/* ã€ä¿®æ”¹éœ€æ±‚9ã€‘æ˜¾ç¤ºåŒä¸€å†…å®¹å—åœç•™æ—¶é—´ - ä»…å­¦ä¹ é˜¶æ®µè®¡æ—¶ */}
                  <div style={{ marginTop: '0.8rem', textAlign: 'center', background: '#f8fafc', padding: '0.5rem', borderRadius: '4px' }}>
                     <div style={{ fontSize: '0.75rem', color: '#64748b' }}>å½“å‰å†…å®¹å—è¿ç»­åœç•™:</div>
                     <div style={{ fontSize: '1.2rem', fontWeight: '800', color: currentBlockDwell > 30 ? '#ef4444' : '#334155' }}>
                        {experimentPhase === 'learning' ? `${currentBlockDwell} s` : '- (éå­¦ä¹ é˜¶æ®µ)'}
                     </div>
                  </div>

                  {/* ã€ä¿®æ”¹éœ€æ±‚2ã€‘æé†’é«˜è´Ÿè·çš„è§¦å‘è§„åˆ™ */}
                  {isHighLoad && experimentPhase === 'learning' && (
                       <div style={{ marginTop:'0.5rem', padding:'0.4rem', background:'#fef2f2', color:'#b91c1c', fontSize:'0.75rem', borderRadius:'4px', textAlign:'center', fontWeight:'bold' }}>
                           âš ï¸ é«˜è®¤çŸ¥è´Ÿè·é¢„è­¦ (è§„åˆ™è§¦å‘)
                       </div>
                  )}
              </div>
              {/* === ç»“æŸï¼šWOZ é¢æ¿ === */}

              <h3 style={{ fontSize: '1.1rem', fontWeight: 'bold', marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.5rem', color: '#334155' }}>
                <Icon name="zap" /> å¹²é¢„æ§åˆ¶ ({selectedParticipantId})
              </h3>
              
              <div style={styles.metricGrid}>
                <div style={styles.metricCard}>
                  <div style={styles.metricValue}>{scrollCount}</div>
                  <div style={styles.metricLabel}>ç´¯è®¡ U-turn</div>
                </div>
                <div style={styles.metricCard}>
                  <div style={styles.metricValue}>{aoiTransitions}</div>
                  <div style={styles.metricLabel}>ç´¯è®¡ AOI åˆ‡æ¢</div>
                </div>
              </div>

              <div style={{ background: '#fff7ed', padding: '0.8rem', borderRadius: '8px', marginBottom: '1.5rem', border: '1px solid #ffedd5' }}>
                <h4 style={{ fontSize: '0.8rem', fontWeight: 'bold', color: '#9a3412', marginBottom: '0.2rem' }}>å½“å‰å†…å®¹å— (è‡ªåŠ¨åŒæ­¥):</h4>
                <select 
                  value={currentContentBlock} 
                  onChange={(e) => setCurrentContentBlock(e.target.value)}
                  disabled={isInterventionDisabled}
                  style={{ width: '100%', padding: '0.4rem', borderRadius: '4px', border: '1px solid #fdba74', fontSize: '0.85rem', color: '#c2410c', background: 'white' }}
                >
                  {Object.entries(CONTENT_FEEDBACK_MAP).map(([key, value]) => (
                    <option key={key} value={key}>{value.label}</option>
                  ))}
                </select>
                <div style={{ marginTop: '0.5rem', fontSize: '0.8rem', color: '#c2410c' }}>
                  å½“å‰ç­‰çº§: L{levelsByBlock[currentContentBlock] || 0} â†’ <span style={{ fontWeight: 'bold' }}>æ¨è: L{nextSuggestedLevel}</span>
                </div>
              </div>

              <div style={styles.triggerButtons}>
                <button 
                  style={{ ...styles.triggerButton, ...styles.triggerButton1, ...(cooldownRemaining > 0 ? styles.triggerButtonDisabled : {}) }}
                  disabled={cooldownRemaining > 0 || isInterventionDisabled}
                  onClick={() => triggerIntervention(1)}
                >
                  <span style={{display:'flex', alignItems:'center', gap:'0.5rem'}}>{currentBlockInfo.levels[1]?.title || "Level 1"}</span>
                </button>
                <button 
                  style={{ ...styles.triggerButton, ...styles.triggerButton2, ...(cooldownRemaining > 0 ? styles.triggerButtonDisabled : {}) }}
                  disabled={cooldownRemaining > 0 || isInterventionDisabled}
                  onClick={() => triggerIntervention(2)}
                >
                   <span style={{display:'flex', alignItems:'center', gap:'0.5rem'}}>{currentBlockInfo.levels[2]?.title || "Level 2"}</span>
                </button>
                <button 
                  style={{ ...styles.triggerButton, ...styles.triggerButton3, ...(cooldownRemaining > 0 ? styles.triggerButtonDisabled : {}) }}
                  disabled={cooldownRemaining > 0 || isInterventionDisabled}
                  onClick={() => triggerIntervention(3)}
                >
                   <span style={{display:'flex', alignItems:'center', gap:'0.5rem'}}>{currentBlockInfo.levels[3]?.title || "Level 3"}</span>
                </button>
              </div>
              
              {cooldownRemaining > 0 ? (
                <div style={{ background: '#f1f5f9', borderRadius: '8px', padding: '0.8rem', textAlign: 'center' }}>
                  <p style={{ fontSize: '0.85rem', color: '#64748b', marginBottom: '0.3rem' }}>ç³»ç»Ÿå†·å´ä¸­</p>
                  <div style={{ height: '6px', background: '#e2e8f0', borderRadius: '3px', overflow: 'hidden' }}>
                    <div style={{ width: `${(cooldownRemaining / 30) * 100}%`, background: '#94a3b8', height: '100%', transition: 'width 1s linear' }}></div>
                  </div>
                  <p style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#475569', marginTop: '0.2rem' }}>{cooldownRemaining}s</p>
                </div>
              ) : (
                <div style={{ textAlign: 'center', color: '#10b981', fontSize: '0.85rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.3rem' }}>
                  <span style={{ width: '8px', height: '8px', background: '#10b981', borderRadius: '50%' }}></span>
                  ç³»ç»Ÿå°±ç»ªï¼Œå¯è§¦å‘å¹²é¢„
                </div>
              )}
            </div>
          </div>
          
          {/* æ¨¡å¼åˆ‡æ¢ç¡®è®¤å¼¹çª— */}
          {showModeConfirm && (
              <div style={styles.modalOverlay}>
                  <div style={{ ...styles.modal, maxWidth: '350px', textAlign: 'center', padding: '1.5rem' }}>
                      <div style={{ fontSize: '3rem', marginBottom: '1rem' }}>âš ï¸</div>
                      <h3 style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#1e293b', marginBottom: '1rem' }}>
                          ç¡®è®¤åˆ‡æ¢è¾“å…¥æ¨¡å¼ï¼Ÿ
                      </h3>
                      <p style={{ color: '#64748b', lineHeight: 1.6, marginBottom: '1.5rem' }}>
                          æ‚¨æ­£åœ¨å°†å—è¯•è€… {selectedParticipantId} çš„è¾“å…¥æºåˆ‡æ¢ä¸ºï¼š<br/>
                          <strong style={{ color: '#3b82f6', fontSize: '1.1rem' }}>
                              {targetModeToSwitch === 'pupil' ? 'Pupil Core çœ¼åŠ¨ä»ª' : 'æ™®é€šé¼ æ ‡'}
                          </strong>
                      </p>
                      <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center' }}>
                          <button
                              onClick={() => setShowModeConfirm(false)}
                              style={{
                                  ...styles.button,
                                  background: 'white',
                                  color: '#475569',
                                  border: '1px solid #e2e8f0',
                                  boxShadow: 'none',
                                  width: 'auto'
                              }}
                          >
                              å–æ¶ˆ
                          </button>
                          <button
                              onClick={confirmModeSwitch}
                              style={{ ...styles.button, background: '#ef4444', border: 'none', color: 'white', width: 'auto' }}
                          >
                              ç¡®è®¤åˆ‡æ¢
                          </button>
                      </div>
                  </div>
              </div>
          )}
          
          {/* æ–°å¢ï¼šå®éªŒè€…æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† */}
          {showReviewModal && selectedParticipantId && (
            <div style={styles.modalOverlay}>
              <div style={{ ...styles.modal, maxWidth: '900px', maxHeight: '90vh', display: 'flex', flexDirection: 'column' }}>
                <div style={styles.modalHeader}>
                  <h3 style={styles.modalTitle}><Icon name="doc" /> ç­”é¢˜è¯¦æƒ…ä¸åŸå·å¤åŸ: {selectedParticipantId}</h3>
                  <button onClick={() => setShowReviewModal(false)} style={styles.closeButton}><Icon name="close" /></button>
                </div>
                <div style={{ ...styles.modalContent, overflowY: 'auto', padding: '2rem' }}>
                  {(() => {
                    const pData = experimentData.current.participants.get(selectedParticipantId);
                    if (!pData) return <div style={{textAlign:'center', padding:'2rem', color:'#94a3b8'}}>æœªæ‰¾åˆ°æ•°æ®</div>;

                    const demo = pData.demographics || {};
                    const pre = pData.preTest || {};
                    const post = pData.posttest || {};
                    const postMcq = post.mcq || {}; 
                    const nasa = pData.nasaTlx || {};
                    const perf = pData.performance || {};

                    return (
                      <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem' }}>
                        
                        {/* 1. åŸºæœ¬ä¿¡æ¯ */}
                        <section>
                          <h4 style={{ fontSize: '1.2rem', fontWeight: 'bold', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#334155' }}>
                            1. åŸºæœ¬ä¿¡æ¯ (Demographics)
                          </h4>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(4, 1fr)', gap: '1rem', background: '#f8fafc', padding: '1rem', borderRadius: '8px' }}>
                            <div><span style={{color:'#64748b'}}>å¹´é¾„:</span> <strong>{demo.age || '-'}</strong></div>
                            <div><span style={{color:'#64748b'}}>æ€§åˆ«:</span> <strong>{demo.gender || '-'}</strong></div>
                            <div><span style={{color:'#64748b'}}>ä¸“ä¸š:</span> <strong>{demo.major || '-'}</strong></div>
                            <div><span style={{color:'#64748b'}}>ç»éªŒ:</span> <strong>{demo.experience || '-'}</strong></div>
                          </div>
                        </section>

                        {/* 2. å‰æµ‹ */}
                        <section>
                          <h4 style={{ fontSize: '1.2rem', fontWeight: 'bold', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#334155' }}>
                            2. å‰æµ‹é—®å· (Pre-test)
                          </h4>
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '0.8rem' }}>
                            {PRETEST_QUESTIONS.map(q => {
                                const ans = pre[q.id];
                                let ansText = '-';
                                if(q.type === 'text') ansText = ans || '-';
                                else if(ans !== undefined) ansText = q.options[ans];
                                
                                return (
                                  <div key={q.id} style={{ fontSize: '0.9rem' }}>
                                    <div style={{ fontWeight: '600', color:'#475569', marginBottom:'0.2rem' }}>{q.question}</div>
                                    <div style={{ color: '#1e40af', background: '#eff6ff', padding: '0.4rem 0.8rem', borderRadius: '4px', display:'inline-block' }}>
                                      å›ç­”: {ansText}
                                    </div>
                                  </div>
                                )
                            })}
                          </div>
                        </section>

                        {/* 3. åæµ‹ (é‡ç‚¹: æ¨¡æ‹Ÿè¯•å·) */}
                        <section>
                          <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem'}}>
                             <h4 style={{ fontSize: '1.2rem', fontWeight: 'bold', color: '#334155', margin:0 }}>
                               3. åæµ‹ (Post-test) 
                             </h4>
                             <div style={{display:'flex', gap:'1rem', alignItems:'center'}}>
                                {post.completionTimestamp && (
                                   <span style={{fontSize:'0.85rem', color:'#64748b', background:'#f1f5f9', padding:'2px 8px', borderRadius:'4px'}}>
                                     å®Œæˆäº: {new Date(post.completionTimestamp).toLocaleString('zh-CN')}
                                   </span>
                                )}
                                <span style={{background:'#dcfce7', color:'#166534', padding:'4px 12px', borderRadius:'20px', fontWeight:'bold', fontSize:'0.9rem'}}>
                                  å¾—åˆ†: {post.score || 0} / {POSTTEST_MCQ_QUESTIONS.length} ({post.accuracy || '0%'})
                                </span>
                             </div>
                          </div>
                          
                          <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
                             {POSTTEST_MCQ_QUESTIONS.map((q, idx) => {
                               const userAns = postMcq[q.id];
                               
                               // åˆ¤æ–­æ­£è¯¯
                               let isCorrect = false;
                               if(q.type === 'single') {
                                   isCorrect = (userAns === q.correct[0]);
                               } else {
                                   isCorrect = (userAns && userAns.length === q.correct.length && userAns.every(v => q.correct.includes(v)));
                               }

                               return (
                                 <div key={q.id} style={{ padding: '1rem', borderRadius: '8px', border: '1px solid #e2e8f0', background: isCorrect ? '#f0fdf4' : '#fef2f2' }}>
                                    <div style={{fontWeight:'bold', color:'#334155', marginBottom:'0.8rem'}}>
                                      {idx+1}. {q.question} 
                                      <span style={{marginLeft:'0.5rem', fontSize:'0.8rem', color: isCorrect ? '#16a34a' : '#dc2626'}}>
                                          {isCorrect ? 'âœ… æ­£ç¡®' : 'âŒ é”™è¯¯'}
                                      </span>
                                    </div>
                                    <div style={{display:'flex', flexDirection:'column', gap:'0.4rem'}}>
                                       {q.options.map((opt, optIdx) => {
                                           const isSelected = q.type === 'multi' ? (userAns||[]).includes(optIdx) : (userAns === optIdx);
                                           const isRightOption = q.correct.includes(optIdx);
                                           
                                           let styleObj = { padding: '4px 8px', borderRadius: '4px', fontSize: '0.9rem', color: '#64748b' };
                                           if (isSelected) {
                                               styleObj.background = isCorrect ? '#bbf7d0' : '#fecaca';
                                               styleObj.color = isCorrect ? '#14532d' : '#7f1d1d';
                                               styleObj.fontWeight = 'bold';
                                           }
                                           if (isRightOption && !isSelected) {
                                               styleObj.border = '1px dashed #22c55e'; // æç¤ºæ­£ç¡®ç­”æ¡ˆ
                                           }

                                           return (
                                              <div key={optIdx} style={styleObj}>
                                                 {isSelected ? (q.type==='multi'?'â˜‘':'â—‰') : (q.type==='multi'?'â˜':'â—‹')} {opt}
                                                 {isRightOption && !isSelected && <span style={{marginLeft:'0.5rem', color:'#22c55e', fontSize:'0.8rem'}}>(æ­£ç¡®ç­”æ¡ˆ)</span>}
                                              </div>
                                           )
                                       })}
                                    </div>
                                 </div>
                               );
                             })}
                             
                             <div style={{ marginTop: '1rem', padding: '1rem', background: '#fff', border: '1px solid #cbd5e1', borderRadius: '8px' }}>
                               <strong style={{display:'block', marginBottom:'0.5rem', color:'#334155'}}>ç®€ç­”é¢˜å›ç­”:</strong>
                               {/* ã€ä¿®å¤2ã€‘ä¼˜åŒ–ç®€ç­”é¢˜æ˜¾ç¤ºï¼šå¢åŠ  overflow-wrap å’Œå¤‡ç”¨æ•°æ®æºè¯»å– */}
                               <p style={{
                                 background:'#f1f5f9', 
                                 padding:'1rem', 
                                 borderRadius:'6px', 
                                 margin:0, 
                                 color:'#475569', 
                                 whiteSpace:'pre-wrap',
                                 wordBreak: 'break-word',
                                 overflowWrap: 'break-word'
                               }}>
                                 {post.shortAnswer || perf.shortAnswer || '(æœªä½œç­”)'}
                               </p>
                             </div>
                          </div>
                        </section>

                        {/* 4. NASA-TLX */}
                        <section>
                          <h4 style={{ fontSize: '1.2rem', fontWeight: 'bold', borderBottom: '2px solid #e2e8f0', paddingBottom: '0.5rem', marginBottom: '1rem', color: '#334155' }}>
                            4. è´Ÿè·é‡è¡¨ (NASA-TLX)
                          </h4>
                          <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '1rem' }}>
                             {NASA_DIMENSIONS.map(dim => (
                                 <div key={dim.key} style={{ background: '#f8fafc', padding: '0.8rem', borderRadius: '6px', border: '1px solid #e2e8f0' }}>
                                     <div style={{display:'flex', justifyContent:'space-between', fontSize:'0.9rem', fontWeight:'bold', color:'#475569', marginBottom:'0.3rem'}}>
                                        <span>{dim.label.split(' ')[1]}</span>
                                        <span style={{color:'#3b82f6'}}>{nasa[dim.key] ?? '-'}</span>
                                     </div>
                                     <div style={{height:'6px', background:'#e2e8f0', borderRadius:'3px', overflow:'hidden'}}>
                                        <div style={{width: `${nasa[dim.key]||0}%`, background: '#3b82f6', height:'100%'}}></div>
                                     </div>
                                 </div>
                             ))}
                          </div>
                        </section>

                      </div>
                    );
                  })()}
                </div>
                <div style={styles.modalFooter}>
                   <button onClick={() => setShowReviewModal(false)} style={{...styles.button, width:'auto'}}>å…³é—­</button>
                </div>
              </div>
            </div>
          )}

        </div>
      </div>
    );
  }

  if (role === 'learner') {
     if (!participantId) {
      const validateAndLogin = (inputVal) => {
        const val = inputVal.trim().toUpperCase();
        const isValid = /^P(0[1-9]|[1-3][0-9]|40)$/.test(val);
        if (isValid) { startExperiment(val); } else { alert("ç¼–å·æ— æ•ˆï¼\nè¯·ä¸¥æ ¼è¾“å…¥ P01 åˆ° P40 ä¹‹é—´çš„ç¼–å·ã€‚\nä¾‹å¦‚ï¼šP01, P12, P40"); }
      };
      return (
        <div style={styles.loginContainer}>
          <div style={styles.loginBox}>
            <button onClick={() => setRole(null)} style={styles.backButton} onMouseOver={(e) => e.currentTarget.style.color = '#3b82f6'} onMouseOut={(e) => e.currentTarget.style.color = '#94a3b8'}>
              <span>â¬…</span> è¿”å›é¦–é¡µ
            </button>
            <h2 style={styles.loginTitle}>ğŸ” å®éªŒç™»å½•</h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem' }}>
              <div style={styles.formGroup}>
                <label style={styles.label}>è¯·è¾“å…¥è¢«è¯•ç¼–å· (èŒƒå›´: P01-P40)</label>
                <input type="text" placeholder="ä¾‹å¦‚: P01" maxLength={3} style={styles.input} onFocus={(e) => { e.target.style.borderColor = styles.inputFocus.borderColor; e.target.style.boxShadow = styles.inputFocus.boxShadow; e.target.style.background = styles.inputFocus.background; }} onBlur={(e) => { e.target.style.borderColor = styles.input.borderColor; e.target.style.boxShadow = 'none'; e.target.style.background = styles.input.background; }} onKeyPress={(e) => { if (e.key === 'Enter') { validateAndLogin(e.currentTarget.value); } }} />
              </div>
              <button onClick={() => { const input = document.querySelector('input[type="text"]'); if (input) { validateAndLogin(input.value); } }} style={styles.button} onMouseOver={(e) => { e.target.style.background = styles.buttonHover.background; e.target.style.transform = styles.buttonHover.transform; }} onMouseOut={(e) => { e.target.style.background = styles.button.background; e.target.style.transform = 'none'; }}>å¼€å§‹å®éªŒ</button>
            </div>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'consent') {
      return (
        <div style={styles.consentContainer}>
          <div style={styles.consentBox}>
            <button onClick={() => setParticipantId('')} style={styles.backButton} onMouseOver={(e) => e.currentTarget.style.color = '#3b82f6'} onMouseOut={(e) => e.currentTarget.style.color = '#94a3b8'}>
              <span>â¬…</span> è¿”å›ç™»å½•
            </button>
            <h2 style={styles.consentTitle}>ğŸ“‹ çŸ¥æƒ…åŒæ„ä¹¦</h2>
            <div style={styles.consentContent}>
              <p>æ„Ÿè°¢æ‚¨å‚ä¸æœ¬æ¬¡è®¤çŸ¥è´Ÿè·ç ”ç©¶å®éªŒã€‚åœ¨å¼€å§‹ä¹‹å‰ï¼Œè¯·æ‚¨ä»”ç»†é˜…è¯»ä»¥ä¸‹ä¿¡æ¯ï¼š</p>
              <h3 style={{ fontWeight: '700', marginTop: '1.5rem', marginBottom: '0.8rem', color: '#334155' }}>ğŸ“ å®éªŒç›®çš„</h3>
              <p>æœ¬ç ”ç©¶æ—¨åœ¨æ¢ç´¢è‡ªé€‚åº”å­¦ä¹ ç³»ç»Ÿå¦‚ä½•ä¼˜åŒ–è®¾è®¡æ•™è‚²ä¸­çš„è®¤çŸ¥è´Ÿè·ï¼Œæé«˜å­¦ä¹ æ•ˆç‡ã€‚</p>
              <h3 style={{ fontWeight: '700', marginTop: '1.5rem', marginBottom: '0.8rem', color: '#334155' }}>ğŸ”„ å®éªŒæµç¨‹</h3>
              <ul style={{ paddingLeft: '1.5rem', marginBottom: '1rem', listStyleType: 'none' }}>
                <li style={{ marginBottom: '0.5rem' }}>1ï¸âƒ£ å¡«å†™åŸºæœ¬ä¿¡æ¯é—®å·</li>
                <li style={{ marginBottom: '0.5rem' }}>2ï¸âƒ£ å­¦ä¹ è®¾è®¡ç†è®ºå†…å®¹ï¼ˆçº¦15-20åˆ†é’Ÿï¼‰</li>
                <li style={{ marginBottom: '0.5rem' }}>3ï¸âƒ£ å®Œæˆåæµ‹è¯„ä¼°</li>
                <li style={{ marginBottom: '0.5rem' }}>4ï¸âƒ£ å¡«å†™NASA-TLXå·¥ä½œè´Ÿè·é‡è¡¨</li>
              </ul>
              <h3 style={{ fontWeight: '700', marginTop: '1.5rem', marginBottom: '0.8rem', color: '#334155' }}>ğŸ›¡ï¸ æ•°æ®æ”¶é›†</h3>
              <p>æˆ‘ä»¬å°†æ”¶é›†æ‚¨çš„äº¤äº’è¡Œä¸ºæ•°æ®ã€å­¦ä¹ è¡¨ç°æ•°æ®ä»¥åŠä¸»è§‚è¯„ä»·æ•°æ®ã€‚æ‰€æœ‰æ•°æ®å°†ä¸¥æ ¼ä¿å¯†ï¼Œä»…ç”¨äºå­¦æœ¯ç ”ç©¶ã€‚</p>
            </div>
            <div style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '2rem', padding: '1rem', background: '#f1f5f9', borderRadius: '8px' }}>
              <input type="checkbox" id="consent" checked={isConsentChecked} onChange={(e) => setIsConsentChecked(e.target.checked)} style={{ width: '1.2rem', height: '1.2rem', cursor: 'pointer' }} />
              <label htmlFor="consent" style={{ color: '#475569', cursor: 'pointer', userSelect: 'none', fontWeight: '500' }}>æˆ‘ç†è§£ä¸Šè¿°ä¿¡æ¯å¹¶è‡ªæ„¿å‚ä¸æœ¬å®éªŒ</label>
            </div>
            <button onClick={proceedToNextPhase} disabled={!isConsentChecked} style={{ ...styles.button, background: isConsentChecked ? '#3b82f6' : '#cbd5e1', cursor: isConsentChecked ? 'pointer' : 'not-allowed', boxShadow: isConsentChecked ? styles.button.boxShadow : 'none' }} onMouseOver={(e) => { if (isConsentChecked) { e.currentTarget.style.background = styles.buttonHover.background; } }} onMouseOut={(e) => { if (isConsentChecked) { e.currentTarget.style.background = styles.button.background; } }}>æˆ‘åŒæ„ï¼Œç»§ç»­ä¸‹ä¸€æ­¥</button>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'demographics') {
      const ageNum = parseInt(demographics.age, 10);
      const isAgeValid = !isNaN(ageNum) && ageNum >= 22 && ageNum <= 25;
      const isFormComplete = isAgeValid && demographics.gender !== '' && demographics.major.trim() !== '' && demographics.experience !== '';

      return (
        <div style={styles.consentContainer}>
          <div style={styles.consentBox}>
            <button onClick={() => setExperimentPhase('consent')} style={styles.backButton} onMouseOver={(e) => e.currentTarget.style.color = '#3b82f6'} onMouseOut={(e) => e.currentTarget.style.color = '#94a3b8'}>
              <span>â¬…</span> ä¸Šä¸€æ­¥
            </button>
            <h2 style={styles.consentTitle}>ğŸ“ åŸºæœ¬ä¿¡æ¯é—®å·</h2>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', marginBottom: '2.5rem' }}>
              <div>
                <label style={styles.label}>å¹´é¾„ <span style={{color: '#ef4444'}}>*</span></label>
                <input type="number" value={demographics.age} onChange={(e) => setDemographics(prev => ({ ...prev, age: e.target.value }))} style={{ ...styles.input, borderColor: (demographics.age && !isAgeValid) ? '#ef4444' : styles.input.borderColor }} placeholder="è¯·è¾“å…¥æ•°å­— (22-25)" onFocus={(e) => { e.target.style.borderColor = styles.inputFocus.borderColor; e.target.style.boxShadow = styles.inputFocus.boxShadow; }} onBlur={(e) => { e.target.style.borderColor = (demographics.age && !isAgeValid) ? '#ef4444' : styles.input.borderColor; e.target.style.boxShadow = 'none'; }} />
                {demographics.age && !isAgeValid && ( <p style={{ color: '#ef4444', fontSize: '0.85rem', marginTop: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.25rem' }}><Icon name="alert" size={14}/> å¹´é¾„å¿…é¡»åœ¨ 22 åˆ° 25 å²ä¹‹é—´</p> )}
              </div>
              <div>
                <label style={styles.label}>æ€§åˆ« <span style={{color: '#ef4444'}}>*</span></label>
                <select value={demographics.gender} onChange={(e) => setDemographics(prev => ({ ...prev, gender: e.target.value }))} style={styles.input}>
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="male">ç”·</option>
                  <option value="female">å¥³</option>
                  <option value="other">å…¶ä»–</option>
                </select>
              </div>
              <div>
                <label style={styles.label}>è®¾è®¡ä¸“ä¸šé¢†åŸŸ <span style={{color: '#ef4444'}}>*</span></label>
                <input type="text" value={demographics.major} onChange={(e) => setDemographics(prev => ({ ...prev, major: e.target.value }))} placeholder="ä¾‹å¦‚ï¼šäº§å“è®¾è®¡ã€å·¥ä¸šè®¾è®¡ã€ç¯å¢ƒè®¾è®¡ã€è§†è§‰ä¼ è¾¾è®¾è®¡ç­‰" style={styles.input} onFocus={(e) => { e.target.style.borderColor = styles.inputFocus.borderColor; e.target.style.boxShadow = styles.inputFocus.boxShadow; }} onBlur={(e) => { e.target.style.borderColor = styles.input.borderColor; e.target.style.boxShadow = 'none'; }} />
              </div>
              <div>
                <label style={styles.label}>è®¾è®¡ç»éªŒ <span style={{color: '#ef4444'}}>*</span></label>
                <select value={demographics.experience} onChange={(e) => setDemographics(prev => ({ ...prev, experience: e.target.value }))} style={styles.input}>
                  <option value="">è¯·é€‰æ‹©</option>
                  <option value="beginner">åˆå­¦è€… (0-1å¹´)</option>
                  <option value="intermediate">ä¸­çº§ (1-3å¹´)</option>
                  <option value="advanced">é«˜çº§ (3å¹´ä»¥ä¸Š)</option>
                </select>
              </div>
            </div>
            <button onClick={() => { 
                if (isFormComplete) { 
                    const pData = experimentData.current.participants.get(participantId);
                    if (pData) pData.demographics = demographics; 
                    sendData(null, 'demographics', demographics);
                    proceedToNextPhase(); 
                } 
            }} disabled={!isFormComplete} style={{ ...styles.button, background: isFormComplete ? '#3b82f6' : '#cbd5e1', cursor: isFormComplete ? 'pointer' : 'not-allowed' }} onMouseOver={(e) => { if (isFormComplete) { e.target.style.background = styles.buttonHover.background; } }} onMouseOut={(e) => { if (isFormComplete) { e.target.style.background = styles.button.background; } }}>
              {demographics.age && !isAgeValid ? 'å¹´é¾„ä¸ç¬¦åˆè¦æ±‚' : (isFormComplete ? 'ç»§ç»­' : 'è¯·å¡«å†™å®Œæ•´ä¿¡æ¯')}
            </button>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'pretest') {
      const isPretestComplete = preTestAnswers['p1'] !== undefined && preTestAnswers['p2'] !== undefined;

      return (
        <div style={styles.consentContainer}>
          <div style={styles.consentBox}>
             <button onClick={() => setExperimentPhase('demographics')} style={styles.backButton} onMouseOver={(e) => e.currentTarget.style.color = '#3b82f6'} onMouseOut={(e) => e.currentTarget.style.color = '#94a3b8'}>
              <span>â¬…</span> ä¸Šä¸€æ­¥
            </button>
            <h2 style={styles.consentTitle}>ğŸ§© åŸºçº¿çŸ¥è¯†é¢„æµ‹è¯•</h2>
            <p style={{ color: '#64748b', marginBottom: '1.5rem' }}>ä¸ºäº†è¯„ä¼°å®éªŒæ•ˆæœï¼Œæˆ‘ä»¬éœ€è¦äº†è§£æ‚¨å¯¹ç›¸å…³ä¸»é¢˜çš„åˆå§‹ç†Ÿæ‚‰ç¨‹åº¦ã€‚æ­¤éƒ¨åˆ†æ²¡æœ‰â€œæ­£ç¡®â€ç­”æ¡ˆï¼Œè¯·æ ¹æ®çœŸå®æƒ…å†µä½œç­”ã€‚</p>
            <div style={{ display: 'flex', flexDirection: 'column', gap: '1.5rem', marginBottom: '2.5rem' }}>
              {PRETEST_QUESTIONS.map((q) => (
                <div key={q.id} style={{ padding: '1.5rem', background: '#f8fafc', borderRadius: '12px', border: '1px solid #f1f5f9' }}>
                  <p style={{ fontWeight: '600', color: '#334155', marginBottom: '1rem' }}>{q.question}</p>
                  {q.type === 'text' ? (
                     <input type="text" style={{ ...styles.input, width: '100%' }} placeholder="æ‚¨çš„å›ç­”..." onChange={(e) => setPreTestAnswers({...preTestAnswers, [q.id]: e.target.value})} value={preTestAnswers[q.id] || ''} />
                  ) : (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.8rem' }}>
                      {q.options.map((opt, idx) => (
                        <label key={idx} style={{ display: 'flex', alignItems: 'center', gap: '0.75rem', cursor: 'pointer' }}>
                          <input type="radio" name={q.id} value={idx} checked={preTestAnswers[q.id] === idx} onChange={() => setPreTestAnswers({...preTestAnswers, [q.id]: idx})} style={{ width: '1.1rem', height: '1.1rem', accentColor: '#3b82f6' }} />
                          <span style={{ color: '#475569' }}>{opt}</span>
                        </label>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </div>
            <button onClick={() => { 
                if (isPretestComplete) { 
                    const pData = experimentData.current.participants.get(participantId);
                    if(pData) pData.preTest = preTestAnswers;
                    sendData(null, 'pretest', preTestAnswers); 
                    proceedToNextPhase(); 
                } 
            }} disabled={!isPretestComplete} style={{ ...styles.button, background: isPretestComplete ? '#3b82f6' : '#cbd5e1', cursor: isPretestComplete ? 'pointer' : 'not-allowed' }} onMouseOver={(e) => { if(isPretestComplete) e.target.style.background = styles.buttonHover.background; }} onMouseOut={(e) => { if(isPretestComplete) e.target.style.background = styles.button.background; }}>
              {isPretestComplete ? 'æäº¤å¹¶è¿›å…¥ç†Ÿæ‚‰é˜¶æ®µ' : 'è¯·å®Œæˆå¿…ç­”é¢˜'}
            </button>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'familiarization') {
      const isReady = famScrollDone && famClickDone && famTimerDone;
      return (
        <div style={styles.consentContainer}>
          <div style={{...styles.consentBox, maxWidth: '1000px'}}>
            <button onClick={() => setExperimentPhase('pretest')} style={styles.backButton} onMouseOver={(e) => e.currentTarget.style.color = '#3b82f6'} onMouseOut={(e) => e.currentTarget.style.color = '#94a3b8'}>
              <span>â¬…</span> ä¸Šä¸€æ­¥
            </button>
            <h2 style={styles.consentTitle}>ğŸ® å¹³å°æ“ä½œç†Ÿæ‚‰</h2>
            <div style={{ background: '#eff6ff', padding: '1.5rem', borderRadius: '12px', marginBottom: '2rem', color: '#1e40af', border: '1px solid #dbeafe' }}>
              <p><strong>ä»»åŠ¡è¯´æ˜ï¼š</strong> ä¸ºç¡®ä¿å®éªŒæ•°æ®çš„æœ‰æ•ˆæ€§ï¼Œè¯·æ‚¨å®Œæˆä»¥ä¸‹äº¤äº’æµ‹è¯•ï¼š</p>
              <ul style={{ paddingLeft: '1.5rem', marginTop: '0.5rem', lineHeight: 1.8 }}>
                <li>{famScrollDone ? 'âœ… ' : 'â¬œ '} <strong>å·¦ä¾§ï¼š</strong> è¯·åŠ¡å¿…å°†ç†è®ºæ–‡æœ¬<strong>æ»‘åŠ¨åˆ°åº•éƒ¨</strong>ã€‚</li>
                <li>{famClickDone ? 'âœ… ' : 'â¬œ '} <strong>å³ä¾§ï¼š</strong> è¯·ç‚¹å‡»çº¢è‰²çš„æµ‹è¯•æŒ‰é’®ã€‚</li>
                <li>{famTimerDone ? 'âœ… ' : 'â³ '} <strong>é˜…è¯»ï¼š</strong> è¯·ä»”ç»†é˜…è¯»é¡µé¢å†…å®¹ï¼ˆéœ€ç­‰å¾… {15} ç§’ï¼‰ã€‚</li>
              </ul>
            </div>
            <div style={{ border: '2px dashed #cbd5e1', borderRadius: '12px', padding: '1rem', marginBottom: '2.5rem', height: '300px', display: 'flex', overflow: 'hidden', background: '#f8fafc' }}>
              <div style={{ flex: 1, borderRight: '1px dashed #cbd5e1', padding: '1.5rem', overflowY: 'auto', scrollBehavior: 'smooth' }} onScroll={(e) => { const { scrollTop, scrollHeight, clientHeight } = e.currentTarget; if (scrollHeight - scrollTop - clientHeight < 10) { if (!famScrollDone) setFamScrollDone(true); } }}>
                <h4 style={{ fontWeight: 'bold', marginBottom: '0.5rem', color: '#334155' }}>ğŸ“œ ç†è®ºåŒºåŸŸ (ç¤ºä¾‹)</h4>
                {famScrollDone && <p style={{color: '#16a34a', fontSize: '0.8rem', fontWeight: 'bold', marginBottom: '0.5rem'}}>âœ… å·²æ»šåŠ¨åˆ°åº•éƒ¨</p>}
                <p style={{ fontSize: '0.95rem', color: '#64748b', lineHeight: 1.8 }}>
                  <strong>ï¼ˆè¯·å°è¯•åœ¨æ­¤åŒºåŸŸä¸Šä¸‹æ»šåŠ¨é¼ æ ‡æ»šè½®ï¼Œç›´åˆ°æœ€åº•éƒ¨ï¼‰</strong><br/><br/>
                  è‰²å½©å¿ƒç†å­¦æ˜¯ç ”ç©¶è‰²å½©å¯¹äººç±»è¡Œä¸ºå½±å“çš„å­¦ç§‘ã€‚åœ¨è®¾è®¡ä¸­ï¼Œè‰²å½©ä¸ä»…ä»…æ˜¯è£…é¥°ï¼Œå®ƒæ‰¿è½½ç€æƒ…æ„Ÿå’ŒåŠŸèƒ½ã€‚<br/><br/>
                  <strong>1. æš–è‰²è°ƒçš„å½±å“ï¼š</strong><br/>
                  æš–è‰²è°ƒï¼ˆå¦‚çº¢è‰²ã€æ©™è‰²ã€é»„è‰²ï¼‰é€šå¸¸èƒ½å¼•èµ·å…´å¥‹ã€ç´§è¿«æˆ–æ¸©æš–çš„æƒ…ç»ªã€‚ä¾‹å¦‚ï¼Œå¿«é¤åº—å¸¸ä½¿ç”¨çº¢è‰²å’Œé»„è‰²æ¥åˆºæ¿€é£Ÿæ¬²å¹¶åŠ å¿«é¡¾å®¢çš„æµåŠ¨é€Ÿåº¦ã€‚è€Œåœ¨è­¦ç¤ºæ ‡å¿—ä¸­ï¼Œçº¢è‰²åˆ™ç”¨æ¥ä¼ è¾¾å±é™©æˆ–ç¦æ­¢çš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒèƒ½æœ€å¿«åœ°æŠ“ä½äººçš„æ³¨æ„åŠ›ã€‚<br/><br/>
                  <strong>[è¯·ç»§ç»­å‘ä¸‹æ»šåŠ¨...]</strong><br/><br/>
                  <strong>2. å†·è‰²è°ƒçš„å½±å“ï¼š</strong><br/>
                  å†·è‰²è°ƒï¼ˆå¦‚è“è‰²ã€ç»¿è‰²ã€ç´«è‰²ï¼‰åˆ™é€šå¸¸å¸¦ç»™äººå¹³é™ã€ä¸“ä¸šå’Œä¿¡ä»»çš„æ„Ÿå—ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šé“¶è¡Œã€ç§‘æŠ€å…¬å¸ï¼ˆå¦‚IBMã€Facebookï¼‰å’ŒåŒ»ç–—æœºæ„åçˆ±ä½¿ç”¨è“è‰²çš„åŸå› ã€‚ç»¿è‰²åˆ™å¸¸ä¸è‡ªç„¶ã€å¥åº·å’Œç”Ÿé•¿è”ç³»åœ¨ä¸€èµ·ï¼Œå¸¸ç”¨äºç¯ä¿æˆ–æœ‰æœºäº§å“çš„è®¾è®¡ã€‚<br/><br/>
                  <strong>3. ä¸­æ€§è‰²çš„è¿ç”¨ï¼š</strong><br/>
                  é»‘ã€ç™½ã€ç°ç­‰ä¸­æ€§è‰²åœ¨è®¾è®¡ä¸­èµ·ç€å¹³è¡¡å’Œè¡¬æ‰˜çš„ä½œç”¨ã€‚ç™½è‰²é€šå¸¸ä»£è¡¨ç®€æ´ã€çº¯å‡€ï¼ˆå¦‚Appleçš„è®¾è®¡é£æ ¼ï¼‰ï¼Œè€Œé»‘è‰²åˆ™å¸¸ç”¨äºè¡¨ç°é«˜ç«¯ã€ç¥ç§˜æˆ–æƒå¨æ„Ÿã€‚<br/><br/>
                  (æ­å–œæ‚¨ï¼Œæ‚¨å·²æˆåŠŸæ»šåŠ¨åˆ°åº•éƒ¨ï¼)
                </p>
              </div>
              <div style={{ flex: 1, padding: '1.5rem', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center' }}>
                <h4 style={{ fontWeight: 'bold', marginBottom: '1rem', color: '#334155' }}>ğŸ–±ï¸ æ¡ˆä¾‹åŒºåŸŸ (ç¤ºä¾‹)</h4>
                <div style={{ width: '80%', height: '100px', background: '#fee2e2', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '12px', marginBottom: '1.5rem', border: '2px solid #fca5a5' }}>
                  <span style={{ color: '#dc2626', fontWeight: 'bold' }}>çº¢è‰²æŒ‰é’®</span>
                </div>
                <button style={{ padding: '0.75rem 1.5rem', background: famClickDone ? '#dcfce7' : 'white', border: famClickDone ? '1px solid #16a34a' : '1px solid #cbd5e1', color: famClickDone ? '#16a34a' : '#475569', borderRadius: '8px', cursor: 'pointer', boxShadow: '0 2px 4px rgba(0,0,0,0.05)', transition: 'all 0.2s', fontWeight: '600' }} onClick={() => { setFamClickDone(true); alert("äº¤äº’æµ‹è¯•æˆåŠŸï¼æŒ‰é’®åŠŸèƒ½æ­£å¸¸ã€‚"); }}>
                  {famClickDone ? 'âœ… æµ‹è¯•æˆåŠŸ' : 'è¯•ç€ç‚¹å‡»æˆ‘'}
                </button>
              </div>
            </div>
            <div style={{ textAlign: 'center' }}>
              <button onClick={() => { if (isReady) proceedToNextPhase(); }} disabled={!isReady} style={{ ...styles.button, width: 'auto', padding: '1rem 4rem', fontSize: '1.1rem', background: isReady ? '#3b82f6' : '#94a3b8', cursor: isReady ? 'pointer' : 'not-allowed', transition: 'all 0.3s' }}>
                {!famTimerDone ? `è¯·ä»”ç»†é˜…è¯»è¯´æ˜ (${famCountdown}s)` : !famScrollDone ? 'è¯·å…ˆåœ¨å·¦ä¾§åŒºåŸŸæ»‘åŠ¨åˆ°åº•éƒ¨' : !famClickDone ? 'è¯·ç‚¹å‡»å³ä¾§çº¢è‰²æŒ‰é’®æµ‹è¯•' : 'æˆ‘å·²å‡†å¤‡å¥½ï¼Œå¼€å§‹æ­£å¼å­¦ä¹  ğŸš€'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'learning') {
      return (
        <div style={styles.learningContainer}>
          <div style={styles.header}>
            <div style={styles.headerContent}>
              <div style={styles.headerInfo}>
                <div style={styles.infoItem}>
                  <Icon name="user" style={styles.infoIcon} />
                  <span>è¢«è¯•: {participantId}</span>
                </div>
                <div style={styles.infoItem}>
                  <Icon name="clock" style={styles.infoIcon} />
                  <span>
                    {Math.floor(sessionTime / 60)}:{(sessionTime % 60).toString().padStart(2, '0')}
                  </span>
                </div>
                 <div style={styles.infoItem}>
                   <Icon name="wifi" style={{ ...styles.infoIcon, color: isConnected ? '#10b981' : '#9ca3af' }} />
                   <span style={{color: isConnected ? '#10b981' : '#9ca3af', fontSize: '0.8rem'}}>
                     {isConnected ? 'å·²è¿æ¥' : 'è¿æ¥ä¸­...'}
                   </span>
                </div>
                {/* === æ–°å¢ï¼šPupil è¿æ¥çŠ¶æ€æ˜¾ç¤º === */}
                <div style={{
                    ...styles.infoItem,
                    background: pupilStatus === 'connected' ? '#ecfdf5' : pupilStatus === 'connecting' ? '#fff7ed' : '#fef2f2',
                    border: `1px solid ${pupilStatus === 'connected' ? '#a7f3d0' : pupilStatus === 'connecting' ? '#fed7aa' : '#fecaca'}`
                }}>
                   {inputMode === 'mouse' ? (
                       <>
                           <Icon name="mouse" size={16} /> <span style={{fontSize:'0.8rem'}}>æ¨¡å¼: é¼ æ ‡</span>
                       </>
                   ) : (
                       <>
                           <Icon name="pupil" size={16} /> 
                           <span style={{fontSize:'0.8rem', color: pupilStatus === 'connected' ? '#047857' : pupilStatus === 'connecting' ? '#c2410c' : '#b91c1c'}}>
                               Pupil: {pupilStatus === 'connected' ? 'å·²è¿æ¥' : pupilStatus === 'connecting' ? 'è¿æ¥ä¸­...' : 'è¿æ¥æ–­å¼€'}
                           </span>
                           {pupilStatus === 'failed' && (
                               <button 
                                onClick={manualReconnect}
                                style={{
                                    marginLeft: '0.5rem',
                                    padding: '2px 8px',
                                    fontSize: '0.7rem',
                                    background: '#ef4444',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '4px',
                                    cursor: 'pointer'
                                }}
                               >é‡è¿</button>
                           )}
                       </>
                   )}
                </div>
              </div>
            <button
                onClick={() => setShowFinishConfirm(true)} 
                style={{
                  ...styles.button,
                  padding: '0.5rem 1.2rem',
                  fontSize: '0.9rem',
                  width: 'auto',
                  background: '#10b981', 
                  boxShadow: '0 2px 4px rgba(16, 185, 129, 0.2)'
                }}
                onMouseOver={(e) => e.target.style.background = '#059669'}
                onMouseOut={(e) => e.target.style.background = '#10b981'}
              >
                å®Œæˆå­¦ä¹ 
              </button>
            </div>
          </div>
          <div style={styles.taskBar}>
            <Icon name="book" size={18} />
            <span style={{ fontWeight: '600', color: '#1e40af' }}>å½“å‰ä»»åŠ¡ï¼š</span>
            <span>è¯·é˜…è¯»å·¦ä¾§ç†è®ºçŸ¥è¯†ï¼Œå¹¶ç»“åˆå³ä¾§æ¡ˆä¾‹è¿›è¡Œæ·±å…¥ç†è§£ã€‚</span>
          </div>
          <div style={styles.splitLayout}>
            <div style={{ ...styles.panel, ...styles.theoryPanel }} onScroll={handleScroll} onMouseMove={(e) => handleMouseMove(e, 'theory')}>
              <div style={styles.panelContent}>
                <h1 style={styles.panelTitle}>ğŸ“š äº¤äº’è®¾è®¡åŸºç¡€ï¼šå¯ä¾›æ€§ï¼ˆAffordanceï¼‰ç†è®º</h1>
                <div style={{ lineHeight: 1.9, color: '#334155', fontSize: '1.05rem' }}>
                  
                  <div onMouseEnter={() => handleInteraction("1. æ¦‚å¿µèµ·æº (Gibson)", "gibson")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>1. æ¦‚å¿µèµ·æºä¸ç”Ÿæ€å¿ƒç†å­¦å®šä¹‰</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>â€œå¯ä¾›æ€§â€ï¼ˆAffordanceï¼‰è¿™ä¸€æ¦‚å¿µæœ€æ—©ç”±ç¾å›½ç”Ÿæ€å¿ƒç†å­¦å®¶ <strong>James J. Gibson</strong> åœ¨å…¶1977å¹´çš„è‘—ä½œã€Šè§†è§‰æ„ŸçŸ¥çš„ç”Ÿæ€å­¦æ–¹æ³•ã€‹ä¸­æå‡ºã€‚Gibson åˆ›é€ è¿™ä¸ªè¯æ˜¯ä¸ºäº†æè¿°ç¯å¢ƒä¸åŠ¨ç‰©ä¹‹é—´çš„äº’è¡¥å…³ç³»ã€‚åœ¨ä»–çœ‹æ¥ï¼Œå¯ä¾›æ€§æ˜¯ç¯å¢ƒä¸ºåŠ¨ç‰©æä¾›çš„â€œè¡ŒåŠ¨å¯èƒ½æ€§â€ï¼Œæ— è®ºè¿™ç§å¯èƒ½æ€§æ˜¯å¥½æ˜¯åã€‚</p>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>ä¾‹å¦‚ï¼Œå¯¹äºäººç±»è€Œè¨€ï¼Œä¸€å—å¹³å¦åšç¡¬çš„åœ°é¢æä¾›äº†â€œè¡Œèµ°â€çš„å¯ä¾›æ€§ï¼›ä¸€æŠŠé½è†é«˜çš„æ¤…å­æä¾›äº†â€œåä¸‹â€çš„å¯ä¾›æ€§ï¼›è€Œä¸€å—å°çŸ³å¤´åˆ™æä¾›äº†â€œæŠ•æ·â€çš„å¯ä¾›æ€§ã€‚Gibson å¼ºè°ƒï¼Œå¯ä¾›æ€§æ˜¯å®¢è§‚å­˜åœ¨çš„ç‰©ç†å±æ€§ï¼Œå®ƒç‹¬ç«‹äºè§‚å¯Ÿè€…çš„æ„ŸçŸ¥â€”â€”å³æ— è®ºä½ æ˜¯å¦çœ‹åˆ°é‚£æŠŠæ¤…å­ï¼Œå®ƒå®¢è§‚ä¸Šéƒ½å…·å¤‡è®©äººåçš„åŠŸèƒ½ã€‚è¿™ä¸€è§‚ç‚¹å¼ºè°ƒäº†ç¯å¢ƒå±æ€§ä¸ç”Ÿç‰©ä½“èƒ½åŠ›çš„ç›´æ¥å¯¹åº”å…³ç³»ã€‚</p>
                  </div>

                  <div onMouseEnter={() => handleInteraction("2. Normançš„ä¿®æ­£ (æ„ŸçŸ¥)", "norman")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>2. è®¾è®¡é¢†åŸŸçš„å¼•å…¥ï¼šå”çº³å¾·Â·è¯ºæ›¼çš„ä¿®æ­£</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>1988å¹´ï¼Œè®¤çŸ¥ç§‘å­¦å®¶ <strong>Donald Norman</strong> åœ¨å…¶ç»å…¸è‘—ä½œã€Šè®¾è®¡å¿ƒç†å­¦ã€‹ï¼ˆThe Design of Everyday Thingsï¼‰ä¸­å°†è¿™ä¸€æ¦‚å¿µå¼•å…¥äº†äººæœºäº¤äº’ä¸å·¥ä¸šè®¾è®¡é¢†åŸŸã€‚ç„¶è€Œï¼ŒNorman å¯¹ Gibson çš„åŸå§‹å®šä¹‰è¿›è¡Œäº†å…³é”®æ€§çš„ä¿®æ­£ï¼Œä»–æå‡ºåœ¨è®¾è®¡ä¸­æ›´é‡è¦çš„æ˜¯<strong>â€œæ„ŸçŸ¥å¯ä¾›æ€§â€ï¼ˆPerceived Affordanceï¼‰</strong>ã€‚</p>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>åœ¨è®¾è®¡è¯­å¢ƒä¸‹ï¼Œå¦‚æœä¸€ä¸ªç‰©ä½“åœ¨ç‰©ç†ä¸Šèƒ½å¤Ÿè¢«æ“ä½œï¼ˆä¾‹å¦‚ä¸€ä¸ªå¯ä»¥ç‚¹å‡»çš„æŒ‰é’®ï¼‰ï¼Œä½†ç”¨æˆ·åœ¨è§†è§‰ä¸Šæ— æ³•æ„ŸçŸ¥åˆ°å®ƒæ˜¯å¯ä»¥ç‚¹å‡»çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªè®¾è®¡å°±æ˜¯å¤±è´¥çš„ã€‚Norman è®¤ä¸ºï¼Œè®¾è®¡å¸ˆçš„èŒè´£ä¸ä»…ä»…æ˜¯åˆ›é€ åŠŸèƒ½ï¼Œæ›´é‡è¦çš„æ˜¯é€šè¿‡è§†è§‰çº¿ç´¢è®©ç”¨æˆ·â€œæ„ŸçŸ¥â€åˆ°è¿™äº›åŠŸèƒ½ã€‚å› æ­¤ï¼Œåœ¨äº¤äº’è®¾è®¡ä¸­ï¼Œå½“æˆ‘ä»¬è°ˆè®ºå¯ä¾›æ€§æ—¶ï¼Œé€šå¸¸æŒ‡çš„æ˜¯â€œæ„ŸçŸ¥åˆ°çš„å¯ä¾›æ€§â€ã€‚</p>
                  </div>

                  <div onMouseEnter={() => handleInteraction("3. å¯ä¾›æ€§ vs æ„ç¬¦", "signifier")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>3. å…³é”®åŒºåˆ†ï¼šå¯ä¾›æ€§ vs. æ„ç¬¦ (Signifiers)</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>éšç€è§¦å±è®¾å¤‡å’Œæ‰å¹³åŒ–è®¾è®¡çš„å…´èµ·ï¼Œå•çº¯ä¾é ç‰©ç†ç‰¹å¾æ¥ä¼ è¾¾åŠŸèƒ½å˜å¾—è¶Šæ¥è¶Šå›°éš¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸€æ··æ·†ï¼ŒNorman åœ¨å…¶ä¹¦çš„ä¿®è®¢ç‰ˆä¸­è¿›ä¸€æ­¥åŒºåˆ†äº†â€œå¯ä¾›æ€§â€å’Œâ€œæ„ç¬¦â€ã€‚è¿™æ˜¯ç†è§£ç°ä»£ç•Œé¢è®¾è®¡çš„å…³é”®ï¼š</p>
                    <ul style={{ paddingLeft: '2rem', marginBottom: '1.2rem', listStyleType: 'disc' }}>
                        <li style={{ marginBottom: '0.8rem' }}><strong>å¯ä¾›æ€§ï¼ˆAffordanceï¼‰ï¼š</strong> æ˜¯å¯èƒ½çš„æ“ä½œæœ¬èº«ã€‚ä¾‹å¦‚ï¼Œæ‰‹æœºå±å¹•æœ¬èº«æä¾›äº†â€œè§¦æ‘¸â€çš„å¯ä¾›æ€§ï¼Œä½ å¯ä»¥ç‚¹å‡»å±å¹•çš„ä»»ä½•ä½ç½®ã€‚</li>
                        <li style={{ marginBottom: '0.8rem' }}><strong>æ„ç¬¦ï¼ˆSignifiersï¼‰ï¼š</strong> æ˜¯æç¤ºæ“ä½œçš„ä¿¡å·æˆ–æ ‡è®°ã€‚ä¾‹å¦‚ï¼Œå±å¹•ä¸Šçš„ä¸€ä¸ªè“è‰²çŸ©å½¢æ¡†ã€ä¸€ä¸ªä¸‹åˆ’çº¿æ–‡æœ¬ã€æˆ–è€…ä¸€ä¸ªå‘å³çš„ç®­å¤´ã€‚è¿™äº›è§†è§‰å…ƒç´ å‘Šè¯‰ç”¨æˆ·ï¼šâ€œå¦‚æœä½ åœ¨è¿™é‡Œç‚¹å‡»ï¼Œä¼šå‘ç”Ÿç‰¹å®šçš„äº‹æƒ…â€ã€‚</li>
                    </ul>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>åœ¨æ•°å­—ç•Œé¢è®¾è®¡ä¸­ï¼Œè®¾è®¡å¸ˆå®é™…ä¸Šæ˜¯åœ¨æ„å»ºâ€œæ„ç¬¦â€æ¥æš—ç¤ºåº•å±‚çš„â€œå¯ä¾›æ€§â€ã€‚å¦‚æœæ„ç¬¦ç¼ºå¤±æˆ–è¯¯å¯¼ï¼Œç”¨æˆ·å°±ä¼šæ„Ÿåˆ°å›°æƒ‘ã€‚</p>
                  </div>

                  <div onMouseEnter={() => handleInteraction("4. GaverçŸ©é˜µåˆ†ç±»", "gaver")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>4. Gaver çš„å¯ä¾›æ€§åˆ†ç±»çŸ©é˜µ</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>William Gaver è¿›ä¸€æ­¥å°†å¯ä¾›æ€§ç»†åˆ†ä¸ºå››ç§ç±»å‹ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»¬åˆ†æç•Œé¢ä¸­çš„å¯ç”¨æ€§é—®é¢˜ï¼š</p>
                    <div style={{ background: '#f1f5f9', padding: '1.5rem', borderRadius: '12px', borderLeft: '4px solid #94a3b8', marginBottom: '1.5rem' }}>
                        <ul style={{ paddingLeft: '1.5rem', marginBottom: '0' }}>
                        <li style={{ marginBottom: '0.8rem' }}><strong>æ˜¾æ€§å¯ä¾›æ€§ (Perceptible Affordance)ï¼š</strong> åŠŸèƒ½å­˜åœ¨ä¸”ä¿¡æ¯å¯è§ã€‚è¿™æ˜¯æœ€ç†æƒ³çš„è®¾è®¡çŠ¶æ€ï¼ˆå¦‚ï¼šæœ‰ç«‹ä½“æ„Ÿçš„æŒ‰é’®ï¼‰ã€‚</li>
                        <li style={{ marginBottom: '0.8rem' }}><strong>è™šå‡å¯ä¾›æ€§ (False Affordance)ï¼š</strong> ä¿¡æ¯å¯è§ä½†åŠŸèƒ½ä¸å­˜åœ¨ã€‚è¿™æ˜¯è®¾è®¡çš„é™·é˜±ï¼ˆå¦‚ï¼šçœ‹èµ·æ¥åƒæŒ‰é’®çš„è£…é¥°å›¾ç‰‡ï¼Œç‚¹å‡»æ— æ•ˆï¼‰ã€‚</li>
                        <li style={{ marginBottom: '0.8rem' }}><strong>éšè—å¯ä¾›æ€§ (Hidden Affordance)ï¼š</strong> åŠŸèƒ½å­˜åœ¨ä½†ä¿¡æ¯ä¸å¯è§ã€‚è¿™éœ€è¦ç”¨æˆ·æ¢ç´¢æˆ–è®°å¿†ï¼ˆå¦‚ï¼šä¸‹æ‹‰åˆ·æ–°ã€éšè—çš„æ‰‹åŠ¿æ“ä½œï¼‰ã€‚</li>
                        <li style={{ marginBottom: '0.5rem' }}><strong>æ­£ç¡®æ‹’ç» (Correct Rejection)ï¼š</strong> åŠŸèƒ½ä¸å­˜åœ¨ä¸”ä¿¡æ¯ä¸å¯è§ã€‚è¿™é¿å…äº†ç”¨æˆ·çš„è¯¯æ“ä½œã€‚</li>
                        </ul>
                    </div>
                  </div>

                  <div onMouseEnter={() => handleInteraction("5. è§†è§‰çº¿ç´¢åº”ç”¨", "cues")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>5. æ•°å­—ç•Œé¢ä¸­çš„è§†è§‰çº¿ç´¢åº”ç”¨</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>åœ¨ç°ä»£ UI/UX è®¾è®¡ä¸­ï¼Œä¸ºäº†å®ç°æ˜¾æ€§å¯ä¾›æ€§ï¼Œè®¾è®¡å¸ˆé€šå¸¸åˆ©ç”¨ä»¥ä¸‹è§†è§‰å±æ€§æ¥æ¨¡æ‹Ÿç‰©ç†ä¸–ç•Œçš„éšå–»ï¼š</p>
                    <p style={{ marginBottom: '0.8rem' }}><strong>(1) æè´¨ä¸é˜´å½± (Material & Shadow)ï¼š</strong><br/>å€Ÿé‰´ç‰©ç†å…‰å­¦åŸç†ï¼Œé€šè¿‡æŠ•å°„é˜´å½±ï¼ˆDrop Shadowï¼‰ä½¿å…ƒç´ åœ¨Zè½´ä¸Šæµ®èµ·ï¼Œæš—ç¤ºå…¶å¯ä»¥è¢«æŒ‰å‹ã€‚Material Design æ˜¯è¿™ä¸€ç†å¿µçš„å…¸å‹ä»£è¡¨ã€‚</p>
                    <p style={{ marginBottom: '0.8rem' }}><strong>(2) å½¢çŠ¶ä¸åœ†è§’ (Shape & Radius)ï¼š</strong><br/>åœ†è§’çŸ©å½¢æ¯”ç›´è§’çŸ©å½¢æ›´åƒæ˜¯ä¸€ä¸ªå¯ä»¥æ“ä½œçš„å®ä½“â€œç‰©ä½“â€ï¼Œå› æ­¤å¸¸è¢«ç”¨äºæŒ‰é’®å’Œå¡ç‰‡è®¾è®¡ã€‚å®Œå…¨çš„åœ†å½¢é€šå¸¸æš—ç¤ºå®ƒæ˜¯å¤´åƒæˆ–å•é€‰æŒ‰é’®ã€‚</p>
                    <p style={{ marginBottom: '0.8rem' }}><strong>(3) çŠ¶æ€å˜åŒ– (State Change)ï¼š</strong><br/>å½“é¼ æ ‡æ‚¬åœï¼ˆHoverï¼‰æˆ–ç‚¹å‡»ï¼ˆActiveï¼‰æ—¶ï¼Œå…ƒç´ åº”å½“ç«‹å³å‘ç”Ÿé¢œè‰²æˆ–ä½ç½®çš„å˜åŒ–ã€‚è¿™ç§å³æ—¶åé¦ˆç¡®è®¤äº†å¯ä¾›æ€§çš„å­˜åœ¨ï¼Œå¢å¼ºäº†ç”¨æˆ·çš„æ§åˆ¶æ„Ÿã€‚</p>
                    <p style={{ marginBottom: '1.2rem' }}><strong>(4) æƒ¯ä¾‹ä¸éšå–» (Convention)ï¼š</strong><br/>æœ‰äº›å¯ä¾›æ€§æ˜¯åŸºäºä¹ å¾—çš„æƒ¯ä¾‹ã€‚ä¾‹å¦‚ï¼Œæ”¾å¤§é•œå›¾æ ‡ä»£è¡¨â€œæœç´¢â€ï¼Œæ±‰å ¡èœå•ï¼ˆä¸‰æ¡æ¨ªçº¿ï¼‰ä»£è¡¨â€œæ›´å¤šé€‰é¡¹â€ã€‚è™½ç„¶å®ƒä»¬åœ¨ç‰©ç†ä¸Šæ²¡æœ‰å¯¹åº”ç‰©ï¼Œä½†å·²æˆä¸ºæ•°å­—ä¸–ç•Œçš„é€šç”¨è¯­è¨€ã€‚</p>
                  </div>

                  <div onMouseEnter={() => handleInteraction("6. æ‰å¹³åŒ–è®¾è®¡åæ€", "flat")}>
                    <h3 style={{fontSize: '1.25rem', fontWeight: '700', color: '#1e293b', marginTop: '2rem', marginBottom: '0.8rem'}}>6. æ‰å¹³åŒ–è®¾è®¡çš„æŒ‘æˆ˜ä¸åæ€</h3>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>2010å¹´ä»£åˆå…´èµ·çš„â€œæ‰å¹³åŒ–è®¾è®¡â€ï¼ˆFlat Designï¼‰è™½ç„¶å¸¦æ¥äº†æç®€çš„ç¾å­¦ï¼Œä½†ä¹Ÿå¼•å‘äº†â€œå¯ä¾›æ€§å±æœºâ€ã€‚å»é™¤äº†é˜´å½±ã€çº¹ç†å’Œæ¸å˜åï¼Œç”¨æˆ·å¾€å¾€éš¾ä»¥åŒºåˆ†å“ªäº›æ˜¯æ–‡æœ¬ï¼Œå“ªäº›æ˜¯æŒ‰é’®ã€‚</p>
                    <p style={{ marginBottom: '1.2rem', textIndent: '2em' }}>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œç°ä»£è®¾è®¡æ¼”å˜ä¸ºâ€œæ‰å¹³åŒ– 2.0â€æˆ–â€œæ–°æ‹Ÿç‰©åŒ–â€ï¼Œå³åœ¨ä¿æŒç®€æ´çš„åŒæ—¶ï¼Œé‡æ–°å¼•å…¥å¾®å¦™çš„é˜´å½±å’Œå±‚çº§å…³ç³»ï¼Œä»¥ç¡®ä¿å¯ä¾›æ€§çš„æ¸…æ™°è¡¨è¾¾ã€‚è¿™ä¸€æ¼”å˜è¿‡ç¨‹æ·±åˆ»è¯´æ˜äº†å¯ä¾›æ€§åœ¨äººæœºäº¤äº’æ•ˆç‡ä¸­çš„å†³å®šæ€§ä½œç”¨ã€‚</p>
                  </div>

                  <div style={{ marginTop: '4rem', padding: '2rem', background: '#eff6ff', borderRadius: '12px', textAlign: 'center', color: '#1d4ed8', fontSize: '1rem', border: '1px dashed #bfdbfe' }}>
                    <strong style={{ fontSize: '1.2rem', display: 'block', marginBottom: '0.5rem' }}>ğŸ‰ æ­å–œï¼æ‚¨å·²å®Œæˆæ‰€æœ‰ç†è®ºå†…å®¹çš„é˜…è¯»ã€‚</strong>ç°åœ¨ï¼Œè¯·ç»“åˆå³ä¾§çš„æ¡ˆä¾‹ï¼Œæ€è€ƒä¸Šè¿°ç†è®ºï¼ˆç‰¹åˆ«æ˜¯â€œæ˜¾æ€§å¯ä¾›æ€§â€ä¸â€œè™šå‡å¯ä¾›æ€§â€ï¼‰æ˜¯å¦‚ä½•åœ¨å®é™…è®¾è®¡ä¸­ä½“ç°çš„ã€‚
                  </div>
                </div>
              </div>
            </div>
            <div style={{ ...styles.panel, ...styles.casePanel }} onMouseMove={(e) => handleMouseMove(e, 'case')}>
              <div style={styles.panelContent}>
                <h2 style={styles.panelTitle}>ğŸ–¼ï¸ æ¡ˆä¾‹ç ”ç©¶ï¼šå¯ä¾›æ€§çš„å®é™…åº”ç”¨</h2>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '2.5rem' }}>
                  <div onMouseEnter={() => handleInteraction("æ¡ˆä¾‹1: é—¨æŠŠæ‰‹å¯¹æ¯”", "case_handle")}>
                    <h3 style={{ fontSize: '1.1rem', fontWeight: '700', color: '#475569', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>æ¡ˆä¾‹1ï¼šé—¨æŠŠæ‰‹è®¾è®¡å¯¹æ¯”</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                      <div style={{ border: '2px solid #22c55e', borderRadius: '12px', padding: '1.5rem', background: '#f0fdf4' }}>
                        <div style={{ height: '12rem', borderRadius: '8px', overflow: 'hidden', marginBottom: '1rem', border: '1px solid #d1d5db' }}>
                          <img src="handle-good.jpg" alt="è‰¯å¥½è®¾è®¡ï¼šæ¸…æ™°çš„æŠŠæ‰‹" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        </div>
                        <p style={{ fontWeight: '700', color: '#15803d', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="check" size={16}/> è‰¯å¥½è®¾è®¡</p>
                        <p style={{ fontSize: '0.9rem', color: '#334155', lineHeight: 1.6 }}><strong>æ˜¾æ€§å¯ä¾›æ€§ï¼š</strong>æ¨ªå‘æŠŠæ‰‹é€šè¿‡å…¶ç‰©ç†å½¢çŠ¶ï¼ˆå‡¸èµ·ã€ä¾¿äºæŠ“æ¡ï¼‰æ¸…æ™°åœ°æä¾›äº†â€œæ‹‰â€çš„è§†è§‰çº¿ç´¢ï¼Œç”¨æˆ·æ— éœ€æ€è€ƒå³å¯æ“ä½œã€‚</p>
                      </div>
                      <div style={{ border: '2px solid #ef4444', borderRadius: '12px', padding: '1.5rem', background: '#fef2f2' }}>
                        <div style={{ height: '12rem', borderRadius: '8px', overflow: 'hidden', marginBottom: '1rem', border: '1px solid #d1d5db' }}>
                          <img src="handle-bad.jpg" alt="ç³Ÿç³•è®¾è®¡ï¼šå¹³æ¿é—¨" style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                        </div>
                        <p style={{ fontWeight: '700', color: '#b91c1c', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="close" size={16}/> ç³Ÿç³•è®¾è®¡</p>
                        <p style={{ fontSize: '0.9rem', color: '#334155', lineHeight: 1.6 }}><strong>éšè—/è™šå‡å¯ä¾›æ€§ï¼š</strong>å¹³æ¿è®¾è®¡ç¼ºä¹â€œæ¨â€æˆ–â€œæ‹‰â€çš„æ„ç¬¦ã€‚å¦‚æœæ²¡æœ‰æ–‡å­—è¯´æ˜ï¼Œç”¨æˆ·å¾ˆéš¾åˆ¤æ–­è¯¥å¦‚ä½•æ“ä½œï¼Œå¢åŠ äº†è®¤çŸ¥è´Ÿè·ã€‚</p>
                      </div>
                    </div>
                  </div>
                  
                  <div onMouseEnter={() => handleInteraction("æ¡ˆä¾‹2: æŒ‰é’®è®¾è®¡", "case_button")}>
                    <h3 style={{ fontSize: '1.1rem', fontWeight: '700', color: '#475569', marginBottom: '1rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>æ¡ˆä¾‹2ï¼šç•Œé¢æŒ‰é’®è®¾è®¡</h3>
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1.5rem' }}>
                      <div style={{ border: '2px solid #22c55e', borderRadius: '12px', padding: '1.5rem', background: '#f0fdf4' }}>
                        <div style={{ background: 'white', height: '8rem', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '1rem', boxShadow: '0 2px 6px rgba(0,0,0,0.05)' }}>
                          <button style={{ background: '#3b82f6', color: 'white', padding: '0.8rem 2rem', borderRadius: '6px', border: 'none', fontWeight: '600', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)', cursor: 'pointer' }}>ç‚¹å‡»æˆ‘</button>
                        </div>
                        <p style={{ fontWeight: '700', color: '#15803d', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="check" size={16}/> è‰¯å¥½è®¾è®¡</p>
                        <p style={{ fontSize: '0.9rem', color: '#334155' }}>æ˜æ˜¾çš„é˜´å½±å’Œåœ†è§’æ¸…æ™°ä¼ è¾¾äº†"å¯ç‚¹å‡»"çš„å¯ä¾›æ€§ã€‚</p>
                      </div>
                      <div style={{ border: '2px solid #ef4444', borderRadius: '12px', padding: '1.5rem', background: '#fef2f2' }}>
                        <div style={{ background: 'white', height: '8rem', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '1rem', boxShadow: '0 2px 6px rgba(0,0,0,0.05)' }}>
                          <span style={{ color: '#94a3b8', padding: '0.8rem 2rem' }}>ç‚¹å‡»æˆ‘</span>
                        </div>
                        <p style={{ fontWeight: '700', color: '#b91c1c', marginBottom: '0.5rem', display: 'flex', alignItems: 'center', gap: '0.5rem' }}><Icon name="close" size={16}/> ç³Ÿç³•è®¾è®¡</p>
                        <p style={{ fontSize: '0.9rem', color: '#334155' }}>ç¼ºä¹è§†è§‰çº¿ç´¢ï¼ˆæ— è¾¹æ¡†ã€æ— é˜´å½±ï¼‰ï¼Œç”¨æˆ·éš¾ä»¥è¯†åˆ«å…¶åŠŸèƒ½ã€‚</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {showFinishConfirm && (
            <div style={styles.modalOverlay}>
              <div style={{ ...styles.modal, maxWidth: '400px', textAlign: 'center', padding: '2rem' }}>
                  <div style={{ fontSize: '3.5rem', marginBottom: '1rem' }}>ğŸ¤”</div>
                  <h3 style={{ fontSize: '1.5rem', fontWeight: 'bold', color: '#1e293b', marginBottom: '1rem' }}>
                    ç¡®è®¤å®Œæˆå­¦ä¹ ï¼Ÿ
                  </h3>
                  <p style={{ color: '#64748b', lineHeight: 1.6, marginBottom: '2rem' }}>
                    è¯·ç¡®ä¿æ‚¨å·²ç»<strong>ä»”ç»†é˜…è¯»</strong>äº†å·¦ä¾§çš„ç†è®ºçŸ¥è¯†ï¼Œå¹¶<strong>æ·±å…¥ç†è§£</strong>äº†å³ä¾§çš„æ¡ˆä¾‹å¯¹æ¯”ã€‚<br/>
                    <span style={{ fontSize: '0.85rem', color: '#94a3b8', marginTop: '0.5rem', display: 'block' }}>(ä¸€æ—¦å®Œæˆå­¦ä¹ ï¼Œå°†æ— æ³•è¿”å›æŸ¥çœ‹å†…å®¹)</span>
                  </p>
                  
                  <div style={{ display: 'flex', gap: '1rem', justifyContent: 'center' }}>
                    <button
                      onClick={() => setShowFinishConfirm(false)}
                      style={{
                        ...styles.button,
                        background: 'white',
                        color: '#475569',
                        border: '1px solid #e2e8f0',
                        boxShadow: 'none'
                      }}
                      onMouseOver={(e) => e.target.style.background = '#f8fafc'}
                      onMouseOut={(e) => e.target.style.background = 'white'}
                    >
                      è¿”å›ç»§ç»­å­¦ä¹ 
                    </button>
                    
                    <button
                      onClick={() => {
                        setShowFinishConfirm(false);
                        proceedToNextPhase(); 
                      }}
                      style={{ ...styles.button, background: '#10b981', border: 'none', color: 'white' }} 
                      onMouseOver={(e) => e.target.style.background = '#059669'}
                      onMouseOut={(e) => e.target.style.background = '#10b981'}
                    >
                      ç¡®è®¤å®Œæˆ
                    </button>
                  </div>
              </div>
            </div>
          )}

          {showLearningGuide && (
            <div style={styles.modalOverlay}>
              <div style={styles.modal}>
                <div style={styles.modalHeader}>
                  <h3 style={styles.modalTitle}><Icon name="target" /> æ­£å¼å­¦ä¹ ä»»åŠ¡è¯´æ˜</h3>
                </div>
                <div style={styles.modalContent}>
                  <div style={{ lineHeight: 1.8, color: '#334155', fontSize: '1rem' }}>
                    <p style={{ marginBottom: '1.5rem' }}>æœ¬ç•Œé¢åˆ†ä¸ºå·¦å³ä¸¤ä¸ªä¸»è¦åŒºåŸŸï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡Œå­¦ä¹ ï¼š</p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '1.2rem', marginBottom: '1.5rem' }}>
                      <div style={{ display: 'flex', gap: '1rem', alignItems: 'start', background: '#eff6ff', padding: '1.2rem', borderRadius: '12px', border: '1px solid #dbeafe' }}>
                        <div style={{ background: '#3b82f6', color: 'white', padding: '0.2rem 0.6rem', borderRadius: '6px', fontSize: '0.85rem', fontWeight: 'bold', whiteSpace: 'nowrap', height: 'fit-content' }}>å·¦ä¾§åŒºåŸŸ</div>
                        <div>
                          <strong style={{ display: 'block', marginBottom: '0.3rem', color: '#1e3a8a', fontSize: '1.05rem' }}>ğŸ“– ç†è®ºçŸ¥è¯†æ–‡æœ¬</strong>
                          <span style={{ fontSize: '0.95rem', color: '#475569' }}>è¿™é‡Œè¯¦ç»†ä»‹ç»äº†â€œå¯ä¾›æ€§â€çš„æ ¸å¿ƒæ¦‚å¿µã€å®šä¹‰åŠç‰¹å¾ã€‚æ‚¨å¯ä»¥ä¸Šä¸‹æ»šåŠ¨é˜…è¯»å®Œæ•´å†…å®¹ã€‚</span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '1rem', alignItems: 'start', background: '#f0fdf4', padding: '1.2rem', borderRadius: '12px', border: '1px solid #bbf7d0' }}>
                        <div style={{ background: '#22c55e', color: 'white', padding: '0.2rem 0.6rem', borderRadius: '6px', fontSize: '0.85rem', fontWeight: 'bold', whiteSpace: 'nowrap', height: 'fit-content' }}>å³ä¾§åŒºåŸŸ</div>
                        <div>
                          <strong style={{ display: 'block', marginBottom: '0.3rem', color: '#14532d', fontSize: '1.05rem' }}>ğŸ–¼ï¸ å…·ä½“è®¾è®¡æ¡ˆä¾‹</strong>
                          <span style={{ fontSize: '0.95rem', color: '#475569' }}>è¿™é‡Œå±•ç¤ºäº†é—¨æŠŠæ‰‹å’Œç•Œé¢æŒ‰é’®çš„å®é™…åº”ç”¨æ¡ˆä¾‹ï¼ŒåŒ…å«è‰¯å¥½è®¾è®¡ä¸ç³Ÿç³•è®¾è®¡çš„å¯¹æ¯”ã€‚</span>
                        </div>
                      </div>
                      <div style={{ display: 'flex', gap: '1rem', alignItems: 'start', background: '#fff7ed', padding: '1.2rem', borderRadius: '12px', border: '1px dashed #f97316' }}>
                        <div style={{ fontSize: '1.5rem' }}>ğŸ’¡</div>
                        <div>
                          <strong style={{ display: 'block', marginBottom: '0.3rem', color: '#9a3412', fontSize: '1.05rem' }}>æ ¸å¿ƒå­¦ä¹ ä»»åŠ¡</strong>
                          <span style={{ fontSize: '0.95rem', color: '#9a3412' }}>è¯·ä¸è¦å­¤ç«‹åœ°é˜…è¯»ã€‚æ‚¨çš„ç›®æ ‡æ˜¯å°†<strong>å·¦ä¾§çš„æŠ½è±¡ç†è®º</strong>ä¸<strong>å³ä¾§çš„å…·ä½“æ¡ˆä¾‹</strong>è”ç³»èµ·æ¥ï¼Œæ€è€ƒç†è®ºæ˜¯å¦‚ä½•åœ¨è¿™äº›æ¡ˆä¾‹ä¸­ä½“ç°çš„ã€‚</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div style={styles.modalFooter}>
                  <button onClick={() => setShowLearningGuide(false)} style={{ ...styles.button, width: '100%' }}>æˆ‘æ˜ç™½äº†ï¼Œå¼€å§‹å­¦ä¹  ğŸš€</button>
                </div>
              </div>
            </div>
          )}
          {showFeedback && (
            <div style={styles.modalOverlay}>
              <div style={styles.modal}>
                <div style={styles.modalHeader}>
                  <h3 style={styles.modalTitle}>
                    {CONTENT_FEEDBACK_MAP[currentContentBlock]?.levels?.[feedbackLevel]?.title || "æ™ºèƒ½æç¤º"}
                  </h3>
                  <button onClick={() => setShowFeedback(false)} style={styles.closeButton}><Icon name="close" /></button>
                </div>
                <div style={styles.modalContent}>
                  <div style={{ background: '#eff6ff', borderLeft: '4px solid #3b82f6', padding: '1.5rem', borderRadius: '0 8px 8px 0' }}>
                    <p style={{ color: '#1e40af', lineHeight: 1.6, fontSize: '1.05rem' }}>{feedbackContent}</p>
                  </div>
                </div>
                <div style={styles.modalFooter}>
                  <button onClick={() => setShowFeedback(false)} style={{ ...styles.button, width: 'auto', padding: '0.6rem 1.5rem' }}>çŸ¥é“äº†</button>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    if (experimentPhase === 'posttest') {
      const isAllAnswered = POSTTEST_MCQ_QUESTIONS.every(q => {
        const answer = mcqAnswers[q.id];
        if (q.type === 'multi') {
          return Array.isArray(answer) && answer.length > 0;
        }
        return answer !== undefined;
      });
      
      const isShortAnswerFilled = shortAnswer.trim().length >= 10;
      const isTimeUp = postTestTimeLeft === 0;

      const canSubmit = isAllAnswered && isShortAnswerFilled && isTimeUp;

      const handleMultiSelect = (qId, optIdx) => {
        const current = mcqAnswers[qId] || [];
        let updated;
        if (current.includes(optIdx)) {
          updated = current.filter(i => i !== optIdx); 
        } else {
          updated = [...current, optIdx]; 
        }
        setMcqAnswers(prev => ({ ...prev, [qId]: updated }));
      };

      return (
        <div style={styles.learningContainer}>
          <div style={styles.header}>
            <div style={styles.headerContent}>
              <div style={styles.headerInfo}>
                <div style={styles.infoItem}>
                  <Icon name="user" style={styles.infoIcon} />
                  <span>è¢«è¯•: {participantId}</span>
                </div>
                <div style={styles.infoItem}>
                  <Icon name="clock" style={styles.infoIcon} />
                  <span>
                    {Math.floor(sessionTime / 60)}:{(sessionTime % 60).toString().padStart(2, '0')}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <div style={styles.consentContainer}> 
            <div style={styles.consentBox}>
              <div style={{ 
                position: 'sticky', 
                top: 0, 
                background: 'rgba(255,255,255,0.95)', 
                backdropFilter: 'blur(8px)',
                padding: '1.5rem 0', 
                borderBottom: '1px solid #e5e7eb', 
                marginBottom: '2rem', 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center',
                zIndex: 10
              }}>
                <h2 style={{ margin: 0, fontSize: '1.8rem', color: '#1e293b', fontWeight: '800' }}>âœï¸ å­¦ä¹ è¯„ä¼°</h2>
                <div style={{ 
                  background: isTimeUp ? '#dcfce7' : '#fff7ed', 
                  color: isTimeUp ? '#166534' : '#c2410c', 
                  padding: '0.5rem 1rem', 
                  borderRadius: '20px', 
                  fontWeight: 'bold', 
                  fontSize: '0.9rem',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '0.5rem',
                  border: isTimeUp ? '1px solid #bbf7d0' : '1px solid #fed7aa'
                }}>
                  <Icon name="clock" size={16} />
                  {isTimeUp ? 'ä½œç­”æ—¶é—´å·²æ»¡è¶³' : `æœ€å°‘ä½œç­”æ—¶é—´å‰©ä½™: ${Math.floor(postTestTimeLeft / 60)}åˆ† ${(postTestTimeLeft % 60).toString().padStart(2, '0')}ç§’`}
                </div>
              </div>
              
              <div style={{ marginBottom: '2rem' }}>
                <h3 style={{ fontSize: '1.4rem', fontWeight: '700', color: '#334155', marginBottom: '1.5rem' }}>ä¸€ã€çŸ¥è¯†æµ‹éªŒï¼ˆå…±10é¢˜ï¼‰<span style={{fontSize:'0.9rem', color:'#ef4444', fontWeight:'normal'}}>*</span></h3>
                
                {POSTTEST_MCQ_QUESTIONS.map((q, idx) => (
                  <div key={q.id} style={{ marginBottom: '1.5rem', padding: '1.5rem', background: '#f8fafc', borderRadius: '12px', borderLeft: (mcqAnswers[q.id] === undefined || (Array.isArray(mcqAnswers[q.id]) && mcqAnswers[q.id].length === 0)) ? '4px solid #cbd5e1' : '4px solid #10b981', boxShadow: '0 1px 2px rgba(0,0,0,0.05)' }}>
                    <p style={{ fontWeight: '600', color: '#1e293b', marginBottom: '1rem', fontSize: '1.05rem' }}>
                      {q.question} 
                      <span style={{ fontSize: '0.8rem', color: q.type === 'multi' ? '#3b82f6' : '#64748b', fontWeight: 'bold', marginLeft: '0.8rem', background: q.type === 'multi' ? '#eff6ff' : '#f1f5f9', padding: '2px 8px', borderRadius: '4px' }}>
                        {q.type === 'multi' ? 'å¤šé€‰' : 'å•é€‰'}
                      </span>
                    </p>
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.8rem' }}>
                      {q.options.map((opt, optIdx) => {
                        const isSelected = q.type === 'multi' 
                          ? (mcqAnswers[q.id] || []).includes(optIdx)
                          : mcqAnswers[q.id] === optIdx;
                        
                        return (
                          <label 
                            key={optIdx} 
                            style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '0.75rem', 
                              cursor: 'pointer',
                              padding: '0.75rem',
                              borderRadius: '8px',
                              background: isSelected ? '#eff6ff' : 'white',
                              border: isSelected ? '1px solid #3b82f6' : '1px solid #e2e8f0',
                              transition: 'all 0.2s'
                            }}
                          >
                            <input
                              type={q.type === 'multi' ? 'checkbox' : 'radio'}
                              name={`q-${q.id}`}
                              checked={isSelected}
                              onChange={() => {
                                if (q.type === 'multi') {
                                  handleMultiSelect(q.id, optIdx); 
                                } else {
                                  setMcqAnswers(prev => ({ ...prev, [q.id]: optIdx })); 
                                }
                              }}
                              style={{ width: '1.2rem', height: '1.2rem', accentColor: '#3b82f6', cursor: 'pointer' }}
                            />
                            <span style={{ color: isSelected ? '#1e40af' : '#475569', fontWeight: isSelected ? '500' : '400' }}>{opt}</span>
                          </label>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>

              <div style={{ marginBottom: '3rem' }}>
                <h3 style={{ fontSize: '1.4rem', fontWeight: '700', color: '#334155', marginBottom: '1.5rem' }}>äºŒã€æ¡ˆä¾‹åˆ†æï¼ˆç®€ç­”é¢˜ï¼‰ <span style={{fontSize:'0.9rem', color:'#ef4444', fontWeight:'normal'}}>*</span></h3>
                <div style={{ marginBottom: '1.5rem', background: '#f8fafc', padding: '2rem', borderRadius: '12px', textAlign: 'center', border: '1px dashed #cbd5e1' }}>
                   <img 
                     src="/case-study.png" 
                     alt="è¯·åœ¨publicç›®å½•ä¸‹æ”¾å…¥åä¸º case-study.png çš„å›¾ç‰‡ï¼Œç”¨äºæ¡ˆä¾‹åˆ†æ" 
                     style={{ 
                       maxWidth: '100%', 
                       width: '100%',
                       height: 'auto', 
                       borderRadius: '8px',
                       boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)' 
                     }} 
                   />
                   <p style={{ fontSize: '0.9rem', color: '#64748b', marginTop: '1rem' }}>ï¼ˆå›¾ï¼šéœ€åˆ†æçš„çœŸå®ç•Œé¢æ¡ˆä¾‹ï¼‰</p>
                </div>
                <p style={{ color: '#475569', marginBottom: '0.8rem', fontSize: '1rem', fontWeight: '500' }}>
                  è¯·ç»“åˆåˆšæ‰å­¦ä¹ çš„ç†è®ºï¼Œåˆ†æä¸Šå›¾ä¸­çš„ç•Œé¢è®¾è®¡ã€‚å®ƒè¿ç”¨äº†å“ªäº›å¯ä¾›æ€§åŸç†ï¼Ÿæ˜¯å¦å­˜åœ¨é—®é¢˜ï¼Ÿ(æœ€å°‘10å­—)
                </p>
                <textarea
                  value={shortAnswer}
                  onChange={(e) => setShortAnswer(e.target.value)}
                  style={{
                    ...styles.input,
                    width: '100%',
                    height: '10rem',
                    fontFamily: 'inherit',
                    resize: 'vertical',
                    borderColor: (shortAnswer.trim().length > 0 && shortAnswer.trim().length < 10) ? '#ef4444' : '#e2e8f0',
                    padding: '1rem'
                  }}
                  placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„åˆ†æ..."
                />
                <div style={{ textAlign: 'right', fontSize: '0.85rem', color: shortAnswer.trim().length >= 10 ? '#10b981' : '#ef4444', marginTop: '0.5rem' }}>
                  å­—æ•°: {shortAnswer.trim().length} / 10 (æœ€å°‘)
                </div>
              </div>

              <button
                onClick={() => {
                  if (canSubmit) {
                    let score = 0;
                    POSTTEST_MCQ_QUESTIONS.forEach(q => {
                        const userAnswer = mcqAnswers[q.id];
                        if (q.type === 'single') {
                            if (userAnswer === q.correct[0]) score++;
                        } else {
                            if (userAnswer && userAnswer.length === q.correct.length && userAnswer.every(val => q.correct.includes(val))) {
                                score++;
                            }
                        }
                    });
                    
                    const accuracy = ((score / POSTTEST_MCQ_QUESTIONS.length) * 100).toFixed(1) + '%';
                    const totalDuration = Math.floor((Date.now() - learningStartTime.current) / 1000);
                    
                    // å°†è¯¦ç»†çš„ç­”æ¡ˆï¼ˆdetailedAnswersï¼‰æ‰“åŒ…è¿› Payload å‘é€ç»™å®éªŒè€…
                    const performancePayload = {
                        mcqScore: score,
                        accuracy: accuracy, 
                        shortAnswer: shortAnswer,
                        totalDuration: totalDuration,
                        detailedAnswers: mcqAnswers, // å…³é”®ï¼šä¼ è¾“å…·ä½“é€‰é¡¹æ•°æ®
                        completionTimestamp: Date.now() // å…³é”®ï¼šä¼ è¾“å®Œæˆæ—¶é—´æˆ³
                    };

                    sendData(null, 'performance', performancePayload);
                    logBehavior('performance', { score, accuracy, totalDuration });

                    const pData = experimentData.current.participants.get(participantId);
                    if (pData) {
                      pData.posttest = {
                        mcq: mcqAnswers,
                        shortAnswer: shortAnswer,
                        timeOnTest: 180 - postTestTimeLeft,
                        score: score,
                        accuracy: accuracy,
                        completionTimestamp: Date.now() 
                      };
                    }
                    proceedToNextPhase();
                  }
                }}
                disabled={!canSubmit}
                style={{
                  ...styles.button,
                  background: canSubmit ? '#3b82f6' : '#cbd5e1',
                  cursor: canSubmit ? 'pointer' : 'not-allowed',
                  boxShadow: canSubmit ? '0 4px 6px rgba(59, 130, 246, 0.4)' : 'none',
                  opacity: canSubmit ? 1 : 0.8,
                  padding: '1rem 2rem',
                  fontSize: '1.1rem'
                }}
                onMouseOver={(e) => { if(canSubmit) e.target.style.background = styles.buttonHover.background; }}
                onMouseOut={(e) => { if(canSubmit) e.target.style.background = styles.button.background; }}
              >
                {!isAllAnswered ? `è¯·å®Œæˆæ‰€æœ‰é¢˜ç›®` : 
                 !isShortAnswerFilled ? `ç®€ç­”é¢˜å­—æ•°ä¸è¶³` :
                 !isTimeUp ? `è¯·å†æ€è€ƒ ${Math.floor(postTestTimeLeft / 60)}åˆ† ${postTestTimeLeft % 60}ç§’` : 
                 'æäº¤å¹¶ç»§ç»­ (è¿›å…¥NASA-TLX)'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'nasa') {
      return (
        <div style={styles.learningContainer}>
           <div style={styles.header}>
            <div style={styles.headerContent}>
              <div style={styles.headerInfo}>
                <div style={styles.infoItem}>
                  <Icon name="user" style={styles.infoIcon} />
                  <span>è¢«è¯•: {participantId}</span>
                </div>
                <div style={styles.infoItem}>
                  <Icon name="clock" style={styles.infoIcon} />
                  <span>
                    {Math.floor(sessionTime / 60)}:{(sessionTime % 60).toString().padStart(2, '0')}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div style={styles.consentContainer}>
            <div style={styles.consentBox}>
              <h2 style={styles.consentTitle}>ğŸ“Š NASA-TLXå·¥ä½œè´Ÿè·é‡è¡¨</h2>
              <p style={{ color: '#64748b', marginBottom: '2.5rem' }}>è¯·æ ¹æ®åˆšæ‰çš„å­¦ä¹ ä½“éªŒï¼Œæ‹–åŠ¨æ»‘å—è¯„ä»·æ‚¨åœ¨ä»¥ä¸‹å…­ä¸ªç»´åº¦ä¸Šçš„æ„Ÿå—ã€‚</p>
              
              <div style={{ display: 'flex', flexDirection: 'column', gap: '2rem', marginBottom: '3rem' }}>
                {NASA_DIMENSIONS.map((dimension) => (
                  <div key={dimension.key} style={{ padding: '1.5rem', background: '#f8fafc', borderRadius: '12px', border: '1px solid #e2e8f0' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.8rem' }}>
                       <h3 style={{ fontWeight: '700', color: '#334155', margin: 0, fontSize: '1.1rem' }}>{dimension.label}</h3>
                       <span style={{ fontWeight: '800', color: '#3b82f6', fontSize: '1.2rem', background: '#eff6ff', padding: '0.2rem 0.8rem', borderRadius: '8px' }}>{nasaTlx[dimension.key]}</span>
                    </div>
                    
                    <p style={{ fontSize: '0.9rem', color: '#64748b', marginBottom: '1.5rem' }}>{dimension.description}</p>
                    
                    <input
                      type="range"
                      min="0"
                      max="100"
                      step="5"
                      value={nasaTlx[dimension.key]}
                      onChange={(e) => setNasaTlx(prev => ({
                        ...prev,
                        [dimension.key]: parseInt(e.target.value)
                      }))}
                      style={{
                        width: '100%',
                        height: '6px',
                        background: '#e2e8f0',
                        borderRadius: '3px',
                        appearance: 'none',
                        cursor: 'pointer',
                        display: 'block',
                        margin: '0'
                      }}
                    />
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: '0.8rem', padding: '0 2px' }}>
                      <span style={{ fontSize: '0.8rem', color: '#94a3b8' }}>0 (éå¸¸ä½)</span>
                      <span style={{ fontSize: '0.8rem', color: '#94a3b8' }}>100 (éå¸¸é«˜)</span>
                    </div>
                  </div>
                ))}
              </div>
              
              <button
                onClick={() => {
                  if (nasaSubmitCountdown > 0) return;
                  const pData = experimentData.current.participants.get(participantId);
                  if (pData) pData.nasaTlx = nasaTlx;
                  
                  // ã€ä¿®æ”¹ç‚¹ï¼šåŒæ­¥NASA-TLXã€‘
                  sendData(null, 'nasa', nasaTlx);

                  if (role === 'learner') {
                      const totalSeconds = Math.floor((Date.now() - (sessionStartTime.current || Date.now())) / 1000);
                      setSessionTime(totalSeconds);
                  }
                  proceedToNextPhase();
                }}
                disabled={nasaSubmitCountdown > 0}
                style={{ 
                  ...styles.button, 
                  padding: '1rem 2rem', 
                  fontSize: '1.1rem',
                  background: nasaSubmitCountdown > 0 ? '#cbd5e1' : '#3b82f6',
                  cursor: nasaSubmitCountdown > 0 ? 'not-allowed' : 'pointer'
                }}
                onMouseOver={(e) => { if(nasaSubmitCountdown <= 0) e.target.style.background = styles.buttonHover.background; }}
                onMouseOut={(e) => { if(nasaSubmitCountdown <= 0) e.target.style.background = styles.button.background; }}
              >
                {nasaSubmitCountdown > 0 
                  ? `è¯·ä»”ç»†æ€è€ƒ... (${nasaSubmitCountdown}s)` 
                  : 'æäº¤å¹¶å®Œæˆå®éªŒ'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    if (experimentPhase === 'complete') {
      // ã€ä¿®æ”¹ç‚¹ã€‘: è¯»å–ä¿å­˜çš„æ—¶é—´æˆ³è¿›è¡Œæ ¼å¼åŒ–ï¼Œæ¯” new Date() æ›´ç¨³å®š
      const pData = experimentData.current.participants.get(participantId);
      const finishTimestamp = pData?.posttest?.completionTimestamp || Date.now();
      const finishDateStr = new Date(finishTimestamp).toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

      return (
        <div style={{ ...styles.consentContainer, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
          <div style={{ ...styles.consentBox, textAlign: 'center', padding: '4rem 3rem' }}>
            <div style={{ fontSize: '5rem', marginBottom: '1.5rem' }}>âœ…</div>
            <h2 style={{ fontSize: '2.5rem', fontWeight: '800', color: '#1e293b', marginBottom: '1rem' }}>å®éªŒå®Œæˆ</h2>
            <p style={{ color: '#64748b', marginBottom: '2rem', lineHeight: 1.6, fontSize: '1.1rem' }}>
              æ„Ÿè°¢æ‚¨å‚ä¸æœ¬æ¬¡è®¤çŸ¥è´Ÿè·ä¸ä»»åŠ¡ç»©æ•ˆç ”ç©¶å®éªŒã€‚<br/>æ‚¨çš„æ•°æ®å·²æˆåŠŸè®°å½•ï¼Œè¿™å°†æ”¯æ’‘æˆ‘å®Œæˆä¸€é¡¹ä¼Ÿå¤§çš„ç ”ç©¶ï¼
            </p>
            <div style={{ 
              background: '#f0fdf4', 
              border: '1px solid #bbf7d0', 
              borderRadius: '12px', 
              padding: '1.5rem',
              marginBottom: '2.5rem'
            }}>
              <p style={{ fontSize: '1rem', color: '#15803d', fontWeight: '600' }}>
                å®éªŒç¼–å·: {participantId} <span style={{ margin: '0 0.5rem', color: '#bbf7d0' }}>|</span> æ€»æ—¶é•¿: {Math.floor(sessionTime / 60)}åˆ† {sessionTime % 60}ç§’
              </p>
              {/* æ˜¾ç¤ºä¿®æ”¹åçš„å®Œæˆæ—¥æœŸ */}
              <p style={{ fontSize: '0.9rem', color: '#64748b', marginTop: '0.5rem' }}>
                å®Œæˆæ—¥æœŸ: {finishDateStr}
              </p>
            </div>
            <button
              onClick={() => {
                setRole(null);
                setParticipantId('');
                setExperimentPhase('consent');
                setSessionTime(0);
                setMcqAnswers({});
                setShortAnswer('');
                setNasaTlx({ mental: 50, physical: 50, temporal: 50, performance: 50, effort: 50, frustration: 50 });
              }}
              style={{
                ...styles.button,
                background: '#64748b',
                width: 'auto',
                padding: '0.85rem 2.5rem',
                fontSize: '1rem'
              }}
              onMouseOver={(e) => e.target.style.background = '#475569'}
              onMouseOut={(e) => e.target.style.background = '#64748b'}
            >
             è¿”å›ä¸»é¡µ
            </button>
          </div>
        </div>
      );
    }
  }

  return null;
};

export default CognitiveLoadPlatform;